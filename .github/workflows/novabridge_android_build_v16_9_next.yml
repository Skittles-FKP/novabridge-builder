name: NovaBridge Android Cloud Build v16.9 NEXT

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - novabridge_android_build_v16_9_next

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_PUBLIC_BASE: ${{ secrets.R2_PUBLIC_BASE }}

      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üß™ Print incoming payload
        shell: bash
        run: |
          set -e
          echo "BUILD_ID=${BUILD_ID}"
          echo "ZIP_URL=${ZIP_URL}"
          echo "CALLBACK_URL=${CALLBACK_URL}"

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: üß∞ Setup Gradle (for wrapper repair)
        uses: gradle/actions/setup-gradle@v4

      - name: üì• Download ZIP
        shell: bash
        run: |
          set -e
          mkdir -p work
          curl -L --fail --retry 3 --retry-delay 2 "${ZIP_URL}" -o work/project.zip
          ls -lh work/project.zip

      - name: üì¶ Extract ZIP + detect project root
        shell: bash
        run: |
          set -e
          rm -rf work/extracted
          mkdir -p work/extracted
          unzip -q work/project.zip -d work/extracted

          ANDROID_ROOT="$(python3 - <<'PY'
import os
candidates=[]
for root, dirs, files in os.walk("work/extracted"):
    if "settings.gradle" in files or "settings.gradle.kts" in files:
        candidates.append(root)
candidates=sorted(candidates, key=lambda p: len(p.split("/")))
print(candidates[0] if candidates else "")
PY
)"
          if [ -z "${ANDROID_ROOT}" ]; then
            echo "‚ùå Could not find Android project root (settings.gradle not found)."
            exit 1
          fi
          echo "ANDROID_ROOT=${ANDROID_ROOT}" | tee -a "$GITHUB_ENV"
          echo "‚úÖ ANDROID_ROOT=${ANDROID_ROOT}"
          ls -la "${ANDROID_ROOT}" | head -n 80

      - name: üîß Ensure gradlew executable
        shell: bash
        run: |
          set -e
          cd "${ANDROID_ROOT}"
          chmod +x ./gradlew
          echo "‚úÖ gradlew ready"

      - name: üßØ Repair Gradle wrapper if jar missing
        shell: bash
        run: |
          set -e
          cd "${ANDROID_ROOT}"

          if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "‚úÖ gradle-wrapper.jar present"
          else
            echo "‚ùå gradle-wrapper.jar missing ‚Äî generating wrapper using system Gradle..."
            gradle wrapper --gradle-version 8.7 --distribution-type all
          fi

          test -f "gradle/wrapper/gradle-wrapper.jar"
          chmod +x ./gradlew
          echo "‚úÖ Wrapper OK"

      - name: üß© Fix missing ic_launcher_foreground (AAPT)
        shell: bash
        run: |
          set -e
          cd "${ANDROID_ROOT}"

          for f in app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml; do
            if [ -f "$f" ]; then
              sed -i 's/@mipmap\/ic_launcher_foreground/@mipmap\/ic_launcher/g' "$f" || true
              echo "‚úÖ Patched $f"
            fi
          done

      - name: üîê Ensure valid debug keystore
        shell: bash
        run: |
          set -e
          cd "${ANDROID_ROOT}"
          mkdir -p app
          KEYSTORE="app/debug.keystore"
          rm -f "${KEYSTORE}" || true

          keytool -genkeypair -v \
            -keystore "${KEYSTORE}" \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          echo "‚úÖ debug.keystore created"

      - name: üèóÔ∏è Build APK (Release ‚Üí Debug fallback)
        shell: bash
        run: |
          set -e
          cd "${ANDROID_ROOT}"

          if ./gradlew --no-daemon assembleRelease; then
            echo "‚úÖ Release APK built"
          else
            echo "‚ö†Ô∏è Release failed, trying Debug..."
            ./gradlew --no-daemon assembleDebug
            echo "‚úÖ Debug APK built"
          fi

      - name: üîé Locate APK
        shell: bash
        run: |
          set -e
          cd "${ANDROID_ROOT}"

          APK_PATH="$(ls -1 app/build/outputs/apk/release/*.apk 2>/dev/null | head -n 1 || true)"
          if [ -z "${APK_PATH}" ]; then
            APK_PATH="$(ls -1 app/build/outputs/apk/debug/*.apk 2>/dev/null | head -n 1 || true)"
          fi

          if [ -z "${APK_PATH}" ]; then
            echo "‚ùå Could not locate APK"
            find app/build/outputs -maxdepth 6 -type f | head -n 200
            exit 1
          fi

          echo "APK_PATH=${APK_PATH}" | tee -a "$GITHUB_ENV"
          ls -lh "${APK_PATH}"
          echo "‚úÖ APK located"

      - name: ‚òÅÔ∏è Upload APK to R2 (AWS CLI)
        shell: bash
        run: |
          set -e
          if [ -z "${R2_PUBLIC_BASE}" ]; then
            echo "‚ùå Missing secret R2_PUBLIC_BASE"
            exit 1
          fi

          KEY="artifact-android-next/${BUILD_ID}.apk"
          ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"

          export AWS_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}"
          export AWS_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}"
          export AWS_DEFAULT_REGION="auto"

          aws s3 cp "${APK_PATH}" "s3://${R2_BUCKET}/${KEY}" \
            --endpoint-url "${ENDPOINT}" \
            --content-type "application/vnd.android.package-archive"

          ARTIFACT_URL="${R2_PUBLIC_BASE%/}/${KEY}"
          echo "ARTIFACT_URL=${ARTIFACT_URL}" | tee -a "$GITHUB_ENV"
          echo "‚úÖ Uploaded: ${ARTIFACT_URL}"

      - name: üì° Callback Worker (mark complete)
        shell: bash
        run: |
          set -e
          curl -L --fail -X POST \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${CALLBACK_TOKEN}" \
            -d "{\"build_id\":\"${BUILD_ID}\",\"status\":\"success\",\"artifact_url\":\"${ARTIFACT_URL}\",\"step\":\"complete\",\"step_label\":\"Complete\"}" \
            "${CALLBACK_URL}"
          echo "‚úÖ Callback sent"
