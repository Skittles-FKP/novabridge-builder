name: NovaBridge Android Cloud Build v16.9 NEXT

on:
  workflow_dispatch:
  repository_dispatch:
    types: [novabridge_android_build_v16_9_next]

jobs:
  android-build-next:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}

      ANDROID_USER_HOME: ${{ github.workspace }}/.android
      ANDROID_SDK_HOME: ${{ github.workspace }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üß± Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.2.1"

      # --------------------------------------------------
      # Download & extract ZIP
      # --------------------------------------------------
      - name: üì• Download & extract ZIP
        run: |
          set -e
          curl -fL "$ZIP_URL" -o native.zip
          unzip -q native.zip -d build

      # --------------------------------------------------
      # üîê Create a VALID debug keystore AND place it where the template expects
      # Template expects: build/app/debug.keystore
      # --------------------------------------------------
      - name: üîê Provide debug.keystore for template signingConfig
        run: |
          set -e
          mkdir -p "$ANDROID_USER_HOME"
          mkdir -p "build/app"

          # Always (re)create a clean keystore in ANDROID_USER_HOME
          rm -f "$ANDROID_USER_HOME/debug.keystore" || true
          keytool -genkeypair \
            -keystore "$ANDROID_USER_HOME/debug.keystore" \
            -storepass android \
            -keypass android \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          # Copy to the exact path Gradle is demanding
          rm -f "build/app/debug.keystore" || true
          cp "$ANDROID_USER_HOME/debug.keystore" "build/app/debug.keystore"

          echo "‚úÖ debug.keystore installed at build/app/debug.keystore"
          keytool -list -keystore "build/app/debug.keystore" -storepass android | head -n 40

      # --------------------------------------------------
      # Install Pillow (icons)
      # --------------------------------------------------
      - name: üêç Install Python deps
        run: |
          set -e
          python3 -m pip install --upgrade pip
          python3 -m pip install pillow

      # --------------------------------------------------
      # Generate valid launcher icons (AAPT-safe)
      # --------------------------------------------------
      - name: üé® Generate launcher icons
        run: |
          set -e
          python3 - <<'PY'
          import os
          from PIL import Image

          res = "build/app/src/main/res"
          dirs = ["mipmap-mdpi","mipmap-hdpi","mipmap-xhdpi","mipmap-xxhdpi","mipmap-xxxhdpi"]
          img = Image.new("RGBA", (48,48), (63,81,181,255))

          for d in dirs:
            p = os.path.join(res, d)
            os.makedirs(p, exist_ok=True)
            img.save(os.path.join(p, "ic_launcher.png"))
            img.save(os.path.join(p, "ic_launcher_round.png"))
            img.save(os.path.join(p, "ic_launcher_foreground.png"))
          PY

      # --------------------------------------------------
      # Build APK (NO WRAPPER REQUIRED)
      # --------------------------------------------------
      - name: üèó Build APK
        working-directory: build
        run: |
          set -e
          gradle assembleRelease || gradle assembleDebug

      # --------------------------------------------------
      # Locate APK
      # --------------------------------------------------
      - name: üîç Locate APK
        id: find_apk
        working-directory: build
        run: |
          set -e
          APK=$(find app/build/outputs/apk -type f -name "*.apk" | head -n 1)
          test -f "$APK"
          echo "apk_path=$APK" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # Upload APK to R2
      # --------------------------------------------------
      - name: ‚òÅÔ∏è Upload APK to R2
        run: |
          set -e
          APK="build/${{ steps.find_apk.outputs.apk_path }}"
          AWS_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}" \
          AWS_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}" \
          aws s3 cp "$APK" "s3://${R2_BUCKET}/apks/${BUILD_ID}.apk" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --region auto

      # --------------------------------------------------
      # Callback
      # --------------------------------------------------
      - name: ‚úÖ Notify Worker
        if: success() && env.CALLBACK_URL != ''
        run: |
          set -e
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifact_url\":\"https://novabridge-build-worker-next.novabridge.workers.dev/apk/$BUILD_ID\"}"
