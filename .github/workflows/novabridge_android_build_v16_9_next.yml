name: NovaBridge Android Cloud Build v17 NEXT

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - novabridge_android_build_v17_next

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      ANDROID_ROOT: work/extracted
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

    steps:
      # ------------------------------------------------------------
      # 1ï¸âƒ£ Checkout
      # ------------------------------------------------------------
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2ï¸âƒ£ Validate incoming payload (debug safety)
      # ------------------------------------------------------------
      - name: ðŸ” Validate dispatch payload
        run: |
          set -e
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          if [ -z "$ZIP_URL" ]; then
            echo "âŒ ZIP_URL missing"
            exit 1
          fi

      # ------------------------------------------------------------
      # 3ï¸âƒ£ Setup Java
      # ------------------------------------------------------------
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ------------------------------------------------------------
      # 4ï¸âƒ£ Download ZIP from Worker
      # ------------------------------------------------------------
      - name: ðŸ“¥ Download Android project ZIP
        run: |
          set -e
          mkdir -p work
          curl -L "$ZIP_URL" -o work/project.zip
          unzip -q work/project.zip -d work/extracted
          echo "âœ… ZIP extracted"

      # ------------------------------------------------------------
      # 5ï¸âƒ£ Ensure Gradle Wrapper (NON-NEGOTIABLE)
      # ------------------------------------------------------------
      - name: ðŸ§± Ensure Gradle wrapper
        run: |
          set -e
          cd "$ANDROID_ROOT"

          if [ ! -f gradlew ]; then
            echo "âŒ gradlew missing"
            exit 1
          fi

          chmod +x gradlew

          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "â¬‡ï¸ Downloading gradle-wrapper.jar"
            mkdir -p gradle/wrapper
            curl -L https://services.gradle.org/distributions/gradle-8.6-bin.zip -o /tmp/gradle.zip
            unzip -q /tmp/gradle.zip -d /tmp
            cp /tmp/gradle-8.6/lib/gradle-wrapper.jar gradle/wrapper/
          fi

          echo "âœ… Gradle wrapper ready"

      # ------------------------------------------------------------
      # 6ï¸âƒ£ FIX ANDROID ADAPTIVE ICONS (ROOT CAUSE FIX)
      # ------------------------------------------------------------
      - name: ðŸŽ¨ Fix adaptive launcher icons (NEXT)
        shell: bash
        run: |
          set -e
          cd "$ANDROID_ROOT"

          RES="app/src/main/res"

          mkdir -p "$RES/drawable"
          mkdir -p "$RES/values"
          mkdir -p "$RES/mipmap-anydpi-v26"

          # Background color
          cat > "$RES/values/ic_launcher_background.xml" <<'EOF'
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="ic_launcher_background">#121212</color>
</resources>
EOF

          # Foreground drawable
          cat > "$RES/drawable/ic_launcher_foreground.xml" <<'EOF'
<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <group android:scaleX="0.8"
           android:scaleY="0.8"
           android:translateX="10.8"
           android:translateY="10.8">
        <path
            android:fillColor="#FFFFFF"
            android:pathData="M54,0L108,54L54,108L0,54Z"/>
    </group>
</vector>
EOF

          # Adaptive icons
          for ICON in ic_launcher ic_launcher_round; do
            cat > "$RES/mipmap-anydpi-v26/${ICON}.xml" <<'EOF'
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_background"/>
    <foreground android:drawable="@drawable/ic_launcher_foreground"/>
</adaptive-icon>
EOF
          done

          echo "âœ… Adaptive icons fixed"

      # ------------------------------------------------------------
      # 7ï¸âƒ£ Build APK (Debug â†’ Release fallback)
      # ------------------------------------------------------------
      - name: ðŸ—ï¸ Build APK
        run: |
          set -e
          cd "$ANDROID_ROOT"

          ./gradlew assembleDebug || ./gradlew assembleRelease

      # ------------------------------------------------------------
      # 8ï¸âƒ£ Locate APK
      # ------------------------------------------------------------
      - name: ðŸ”Ž Locate APK
        run: |
          set -e
          cd "$ANDROID_ROOT"

          APK=$(find app/build/outputs -name "*.apk" | head -n 1)
          if [ -z "$APK" ]; then
            echo "âŒ APK not found"
            exit 1
          fi

          echo "APK_PATH=$APK" >> $GITHUB_ENV
          echo "âœ… APK found at $APK"

      # ------------------------------------------------------------
      # 9ï¸âƒ£ Upload APK to R2
      # ------------------------------------------------------------
      - name: â˜ï¸ Upload APK to R2
        run: |
          set -e
          FILE="novabridge-${BUILD_ID}.apk"
          aws s3 cp "$APK_PATH" "s3://${{ secrets.R2_BUCKET }}/android/${FILE}" \
            --endpoint-url "https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
            --region auto \
            --no-progress

          echo "ARTIFACT_URL=https://${{ secrets.R2_PUBLIC_HOST }}/android/${FILE}" >> $GITHUB_ENV
          echo "âœ… APK uploaded"

      # ------------------------------------------------------------
      # ðŸ”Ÿ Callback Worker (FINAL STATE FLIP)
      # ------------------------------------------------------------
      - name: ðŸ“¡ Callback Worker
        run: |
          set -e
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"build_id\": \"$BUILD_ID\",
              \"status\": \"success\",
              \"artifact_url\": \"$ARTIFACT_URL\"
            }"

          echo "ðŸŽ‰ Worker callback complete"
