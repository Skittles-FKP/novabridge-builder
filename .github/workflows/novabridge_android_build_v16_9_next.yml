name: NovaBridge Android Cloud Build ‚Äî v16.9.8 NEXT

on:
  # Manual trigger (optional, useful for testing)
  workflow_dispatch:

  # Triggered ONLY by NEXT worker
  repository_dispatch:
    types:
      - novabridge_android_build_v16_9_next

jobs:
  android-build-next:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

    steps:
      # ------------------------------------------------------------
      # Debug incoming payload (KEEP)
      # ------------------------------------------------------------
      - name: üß™ Print incoming payload (NEXT)
        run: |
          echo "EVENT TYPE: ${{ github.event.action }}"
          echo "BUILD_ID=${BUILD_ID}"
          echo "ZIP_URL=${ZIP_URL}"
          echo "CALLBACK_URL=${CALLBACK_URL}"
          echo "FULL PAYLOAD:"
          echo '${{ toJson(github.event.client_payload) }}'

      # ------------------------------------------------------------
      # Checkout repo (required for Actions runtime)
      # ------------------------------------------------------------
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Setup Java 17 (Android requirement)
      # ------------------------------------------------------------
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # ------------------------------------------------------------
      # Download Android ZIP from NEXT worker
      # ------------------------------------------------------------
      - name: üì• Download Android project ZIP (NEXT)
        run: |
          echo "Downloading ZIP from NEXT worker..."
          curl -L "${ZIP_URL}" -o android.zip
          unzip android.zip -d work
          ls -la work

      # ------------------------------------------------------------
      # üß∞ BOOTSTRAP GRADLE WRAPPER (CRITICAL FIX)
      # ------------------------------------------------------------
      - name: üß∞ Bootstrap Gradle Wrapper
        working-directory: work/android-project
        run: |
          echo "Bootstrapping Gradle wrapper..."
          mkdir -p gradle/wrapper

          curl -L https://services.gradle.org/distributions/gradle-8.2.2-bin.zip -o gradle.zip
          unzip -q gradle.zip

          cp gradle-8.2.2/lib/gradle-wrapper.jar gradle/wrapper/

          echo "distributionUrl=https\\://services.gradle.org/distributions/gradle-8.2.2-bin.zip" \
            > gradle/wrapper/gradle-wrapper.properties

          ls -la gradle/wrapper

      # ------------------------------------------------------------
      # Build APK (Release ‚Üí Debug fallback)
      # ------------------------------------------------------------
      - name: üèóÔ∏è Build Android APK (NEXT)
        working-directory: work/android-project
        run: |
          chmod +x gradlew || true

          echo "Attempting RELEASE build..."
          ./gradlew assembleRelease || (
            echo "Release failed, falling back to DEBUG"
            ./gradlew assembleDebug
          )

      # ------------------------------------------------------------
      # Locate APK
      # ------------------------------------------------------------
      - name: üîç Locate APK
        run: |
          APK_PATH=$(find work -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "‚ùå No APK found"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "Found APK at $APK_PATH"

      # ------------------------------------------------------------
      # Upload APK as GitHub artifact
      # ------------------------------------------------------------
      - name: üì¶ Upload APK Artifact (NEXT)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-next-${{ env.BUILD_ID }}
          path: ${{ env.APK_PATH }}

      # ------------------------------------------------------------
      # Callback to NEXT Worker (mark build complete)
      # ------------------------------------------------------------
      - name: üîÅ Callback Worker (NEXT)
        if: ${{ env.CALLBACK_URL != '' }}
        run: |
          curl -X POST "${CALLBACK_URL}" \
            -H "Content-Type: application/json" \
            -d "{
              \"build_id\": \"${BUILD_ID}\",
              \"status\": \"success\",
              \"apk_path\": \"${APK_PATH}\",
              \"artifact_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }"

      # ------------------------------------------------------------
      # Final log
      # ------------------------------------------------------------
      - name: ‚úÖ Build Complete (NEXT)
        run: echo "Android NEXT build completed successfully."
