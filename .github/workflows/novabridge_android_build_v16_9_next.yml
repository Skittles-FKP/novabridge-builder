name: NovaBridge Android NEXT Cloud Build v17

on:
  workflow_dispatch:
  repository_dispatch:
    types: [novabridge_android_build_v17_next]

jobs:
  android-next-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

      # R2
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}

      # Worker callback auth (must match what Worker expects)
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

      # Gradle
      GRADLE_VERSION: "8.7"

    steps:
      - name: ðŸ§© Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ§ª Print incoming payload
        shell: bash
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: ðŸ“¥ Download ZIP
        shell: bash
        run: |
          set -e
          mkdir -p work
          cd work
          echo "Downloading ZIP..."
          curl -L --fail "$ZIP_URL" -o app.zip
          echo "ZIP size:"
          ls -lah app.zip

      - name: ðŸ“¦ Extract ZIP
        shell: bash
        run: |
          set -e
          cd work
          unzip -q app.zip -d extracted
          echo "Extracted top-level:"
          ls -la extracted

      - name: ðŸ”Ž Locate Android project root
        id: locate
        shell: bash
        run: |
          set -e
          cd work/extracted

          # Try common roots first
          if [ -f "gradlew" ] && [ -d "app" ]; then
            echo "ANDROID_ROOT=$PWD" >> $GITHUB_ENV
            exit 0
          fi

          # Otherwise find a gradlew
          ROOT="$(find . -maxdepth 5 -name gradlew -type f | head -n 1 | xargs -I{} dirname {})"
          if [ -z "$ROOT" ]; then
            echo "âŒ Could not find gradlew in extracted ZIP."
            find . -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          ROOT="$(cd "$ROOT" && pwd)"
          echo "Found ANDROID_ROOT=$ROOT"
          echo "ANDROID_ROOT=$ROOT" >> $GITHUB_ENV

      - name: âœ… Ensure gradlew executable
        shell: bash
        run: |
          set -e
          cd "$ANDROID_ROOT"
          chmod +x ./gradlew
          echo "âœ… gradlew present and executable"

      - name: ðŸ§° Ensure Gradle wrapper jar exists (generate if missing)
        shell: bash
        run: |
          set -e
          cd "$ANDROID_ROOT"

          WRAPPER_JAR="gradle/wrapper/gradle-wrapper.jar"
          if [ -f "$WRAPPER_JAR" ]; then
            echo "âœ… gradle-wrapper.jar present"
            exit 0
          fi

          echo "âš ï¸ gradle-wrapper.jar missing â€” generating wrapper using Gradle ${GRADLE_VERSION}"

          cd /tmp
          curl -L --fail "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip" -o gradle.zip
          unzip -q gradle.zip
          export GRADLE_BIN="/tmp/gradle-${GRADLE_VERSION}/bin/gradle"

          cd "$ANDROID_ROOT"
          "$GRADLE_BIN" wrapper --gradle-version "$GRADLE_VERSION"

          if [ ! -f "$WRAPPER_JAR" ]; then
            echo "âŒ Still missing gradle-wrapper.jar after generation."
            ls -la gradle/wrapper || true
            exit 1
          fi

          echo "âœ… Wrapper generated"

      - name: ðŸ” Ensure debug.keystore exists
        shell: bash
        run: |
          set -e
          cd "$ANDROID_ROOT"

          # common debug keystore location some templates use
          KEYSTORE_PATH="app/debug.keystore"
          if [ -f "$KEYSTORE_PATH" ]; then
            echo "âœ… debug.keystore exists"
            exit 0
          fi

          echo "Generating debug.keystore..."
          keytool -genkeypair \
            -keystore "$KEYSTORE_PATH" \
            -storepass android \
            -keypass android \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          test -f "$KEYSTORE_PATH"
          echo "âœ… debug.keystore generated at $KEYSTORE_PATH"

      - name: ðŸ§© Patch deps for NEXT plugins (Biometric + Location) if plugin sources exist
        shell: bash
        run: |
          set -e
          cd "$ANDROID_ROOT"

          PLUGINS_DIR="app/src/main/java"
          HAS_LOCATION="$(grep -R --line-number "com.google.android.gms.location" "$PLUGINS_DIR" 2>/dev/null | head -n 1 || true)"
          HAS_BIOMETRIC="$(grep -R --line-number "androidx.biometric" "$PLUGINS_DIR" 2>/dev/null | head -n 1 || true)"

          if [ -z "$HAS_LOCATION" ] && [ -z "$HAS_BIOMETRIC" ]; then
            echo "No Location/Biometric imports found â€” skipping dependency patch."
            exit 0
          fi

          APP_GRADLE="app/build.gradle"
          if [ ! -f "$APP_GRADLE" ]; then
            echo "âŒ app/build.gradle not found at $ANDROID_ROOT/app/build.gradle"
            ls -la app || true
            exit 1
          fi

          echo "Patching $APP_GRADLE for plugin deps..."

          # Ensure dependencies block exists; then append implementations if not present
          if ! grep -q "dependencies" "$APP_GRADLE"; then
            echo "âŒ No dependencies block found in app/build.gradle"
            exit 1
          fi

          if [ -n "$HAS_LOCATION" ] && ! grep -q "play-services-location" "$APP_GRADLE"; then
            sed -i '/dependencies\s*{/a\    implementation "com.google.android.gms:play-services-location:21.3.0"' "$APP_GRADLE"
            echo "âœ… Added play-services-location"
          fi

          if [ -n "$HAS_BIOMETRIC" ] && ! grep -q "androidx.biometric:biometric" "$APP_GRADLE"; then
            sed -i '/dependencies\s*{/a\    implementation "androidx.biometric:biometric:1.1.0"' "$APP_GRADLE"
            echo "âœ… Added androidx.biometric"
          fi

      - name: ðŸ—ï¸ Build APK (Release â†’ Debug fallback)
        shell: bash
        run: |
          set -e
          cd "$ANDROID_ROOT"

          echo "Running assembleRelease..."
          if ./gradlew --no-daemon assembleRelease; then
            echo "âœ… Release build ok"
          else
            echo "âš ï¸ Release failed â€” falling back to Debug"
            ./gradlew --no-daemon assembleDebug
          fi

      - name: ðŸ”Ž Locate APK
        shell: bash
        run: |
          set -e
          cd "$ANDROID_ROOT"

          APK_PATH="$(find . -type f \( -name "*release*.apk" -o -name "*debug*.apk" \) | head -n 1)"
          if [ -z "$APK_PATH" ]; then
            echo "âŒ No APK found."
            find . -maxdepth 5 -type f | grep -i "\.apk" || true
            exit 1
          fi

          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "âœ… Found APK at $APK_PATH"

      - name: â˜ï¸ Upload APK to R2
        shell: bash
        run: |
          set -e

          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
          export AWS_DEFAULT_REGION="auto"

          DEST_KEY="artifacts/android-next/${BUILD_ID}/app.apk"
          ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"

          echo "Uploading to s3://${R2_BUCKET}/${DEST_KEY}"
          aws s3 cp "$ANDROID_ROOT/$APK_PATH" "s3://${R2_BUCKET}/${DEST_KEY}" --endpoint-url "$ENDPOINT"

          echo "R2_KEY=$DEST_KEY" >> $GITHUB_ENV
          echo "âœ… Upload complete"

      - name: ðŸ“¡ Callback to Worker (success)
        shell: bash
        run: |
          set -e

          # Your Worker should map this key to a public download URL (or return direct R2 URL if you do that)
          ARTIFACT_HINT="${R2_KEY}"

          echo "Calling callback..."
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifact_key\":\"$ARTIFACT_HINT\"}"

          echo "âœ… Callback sent"
