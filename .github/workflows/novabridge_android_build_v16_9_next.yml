name: NovaBridge Android Cloud Build v17 NEXT

on:
  workflow_dispatch:
  repository_dispatch:
    types: [novabridge_android_build_v17_next]

jobs:
  android-build-v17-next:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}

      ANDROID_USER_HOME: ${{ github.workspace }}/.android
      ANDROID_SDK_HOME: ${{ github.workspace }}

      # Optional release signing (AAB/APK) ‚Äî set these secrets to enable
      ANDROID_RELEASE_KEYSTORE_BASE64: ${{ secrets.ANDROID_RELEASE_KEYSTORE_BASE64 }}
      ANDROID_RELEASE_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_RELEASE_KEYSTORE_PASSWORD }}
      ANDROID_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}
      ANDROID_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ‚úÖ System Gradle (NO wrapper dependency)
      - name: üß± Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.2.1"

      - name: üì• Download & extract ZIP
        run: |
          set -e
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

          curl -fL "$ZIP_URL" -o native.zip
          unzip -q native.zip -d build

          echo "Extracted build structure:"
          find build -maxdepth 3 -type d

      # üîê Debug keystore for debug signing AND to satisfy templates that reference build/app/debug.keystore
      - name: üîê Install debug.keystore (all required paths)
        run: |
          set -e

          mkdir -p "$ANDROID_USER_HOME"
          mkdir -p build/app
          mkdir -p build/build/app

          rm -f "$ANDROID_USER_HOME/debug.keystore" || true

          keytool -genkeypair \
            -keystore "$ANDROID_USER_HOME/debug.keystore" \
            -storepass android \
            -keypass android \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          cp "$ANDROID_USER_HOME/debug.keystore" build/app/debug.keystore
          cp "$ANDROID_USER_HOME/debug.keystore" build/build/app/debug.keystore

          echo "Installed debug.keystore at:"
          ls -l build/app/debug.keystore
          ls -l build/build/app/debug.keystore

          keytool -list -keystore build/app/debug.keystore -storepass android | head -n 20

      # Pillow for icon generation (replaces missing ImageMagick 'convert')
      - name: üêç Install Python deps
        run: |
          set -e
          python3 -m pip install --upgrade pip
          python3 -m pip install pillow

      # AAPT-safe launcher icons (fixes ‚Äúfile failed to compile‚Äù and missing ic_launcher_foreground)
      - name: üé® Generate launcher icons
        run: |
          set -e
          python3 - <<'PY'
          import os
          from PIL import Image

          res = "build/app/src/main/res"
          mipmaps = ["mipmap-mdpi","mipmap-hdpi","mipmap-xhdpi","mipmap-xxhdpi","mipmap-xxxhdpi"]

          # Simple solid PNG ‚Äî always AAPT safe
          img = Image.new("RGBA", (48, 48), (63, 81, 181, 255))

          for m in mipmaps:
            d = os.path.join(res, m)
            os.makedirs(d, exist_ok=True)
            img.save(os.path.join(d, "ic_launcher.png"))
            img.save(os.path.join(d, "ic_launcher_round.png"))
            img.save(os.path.join(d, "ic_launcher_foreground.png"))

          print("Launcher icons generated successfully.")
          PY

      # ‚úÖ Fix plugin compile errors by injecting deps when plugin sources exist
      - name: üß© Ensure plugin dependencies (Biometric / Location / Play Services)
        run: |
          set -e
          APP_GRADLE="build/app/build.gradle"

          if [ ! -f "$APP_GRADLE" ]; then
            echo "No build/app/build.gradle found ‚Äî skipping dep injection"
            exit 0
          fi

          NEED_BIOMETRIC="false"
          NEED_LOCATION="false"

          if [ -f "build/app/src/main/java" ]; then
            if find build/app/src/main/java -name "BiometricPlugin.java" | grep -q .; then NEED_BIOMETRIC="true"; fi
            if find build/app/src/main/java -name "LocationPlugin.java" | grep -q .; then NEED_LOCATION="true"; fi
          fi

          echo "NEED_BIOMETRIC=$NEED_BIOMETRIC"
          echo "NEED_LOCATION=$NEED_LOCATION"

          python3 - <<'PY'
          import os, re

          app_gradle = "build/app/build.gradle"
          with open(app_gradle, "r", encoding="utf-8") as f:
            s = f.read()

          need_bio = os.environ.get("NEED_BIOMETRIC") == "true"
          need_loc = os.environ.get("NEED_LOCATION") == "true"

          deps_to_add = []
          if need_bio and "androidx.biometric:biometric" not in s:
            deps_to_add.append('    implementation "androidx.biometric:biometric:1.1.0"')
          if need_loc and "com.google.android.gms:play-services-location" not in s:
            deps_to_add.append('    implementation "com.google.android.gms:play-services-location:21.0.1"')

          if not deps_to_add:
            print("No dependency changes required.")
            raise SystemExit(0)

          m = re.search(r"dependencies\s*\{", s)
          if not m:
            raise SystemExit("No dependencies { } block found in app/build.gradle")

          insert_pos = m.end()
          s2 = s[:insert_pos] + "\n" + "\n".join(deps_to_add) + s[insert_pos:]

          # Ensure Google Maven repo exists (usually already does)
          if "google()" not in s2:
            s2 = s2.replace("repositories {", "repositories {\n        google()")

          with open(app_gradle, "w", encoding="utf-8") as f:
            f.write(s2)

          print("Injected deps:\n" + "\n".join(deps_to_add))
          PY

      # Optional Release Signing (APK/AAB) ‚Äî enabled only if secrets provided
      - name: üîê Configure Release Signing (optional)
        run: |
          set -e
          if [ -z "${ANDROID_RELEASE_KEYSTORE_BASE64}" ]; then
            echo "Release signing secrets not set ‚Äî skipping."
            exit 0
          fi

          echo "Release signing enabled."

          mkdir -p build/keystore
          echo "$ANDROID_RELEASE_KEYSTORE_BASE64" | base64 -d > build/keystore/release.jks

          # Patch app/build.gradle to use signingConfig if not already present
          python3 - <<'PY'
          import re

          path = "build/app/build.gradle"
          s = open(path, "r", encoding="utf-8").read()

          if "signingConfigs" not in s:
            # Insert signingConfigs inside android { ... }
            s = re.sub(
              r"(android\s*\{)",
              r"""\1

    signingConfigs {
        release {
            storeFile file("../keystore/release.jks")
            storePassword System.getenv("ANDROID_RELEASE_KEYSTORE_PASSWORD")
            keyAlias System.getenv("ANDROID_RELEASE_KEY_ALIAS")
            keyPassword System.getenv("ANDROID_RELEASE_KEY_PASSWORD")
        }
    }
""",
              s,
              count=1
            )

          # Ensure buildTypes.release uses signingConfig
          if re.search(r"buildTypes\s*\{", s) and "signingConfig signingConfigs.release" not in s:
            # Add under release { ... }
            s = re.sub(
              r"(release\s*\{)",
              r"""\1
            signingConfig signingConfigs.release
""",
              s,
              count=1
            )

          open(path, "w", encoding="utf-8").write(s)
          print("Release signing configured in app/build.gradle")
          PY

      # Build APK + AAB using system Gradle (no wrapper)
      - name: üèó Build APK + AAB
        working-directory: build
        run: |
          set -e
          gradle --version
          # Release first; fallback to Debug if needed
          gradle assembleRelease bundleRelease || (gradle assembleDebug bundleDebug)

      - name: üîç Locate APK + AAB
        id: find_artifacts
        working-directory: build
        run: |
          set -e

          APK=$(find app/build/outputs/apk -type f -name "*.apk" | head -n 1 || true)
          AAB=$(find app/build/outputs/bundle -type f -name "*.aab" | head -n 1 || true)

          if [ -z "$APK" ]; then
            echo "‚ùå APK not found"
            find app/build/outputs -type f
            exit 1
          fi

          echo "apk_path=$APK" >> $GITHUB_OUTPUT
          echo "aab_path=$AAB" >> $GITHUB_OUTPUT

          echo "Found APK: $APK"
          if [ -n "$AAB" ]; then
            echo "Found AAB: $AAB"
          else
            echo "AAB not found (may be debug-only build fallback)."
          fi

      - name: ‚òÅÔ∏è Upload APK (+AAB) to R2
        run: |
          set -e

          APK="build/${{ steps.find_artifacts.outputs.apk_path }}"
          echo "Uploading APK: $APK"

          AWS_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}" \
          AWS_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}" \
          aws s3 cp "$APK" "s3://${R2_BUCKET}/apks/${BUILD_ID}.apk" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --region auto

          if [ -n "${{ steps.find_artifacts.outputs.aab_path }}" ]; then
            AAB="build/${{ steps.find_artifacts.outputs.aab_path }}"
            if [ -f "$AAB" ]; then
              echo "Uploading AAB: $AAB"
              AWS_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}" \
              AWS_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}" \
              aws s3 cp "$AAB" "s3://${R2_BUCKET}/aabs/${BUILD_ID}.aab" \
                --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
                --region auto
            fi
          fi

          echo "Artifacts uploaded to R2"

      - name: ‚úÖ Notify Worker
        if: success() && env.CALLBACK_URL != ''
        run: |
          set -e

          APK_URL="https://novabridge-build-worker-next.novabridge.workers.dev/apk/$BUILD_ID"
          AAB_URL="https://novabridge-build-worker-next.novabridge.workers.dev/aab/$BUILD_ID"

          # Only include AAB URL if we actually built it
          if [ -n "${{ steps.find_artifacts.outputs.aab_path }}" ]; then
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifact_url\":\"$APK_URL\",\"artifact_aab_url\":\"$AAB_URL\"}"
          else
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifact_url\":\"$APK_URL\"}"
          fi
