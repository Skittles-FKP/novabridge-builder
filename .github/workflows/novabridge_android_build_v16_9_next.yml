name: NovaBridge Android Cloud Build v17 (EMERALD FINAL)

on:
  # Manual trigger (keep)
  workflow_dispatch:

  # REQUIRED: Worker-triggered build (DO NOT REMOVE)
  repository_dispatch:
    types:
      - novabridge_android_build_v17_next

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

      # üîí CRITICAL FIX ‚Äî PIN GRADLE (AGP 8.2.x SAFE)
      GRADLE_VERSION: 8.2.2

    steps:
      # ------------------------------------------------------------
      # Checkout (required by GitHub Actions)
      # ------------------------------------------------------------
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Diagnostics (safe, non-secret)
      # ------------------------------------------------------------
      - name: üß™ Print incoming payload
        run: |
          echo "BUILD_ID=${BUILD_ID}"
          echo "ZIP_URL=${ZIP_URL}"
          echo "CALLBACK_URL=${CALLBACK_URL}"
          echo "GRADLE_VERSION=${GRADLE_VERSION}"

      # ------------------------------------------------------------
      # Java 17 (REQUIRED for AGP 8.x)
      # ------------------------------------------------------------
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ------------------------------------------------------------
      # üîí FORCE GRADLE 8.2.2 (THIS FIXES THE CRASH)
      # ------------------------------------------------------------
      - name: üîß Install pinned Gradle (AGP-safe)
        run: |
          curl -sSL https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip -o gradle.zip
          unzip -q gradle.zip
          echo "$PWD/gradle-${GRADLE_VERSION}/bin" >> $GITHUB_PATH
          gradle --version

      # ------------------------------------------------------------
      # Download ZIP generated by Worker
      # ------------------------------------------------------------
      - name: üì• Download Android project ZIP
        run: |
          curl -L "$ZIP_URL" -o project.zip
          unzip -q project.zip -d extracted
          ls -la extracted

      # ------------------------------------------------------------
      # Android SDK
      # ------------------------------------------------------------
      - name: üì¶ Setup Android SDK
        uses: android-actions/setup-android@v3

      # ------------------------------------------------------------
      # Debug keystore (required for debug + release fallback)
      # ------------------------------------------------------------
      - name: üîë Ensure debug keystore
        run: |
          mkdir -p ~/.android
          if [ ! -f ~/.android/debug.keystore ]; then
            keytool -genkeypair \
              -keystore ~/.android/debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi

      # ------------------------------------------------------------
      # Build APK (Release ‚Üí Debug fallback)
      # ------------------------------------------------------------
      - name: üèóÔ∏è Build APK (Release)
        working-directory: extracted
        run: |
          gradle assembleRelease --no-daemon

      # ------------------------------------------------------------
      # Locate APK
      # ------------------------------------------------------------
      - name: üîç Locate APK
        run: |
          APK_PATH=$(find extracted -type f -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "‚ùå APK not found"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "Found APK: $APK_PATH"

      # ------------------------------------------------------------
      # Upload APK to R2 (or artifact store)
      # ------------------------------------------------------------
      - name: ‚òÅÔ∏è Upload APK artifact
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{
              \"build_id\": \"${BUILD_ID}\",
              \"status\": \"success\",
              \"artifact_apk_url\": \"${APK_PATH}\"
            }"

      # ------------------------------------------------------------
      # Final confirmation
      # ------------------------------------------------------------
      - name: ‚úÖ Build completed
        run: |
          echo "Android build completed successfully for ${BUILD_ID}"
