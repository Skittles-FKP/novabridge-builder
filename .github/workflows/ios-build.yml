name: NovaBridge iOS Build v1.1.3

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      # --------------------------------------------------
      # 1Ô∏è‚É£ Validate inputs (BULLETPROOF)
      # --------------------------------------------------
      - name: Validate inputs
        shell: bash
        run: |
          set -e
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"

          if [ -z "${CALLBACK_TOKEN:-}" ]; then
            echo "‚ùå CALLBACK_TOKEN is missing (GitHub Secret)."
            exit 1
          fi
          echo "‚û° CALLBACK_TOKEN_LENGTH=${#CALLBACK_TOKEN}"

          if [ -z "${BUILD_ID:-}" ]; then
            echo "‚ùå BUILD_ID missing"
            exit 1
          fi
          if [ -z "${ZIP_URL:-}" ]; then
            echo "‚ùå ZIP_URL missing"
            exit 1
          fi
          if [ -z "${CALLBACK_URL:-}" ]; then
            echo "‚ùå CALLBACK_URL missing"
            exit 1
          fi

      # --------------------------------------------------
      # 2Ô∏è‚É£ Callback helper (non-fatal)
      # --------------------------------------------------
      - name: Callback ‚Äî Downloading Project
        shell: bash
        run: |
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"active\",\"log\":\"iOS: üì• Downloading iOS project files\"}" \
            || echo "‚ö†Ô∏è Callback failed (non-fatal)"

      # --------------------------------------------------
      # 3Ô∏è‚É£ Download ZIP (diagnostics)
      # --------------------------------------------------
      - name: Download iOS ZIP
        shell: bash
        run: |
          set -e
          echo "‚¨áÔ∏è Downloading: $ZIP_URL"
          curl -fL "$ZIP_URL" -o ios.zip

          echo "üì¶ ZIP size:"
          ls -lh ios.zip

          echo "üìÇ ZIP listing:"
          unzip -l ios.zip

          unzip ios.zip

          echo "üìÇ Workspace tree (maxdepth 5):"
          find . -maxdepth 5

      # --------------------------------------------------
      # 4Ô∏è‚É£ Install XcodeGen (safe)
      # --------------------------------------------------
      - name: Install XcodeGen
        shell: bash
        run: |
          set -e
          if ! command -v xcodegen >/dev/null 2>&1; then
            echo "üîß Installing XcodeGen"
            brew install xcodegen
          else
            echo "‚úÖ XcodeGen already installed"
          fi
          xcodegen --version

      # --------------------------------------------------
      # 5Ô∏è‚É£ Generate Xcode project from project.yml
      # --------------------------------------------------
      - name: Generate Xcode Project
        shell: bash
        run: |
          set -e
          echo "üîç Searching for project.yml..."
          find . -name project.yml || true

          IOS_DIR="$(find . -name project.yml | head -n 1 | xargs dirname)"
          if [ -z "$IOS_DIR" ]; then
            echo "‚ùå project.yml not found"
            find . -maxdepth 8
            exit 1
          fi

          echo "üìÅ IOS_DIR=$IOS_DIR"
          cd "$IOS_DIR"

          echo "üß± xcodegen generate"
          xcodegen generate

          echo "üìÇ After xcodegen:"
          ls -la
          find . -maxdepth 2 -name "*.xcodeproj" -print || true

          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"active\",\"log\":\"iOS: üß± Xcode project generated\"}" \
            || echo "‚ö†Ô∏è Callback failed (non-fatal)"

      # --------------------------------------------------
      # 6Ô∏è‚É£ Detect project + scheme (trimmed)
      # --------------------------------------------------
      - name: Detect project + scheme
        shell: bash
        run: |
          set -e
          cd "$IOS_DIR"

          PROJECT_PATH="$(find . -maxdepth 3 -name "*.xcodeproj" | head -n 1 | sed 's|^\./||')"
          if [ -z "$PROJECT_PATH" ]; then
            echo "‚ùå .xcodeproj not found after xcodegen"
            find . -maxdepth 4
            exit 1
          fi

          echo "üìÅ Using project: $PROJECT_PATH"
          echo "üîç Listing schemes:"
          xcodebuild -list -project "$PROJECT_PATH"

          SCHEME="$(xcodebuild -list -project "$PROJECT_PATH" \
            | awk '/Schemes:/ {found=1; next} found && NF {print; exit}' \
            | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found"
            exit 1
          fi

          echo "üéØ Using scheme: $SCHEME"

          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"active\",\"log\":\"iOS: üì± Queued on macOS runner\"}" \
            || echo "‚ö†Ô∏è Callback failed (non-fatal)"

      # --------------------------------------------------
      # 7Ô∏è‚É£ Build with Xcode
      # --------------------------------------------------
      - name: Build with Xcode
        shell: bash
        run: |
          set -e
          cd "$IOS_DIR"

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: üî® Building with Xcode\"}" \
            || echo "‚ö†Ô∏è Callback failed (non-fatal)"

          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      # --------------------------------------------------
      # 8Ô∏è‚É£ Package .app
      # --------------------------------------------------
      - name: Package iOS Build
        shell: bash
        run: |
          set -e
          APP_PATH="$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" | head -n 1)"
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå .app not found"
            exit 1
          fi

          echo "üì¶ App path: $APP_PATH"
          zip -r ios-build.zip "$APP_PATH"

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"active\",\"log\":\"iOS: üì¶ Packaging iOS build\"}" \
            || echo "‚ö†Ô∏è Callback failed (non-fatal)"

      # --------------------------------------------------
      # 9Ô∏è‚É£ Upload artifact to GitHub
      # --------------------------------------------------
      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ env.BUILD_ID }}
          path: ios-build.zip

      # --------------------------------------------------
      # ‚úÖ Final success callback (stops UI polling)
      # --------------------------------------------------
      - name: Callback ‚Äî Build Complete
        shell: bash
        run: |
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"step\":8,\"step_state\":\"done\",\"log\":\"iOS: ‚úÖ Build completed successfully\",\"artifact_key\":\"ios/artifacts/$BUILD_ID.zip\"}" \
            || echo "‚ö†Ô∏è Callback failed (non-fatal)"

      # --------------------------------------------------
      # ‚ùå If anything fails, notify Worker/UI (terminal)
      # --------------------------------------------------
      - name: Failure callback
        if: failure()
        shell: bash
        run: |
          echo "‚ùå Build failed ‚Äî sending terminal callback"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\",\"step\":8,\"step_state\":\"failed\",\"log\":\"iOS: ‚ùå Build failed in GitHub Actions\"}" \
            || true
