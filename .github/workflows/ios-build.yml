name: NovaBridge iOS Build v1.1.4

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - novabridge_ios_build_v1

jobs:
  ios-build:
    runs-on: macos-14

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: Validate payload
        shell: bash
        run: |
          set -euo pipefail
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          echo "CALLBACK_TOKEN_LENGTH=${#CALLBACK_TOKEN}"

          if [ -z "${BUILD_ID:-}" ]; then echo "Missing BUILD_ID"; exit 1; fi
          if [ -z "${ZIP_URL:-}" ]; then echo "Missing ZIP_URL"; exit 1; fi
          if [ -z "${CALLBACK_URL:-}" ]; then echo "Missing CALLBACK_URL"; exit 1; fi
          if [ -z "${CALLBACK_TOKEN:-}" ]; then echo "Missing CALLBACK_TOKEN"; exit 1; fi

      - name: Create callback helper
        shell: bash
        run: |
          set -euo pipefail
          cat > cb.sh <<'SH'
          cb() {
            local payload="$1"
            echo "cb payload: $payload"
            curl -sS -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              --data "$payload"
          }
          SH
          chmod +x cb.sh

      - name: Step 3 active (Downloading Project)
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"active\",\"log\":\"iOS: Downloading iOS project files\"}" || true

      - name: Download ZIP
        shell: bash
        run: |
          set -euo pipefail
          rm -rf work ios.zip
          mkdir -p work
          curl -fL "$ZIP_URL" -o ios.zip
          unzip -q ios.zip -d work

      - name: Step 3 done
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"done\",\"log\":\"iOS: Project downloaded\"}" || true

      - name: Locate project.yml directory
        shell: bash
        run: |
          set -euo pipefail

          # Find project.yml (generated by Worker)
          IOS_DIR="$(find work -type f -name project.yml -print0 | xargs -0 -n 1 dirname | head -n 1 || true)"

          if [ -z "${IOS_DIR:-}" ]; then
            echo "project.yml not found under extracted ZIP"
            echo "Listing extracted tree (first 200 files):"
            find work -type f | head -n 200
            exit 1
          fi

          echo "IOS_DIR=$IOS_DIR"
          echo "IOS_DIR=$IOS_DIR" >> "$GITHUB_ENV"

      - name: Install XcodeGen
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install xcodegen

      - name: Step 4 active (Generating Xcode Project)
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"active\",\"log\":\"iOS: Generating Xcode project (xcodegen)\"}" || true

      - name: Generate Xcode project (xcodegen)
        shell: bash
        run: |
          set -euo pipefail
          cd "$IOS_DIR"
          test -f project.yml
          xcodegen

          echo "Projects found:"
          ls -la *.xcodeproj || true

      - name: Step 4 done
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"done\",\"log\":\"iOS: Xcode project generated\"}" || true

      - name: Detect .xcodeproj + scheme (JSON parse)
        shell: bash
        run: |
          set -euo pipefail
          cd "$IOS_DIR"

          XCODEPROJ="$(ls -1 *.xcodeproj 2>/dev/null | head -n 1 || true)"
          if [ -z "${XCODEPROJ:-}" ]; then
            echo "No .xcodeproj found after xcodegen"
            exit 1
          fi

          SCHEME="$(python3 - <<PY
import json, subprocess
xcodeproj = "${XCODEPROJ}"
out = subprocess.check_output(["xcodebuild","-list","-json","-project", xcodeproj], text=True)
data = json.loads(out)
schemes = (data.get("project") or {}).get("schemes") or []
print(schemes[0] if schemes else "")
PY
          )"

          if [ -z "${SCHEME:-}" ]; then
            echo "No scheme found"
            echo "Raw list:"
            xcodebuild -list -project "$XCODEPROJ" || true
            exit 1
          fi

          echo "XCODEPROJ=$XCODEPROJ"
          echo "SCHEME=$SCHEME"

          echo "XCODEPROJ=$XCODEPROJ" >> "$GITHUB_ENV"
          echo "SCHEME=$SCHEME" >> "$GITHUB_ENV"

      - name: Step 5 active (Queued on macOS Runner)
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"active\",\"log\":\"iOS: Queued on macOS runner\"}" || true

      - name: Step 6 active (Building with Xcode)
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: Building with Xcode\"}" || true

      - name: Build (no signing)
        shell: bash
        run: |
          set -euo pipefail
          cd "$IOS_DIR"

          DERIVED="$RUNNER_TEMP/DerivedData"
          rm -rf "$DERIVED"
          mkdir -p "$DERIVED"

          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -derivedDataPath "$DERIVED" \
            CODE_SIGNING_ALLOWED=NO \
            build | tee "$RUNNER_TEMP/xcodebuild.log"

      - name: Step 6 done
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"done\",\"log\":\"iOS: Xcode build finished\"}" || true

      - name: Step 7 active (Packaging iOS Build)
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"active\",\"log\":\"iOS: Packaging iOS build artifacts\"}" || true

      - name: Package artifact (zip .app)
        shell: bash
        run: |
          set -euo pipefail
          DERIVED="$RUNNER_TEMP/DerivedData"
          APP_PATH="$(find "$DERIVED" -type d -name '*.app' | head -n 1 || true)"
          if [ -z "${APP_PATH:-}" ]; then
            echo "Built .app not found"
            exit 1
          fi

          rm -rf artifact
          mkdir -p artifact
          cp -R "$APP_PATH" artifact/

          (cd artifact && zip -qr ios-build.zip .)
          ls -la artifact/ios-build.zip

      - name: Step 7 done
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"done\",\"log\":\"iOS: Artifact packaged\"}" || true

      - name: Final callback SUCCESS (uploads artifact via base64)
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh

          B64="$(base64 artifact/ios-build.zip | tr -d '\n')"

          # This must succeed, otherwise UI stays "running"
          cb "{
            \"build_id\":\"$BUILD_ID\",
            \"status\":\"success\",
            \"step\":8,
            \"step_state\":\"done\",
            \"artifact_key\":\"ios/artifacts/$BUILD_ID.zip\",
            \"artifact_blob_b64\":\"$B64\",
            \"log\":\"iOS: Build complete\"
          }"

      - name: Final callback FAILURE
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh

          DETAILS="(no xcodebuild log)"
          if [ -f "$RUNNER_TEMP/xcodebuild.log" ]; then
            DETAILS="$(tail -n 200 "$RUNNER_TEMP/xcodebuild.log" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')"
          else
            DETAILS="\"(no xcodebuild log)\""
          fi

          cb "{
            \"build_id\":\"$BUILD_ID\",
            \"status\":\"failed\",
            \"step\":6,
            \"step_state\":\"failed\",
            \"error\":\"iOS build failed\",
            \"log\":\"iOS: Build failed\",
            \"details\": $DETAILS
          }" || true
