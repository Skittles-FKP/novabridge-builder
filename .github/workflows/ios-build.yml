name: NovaBridge iOS Build

on:
  workflow_dispatch:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          set -e
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"

          if [ -z "$BUILD_ID" ] || [ -z "$ZIP_URL" ] || [ -z "$CALLBACK_URL" ]; then
            echo "‚ùå Missing required inputs"
            exit 1
          fi

      - name: Download iOS ZIP
        run: |
          set -e
          curl -L "$ZIP_URL" -o ios.zip
          unzip ios.zip

      - name: Install XcodeGen
        run: |
          set -e
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi
          xcodegen --version

      - name: Generate Xcode project
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          echo "üìÇ Contents before generation:"
          ls -la

          if [ ! -f project.yml ]; then
            echo "‚ùå project.yml not found"
            exit 1
          fi

          echo "üõ† Running XcodeGen..."
          xcodegen generate --spec project.yml

          echo "üìÇ Contents after generation:"
          ls -la

          PROJECT_PATH=$(find . -maxdepth 1 -name "*.xcodeproj" | head -n 1)

          if [ -z "$PROJECT_PATH" ]; then
            echo "‚ùå No .xcodeproj generated"
            exit 1
          fi

          echo "‚úÖ Generated project: $PROJECT_PATH"
          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV

      - name: Build with Xcode
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          echo "üì¶ Using project: $PROJECT_PATH"

          echo "üîç Listing schemes..."
          xcodebuild -list -project "$PROJECT_PATH"

          SCHEME=$(xcodebuild -list -project "$PROJECT_PATH" \
            | sed -n '/Schemes:/,$p' | tail -n +2 | head -n 1 | xargs)

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found"
            exit 1
          fi

          echo "üéØ Building scheme: $SCHEME"

          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Package artifact
        run: |
          set -e
          mkdir -p artifact
          find ios/NovaBridgeDemo-iOS -name "*.app" -maxdepth 4 -exec cp -R {} artifact \;
          zip -r ios-artifact.zip artifact

      - name: Notify Worker (success)
        run: |
          set -e
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{
              \"build_id\": \"$BUILD_ID\",
              \"status\": \"success\",
              \"artifact_key\": \"ios/artifacts/$BUILD_ID.zip\"
            }"
