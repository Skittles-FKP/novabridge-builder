name: NovaBridge iOS Build (FINAL)

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - novabridge_ios_build_v1

jobs:
  ios-build:
    runs-on: macos-14

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}

      ARTIFACT_KEY: ios/artifacts/${{ github.event.client_payload.build_id }}.zip

    steps:
      - name: Validate inputs
        run: |
          set -e
          for v in BUILD_ID ZIP_URL CALLBACK_URL CALLBACK_TOKEN; do
            [ -z "${!v}" ] && echo "‚ùå $v missing" && exit 1
          done

      - name: Download project ZIP
        run: |
          set -e
          curl -L "$ZIP_URL" -o ios.zip
          unzip -q ios.zip

      - name: Generate Xcode project (xcodegen)
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS
          brew install xcodegen || true
          xcodegen generate --spec project.yml
          ls -la

      - name: Build with Xcode (SAFE MODE)
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          PROJECT=$(ls *.xcodeproj | head -n 1)
          echo "üì¶ Using project: $PROJECT"

          SCHEME=$(xcodebuild -list -project "$PROJECT" \
            | sed -n '/Schemes:/,$p' | tail -n +2 | head -n 1 | xargs)

          echo "üéØ Using scheme: $SCHEME"

          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Package build
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS
          zip -qr ios-artifact.zip .

      - name: Upload to R2
        run: |
          set -e
          brew install awscli || true
          export AWS_ACCESS_KEY_ID=$R2_ACCESS_KEY_ID
          export AWS_SECRET_ACCESS_KEY=$R2_SECRET_ACCESS_KEY
          export AWS_DEFAULT_REGION=auto
          aws s3 cp ios/NovaBridgeDemo-iOS/ios-artifact.zip \
            s3://$R2_BUCKET/$ARTIFACT_KEY \
            --endpoint-url https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com

      - name: Callback SUCCESS
        run: |
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifact_key\":\"$ARTIFACT_KEY\"}"

      - name: Callback FAILED
        if: failure()
        run: |
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\"}"
