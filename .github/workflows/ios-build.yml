name: NovaBridge iOS Build (Generated Project)

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: Validate payload
        run: |
          set -e
          [ -n "$BUILD_ID" ] && [ -n "$ZIP_URL" ] && [ -n "$CALLBACK_URL" ]

      - name: Download iOS ZIP
        run: |
          curl -L "$ZIP_URL" -o ios.zip
          unzip ios.zip -d work

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: |
          cd work/ios/NovaBridgeDemo-iOS
          xcodegen generate

      - name: Locate project + scheme
        run: |
          XCODEPROJ=$(find work -name "*.xcodeproj" | head -n 1)
          SCHEME=$(xcodebuild -list -project "$XCODEPROJ" | awk '/Schemes:/ {getline; print $1}')
          echo "XCODEPROJ=$XCODEPROJ" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      - name: Build iOS app
        run: |
          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Package ZIP artifact
        run: |
          cd work
          zip -r ios-artifact.zip .

      - name: Upload ZIP artifact
        run: |
          curl -X PUT \
            --data-binary @work/ios-artifact.zip \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            "https://novabridge-ios-build-worker.novabridge.workers.dev/upload-artifact-ios/$BUILD_ID"

      - name: Upload IPA if present (additive)
        run: |
          if [ -f "work/NovaBridge.ipa" ]; then
            curl -X PUT \
              --data-binary @work/NovaBridge.ipa \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              "https://novabridge-ios-build-worker.novabridge.workers.dev/upload-artifact-ios/$BUILD_ID?type=ipa"
          fi

      - name: Final success callback
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"status\": \"success\" }"

      - name: Failure callback
        if: failure()
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"status\": \"failed\" }"
