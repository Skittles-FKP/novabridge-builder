name: NovaBridge iOS Build

on:
  repository_dispatch

jobs:
  ios-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Validate payload
      # ------------------------------------------------------------
      - name: üîé Validate payload
        run: |
          set -e
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"

          if [ -z "$BUILD_ID" ]; then
            echo "‚ùå BUILD_ID missing"
            exit 1
          fi

          if [ -z "$ZIP_URL" ]; then
            echo "‚ùå ZIP_URL missing"
            exit 1
          fi

          if [ -z "$CALLBACK_URL" ]; then
            echo "‚ùå CALLBACK_URL missing"
            exit 1
          fi

          if [ -z "$CALLBACK_TOKEN" ]; then
            echo "‚ùå CALLBACK_TOKEN missing"
            exit 1
          fi

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Download iOS ZIP from Worker
      # ------------------------------------------------------------
      - name: üì• Download iOS ZIP
        run: |
          set -e
          curl -fL "$ZIP_URL" -o ios.zip
          unzip -q ios.zip
          echo "‚úÖ ZIP extracted"

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"done\",\"log\":\"iOS: üì• Project downloaded\"}"

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Locate Xcode project
      # ------------------------------------------------------------
      - name: üìÅ Locate Xcode project
        run: |
          set -e
          IOS_DIR=$(find . -name "*.xcodeproj" | head -n 1 | xargs dirname)

          if [ -z "$IOS_DIR" ]; then
            echo "‚ùå No Xcode project found"
            exit 1
          fi

          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV
          echo "üìÇ Using iOS directory: $IOS_DIR"

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"done\",\"log\":\"iOS: üß© Xcode project ready\"}"

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Build with Xcode (unsigned)
      # ------------------------------------------------------------
      - name: üî® Build iOS app with Xcode
        run: |
          set -e
          cd "$IOS_DIR"

          SCHEME=$(xcodebuild -list -project *.xcodeproj | awk '/Schemes:/ {getline; print $1}')

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found"
            exit 1
          fi

          echo "üéØ Building scheme: $SCHEME"

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: üî® Building with Xcode\"}"

          xcodebuild \
            -project *.xcodeproj \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            CODE_SIGNING_ALLOWED=NO \
            build

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"done\",\"log\":\"iOS: ‚úÖ Xcode build completed\"}"

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Package build artifact
      # ------------------------------------------------------------
      - name: üì¶ Package iOS build
        run: |
          set -e
          cd "$IOS_DIR"

          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "‚ùå No .app found"
            exit 1
          fi

          mkdir -p artifact
          cp -R "$APP_PATH" artifact/

          zip -r ios-artifact.zip artifact

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"done\",\"log\":\"iOS: üì¶ Build packaged\"}"

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Upload artifact back to Worker
      # ------------------------------------------------------------
      - name: ‚òÅÔ∏è Upload artifact to Worker
        run: |
          set -e
          curl -f -X PUT \
            "$CALLBACK_URL?artifact=1&build_id=$BUILD_ID" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            --data-binary "@ios-artifact.zip"

      # ------------------------------------------------------------
      # 7Ô∏è‚É£ Final success callback
      # ------------------------------------------------------------
      - name: ‚úÖ Finalize build
        run: |
          set -e
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"log\":\"iOS: üéâ Build complete\"}"
