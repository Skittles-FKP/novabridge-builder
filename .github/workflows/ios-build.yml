name: NovaBridge iOS Build v1.1.6

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: Validate inputs
        shell: bash
        run: |
          set -e
          echo "âž¡ BUILD_ID=$BUILD_ID"
          echo "âž¡ ZIP_URL=$ZIP_URL"
          echo "âž¡ CALLBACK_URL=$CALLBACK_URL"

          if [ -z "${CALLBACK_TOKEN:-}" ]; then
            echo "âŒ CALLBACK_TOKEN missing (GitHub Secret)."
            exit 1
          fi
          echo "âž¡ CALLBACK_TOKEN_LENGTH=${#CALLBACK_TOKEN}"

          if [ -z "${BUILD_ID:-}" ] || [ -z "${ZIP_URL:-}" ] || [ -z "${CALLBACK_URL:-}" ]; then
            echo "âŒ Missing BUILD_ID / ZIP_URL / CALLBACK_URL"
            exit 1
          fi

      - name: Callback â€” Downloading Project
        shell: bash
        run: |
          callback() {
            local payload="$1"
            curl -sS -o /dev/null -w "%{http_code}" \
              -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" || true
          }
          callback "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“¥ Downloading iOS project files\"}" >/dev/null

      - name: Download iOS ZIP
        shell: bash
        run: |
          set -e
          echo "â¬‡ï¸ Downloading: $ZIP_URL"
          curl -fL "$ZIP_URL" -o ios.zip
          echo "ðŸ“¦ ZIP size:"; ls -lh ios.zip
          echo "ðŸ“‚ ZIP listing:"; unzip -l ios.zip
          unzip ios.zip
          echo "ðŸ“‚ Workspace tree (maxdepth 5):"
          find . -maxdepth 5

      - name: Install XcodeGen
        shell: bash
        run: |
          set -e
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi
          xcodegen --version

      - name: Generate Xcode Project
        shell: bash
        run: |
          set -e
          IOS_DIR="$(find . -name project.yml | head -n 1 | xargs dirname)"
          if [ -z "$IOS_DIR" ]; then
            echo "âŒ project.yml not found"
            find . -maxdepth 8
            exit 1
          fi

          echo "ðŸ“ IOS_DIR=$IOS_DIR"
          cd "$IOS_DIR"
          xcodegen generate

          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV

          callback() {
            local payload="$1"
            curl -sS -o /dev/null -w "%{http_code}" \
              -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" || true
          }
          callback "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"active\",\"log\":\"iOS: ðŸ§± Xcode project generated\"}" >/dev/null

      # âœ… PATCHED HERE (no cp identical failure)
      - name: Fix AppIcon set (1024 + required sizes)
        shell: bash
        run: |
          set -e
          cd "$IOS_DIR"

          ICONSET_DIR="App/Assets.xcassets/AppIcon.appiconset"
          mkdir -p "$ICONSET_DIR"

          # Choose a source image
          SRC=""
          if [ -f "$ICONSET_DIR/AppIcon-1024.png" ]; then
            SRC="$ICONSET_DIR/AppIcon-1024.png"
          else
            SRC="$(find "$ICONSET_DIR" -maxdepth 1 -name "*.png" | head -n 1 || true)"
          fi

          if [ -z "$SRC" ]; then
            echo "âŒ No source icon PNG found in $ICONSET_DIR"
            echo "âœ… Ensure Worker includes at least one PNG in AppIcon.appiconset"
            find "App/Assets.xcassets" -maxdepth 3
            exit 1
          fi

          echo "ðŸŽ¨ Using source icon: $SRC"

          # Ensure target 1024 exists and is 1024x1024
          TARGET="$ICONSET_DIR/AppIcon-1024.png"
          if [ "$SRC" != "$TARGET" ]; then
            cp "$SRC" "$TARGET"
          fi
          sips -z 1024 1024 "$TARGET" >/dev/null

          gen() {
            local px="$1"
            local out="$2"
            cp "$TARGET" "$ICONSET_DIR/$out"
            sips -z "$px" "$px" "$ICONSET_DIR/$out" >/dev/null
          }

          # iPhone
          gen 40  "AppIcon-20@2x.png"
          gen 60  "AppIcon-20@3x.png"
          gen 58  "AppIcon-29@2x.png"
          gen 87  "AppIcon-29@3x.png"
          gen 80  "AppIcon-40@2x.png"
          gen 120 "AppIcon-40@3x.png"
          gen 120 "AppIcon-60@2x.png"
          gen 180 "AppIcon-60@3x.png"

          # iPad
          gen 20  "AppIcon-20@1x.png"
          gen 40  "AppIcon-20@2x-ipad.png"
          gen 29  "AppIcon-29@1x.png"
          gen 58  "AppIcon-29@2x-ipad.png"
          gen 40  "AppIcon-40@1x.png"
          gen 80  "AppIcon-40@2x-ipad.png"
          gen 76  "AppIcon-76@1x.png"
          gen 152 "AppIcon-76@2x.png"
          gen 167 "AppIcon-83.5@2x.png"

          cat > "$ICONSET_DIR/Contents.json" <<'JSON'
          {
            "images": [
              { "idiom": "iphone", "size": "20x20", "scale": "2x", "filename": "AppIcon-20@2x.png" },
              { "idiom": "iphone", "size": "20x20", "scale": "3x", "filename": "AppIcon-20@3x.png" },
              { "idiom": "iphone", "size": "29x29", "scale": "2x", "filename": "AppIcon-29@2x.png" },
              { "idiom": "iphone", "size": "29x29", "scale": "3x", "filename": "AppIcon-29@3x.png" },
              { "idiom": "iphone", "size": "40x40", "scale": "2x", "filename": "AppIcon-40@2x.png" },
              { "idiom": "iphone", "size": "40x40", "scale": "3x", "filename": "AppIcon-40@3x.png" },
              { "idiom": "iphone", "size": "60x60", "scale": "2x", "filename": "AppIcon-60@2x.png" },
              { "idiom": "iphone", "size": "60x60", "scale": "3x", "filename": "AppIcon-60@3x.png" },

              { "idiom": "ipad", "size": "20x20", "scale": "1x", "filename": "AppIcon-20@1x.png" },
              { "idiom": "ipad", "size": "20x20", "scale": "2x", "filename": "AppIcon-20@2x-ipad.png" },
              { "idiom": "ipad", "size": "29x29", "scale": "1x", "filename": "AppIcon-29@1x.png" },
              { "idiom": "ipad", "size": "29x29", "scale": "2x", "filename": "AppIcon-29@2x-ipad.png" },
              { "idiom": "ipad", "size": "40x40", "scale": "1x", "filename": "AppIcon-40@1x.png" },
              { "idiom": "ipad", "size": "40x40", "scale": "2x", "filename": "AppIcon-40@2x-ipad.png" },
              { "idiom": "ipad", "size": "76x76", "scale": "1x", "filename": "AppIcon-76@1x.png" },
              { "idiom": "ipad", "size": "76x76", "scale": "2x", "filename": "AppIcon-76@2x.png" },
              { "idiom": "ipad", "size": "83.5x83.5", "scale": "2x", "filename": "AppIcon-83.5@2x.png" },

              { "idiom": "ios-marketing", "size": "1024x1024", "scale": "1x", "filename": "AppIcon-1024.png" }
            ],
            "info": { "version": 1, "author": "xcode" }
          }
          JSON

      - name: Detect project + scheme
        shell: bash
        run: |
          set -e
          cd "$IOS_DIR"

          PROJECT_PATH="$(find . -maxdepth 3 -name "*.xcodeproj" | head -n 1 | sed 's|^\./||')"
          if [ -z "$PROJECT_PATH" ]; then
            echo "âŒ .xcodeproj not found"
            find . -maxdepth 4
            exit 1
          fi

          SCHEME="$(xcodebuild -list -project "$PROJECT_PATH" \
            | awk '/Schemes:/ {found=1; next} found && NF {print; exit}' \
            | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"

          if [ -z "$SCHEME" ]; then
            echo "âŒ No scheme found"
            exit 1
          fi

          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      - name: Callback â€” Queued on macOS runner
        shell: bash
        run: |
          callback() {
            local payload="$1"
            curl -sS -o /dev/null -w "%{http_code}" \
              -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" || true
          }
          callback "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“± Queued on macOS runner\"}" >/dev/null

      - name: Build with Xcode
        shell: bash
        run: |
          set -e
          cd "$IOS_DIR"

          callback() {
            local payload="$1"
            curl -sS -o /dev/null -w "%{http_code}" \
              -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" || true
          }
          callback "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: ðŸ”¨ Building with Xcode\"}" >/dev/null

          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Package iOS Build
        shell: bash
        run: |
          set -e

          callback() {
            local payload="$1"
            curl -sS -o /dev/null -w "%{http_code}" \
              -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" || true
          }
          callback "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“¦ Packaging iOS build\"}" >/dev/null

          APP_PATH="$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" | head -n 1)"
          if [ -z "$APP_PATH" ]; then
            echo "âŒ .app not found"
            exit 1
          fi

          zip -r ios-build.zip "$APP_PATH"

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ env.BUILD_ID }}
          path: ios-build.zip

      - name: Callback â€” Build Complete
        shell: bash
        run: |
          callback() {
            local payload="$1"
            curl -sS -o /dev/null -w "%{http_code}" \
              -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" || true
          }
          callback "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"step\":8,\"step_state\":\"done\",\"log\":\"iOS: âœ… Build completed successfully\",\"artifact_key\":\"ios/artifacts/$BUILD_ID.zip\"}" >/dev/null

      - name: Failure callback
        if: failure()
        shell: bash
        run: |
          callback() {
            local payload="$1"
            curl -sS -o /dev/null -w "%{http_code}" \
              -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" || true
          }
          callback "{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\",\"step\":8,\"step_state\":\"failed\",\"log\":\"iOS: âŒ Build failed in GitHub Actions\"}" >/dev/null
