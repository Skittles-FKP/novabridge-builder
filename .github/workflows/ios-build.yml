name: NovaBridge iOS Build (Generated Project + Signed IPA)

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

      # Phase 2.1 Signing Secrets (repo secrets)
      IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
      IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      IOS_EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD }}

    steps:
      # -------------------------
      # 0Ô∏è‚É£ Validate payload + signing secrets
      # -------------------------
      - name: Validate payload + signing inputs
        run: |
          set -e
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"

          if [ -z "$BUILD_ID" ] || [ -z "$ZIP_URL" ] || [ -z "$CALLBACK_URL" ]; then
            echo "‚ùå Missing required payload values"
            exit 1
          fi

          # Signing inputs required for IPA export
          if [ -z "$IOS_P12_BASE64" ] || [ -z "$IOS_P12_PASSWORD" ] || [ -z "$IOS_MOBILEPROVISION_BASE64" ] || [ -z "$IOS_TEAM_ID" ] || [ -z "$IOS_EXPORT_METHOD" ]; then
            echo "‚ùå Missing iOS signing secrets (IOS_P12_BASE64/IOS_P12_PASSWORD/IOS_MOBILEPROVISION_BASE64/IOS_TEAM_ID/IOS_EXPORT_METHOD)"
            exit 1
          fi

          echo "‚úÖ Signing inputs present (lengths only):"
          echo "  IOS_P12_BASE64_LEN=${#IOS_P12_BASE64}"
          echo "  IOS_MOBILEPROVISION_BASE64_LEN=${#IOS_MOBILEPROVISION_BASE64}"
          echo "  IOS_TEAM_ID=$IOS_TEAM_ID"
          echo "  IOS_EXPORT_METHOD=$IOS_EXPORT_METHOD"

      # -------------------------
      # 1Ô∏è‚É£ Download ZIP
      # -------------------------
      - name: Download iOS ZIP
        run: |
          set -e
          curl -L "$ZIP_URL" -o ios.zip
          unzip -o ios.zip -d work

          echo "üìÅ Listing work/ios:"
          ls -la work/ios || true
          echo "üìÅ Recursive listing (first 120 lines):"
          (find work/ios -maxdepth 4 -print | head -n 120) || true

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 3, \"step_state\": \"done\", \"log\": \"iOS: üì• Project ZIP downloaded\" }"

      # -------------------------
      # 2Ô∏è‚É£ Install xcodegen
      # -------------------------
      - name: Install xcodegen
        run: |
          brew install xcodegen

      # -------------------------
      # 3Ô∏è‚É£ Locate iOS project directory
      # -------------------------
      - name: Locate iOS project directory
        run: |
          set -e

          PROJECT_YML=$(find work/ios -maxdepth 4 -name "project.yml" | head -n 1 || true)

          if [ -z "$PROJECT_YML" ]; then
            echo "‚ùå project.yml not found anywhere under work/ios"
            echo "üìÅ work/ios contents:"
            ls -la work/ios || true
            echo "üìÅ Recursive listing (first 200 lines):"
            (find work/ios -maxdepth 4 -print | head -n 200) || true
            exit 1
          fi

          IOS_DIR=$(dirname "$PROJECT_YML")

          echo "‚úÖ Found project.yml at: $PROJECT_YML"
          echo "üìÅ Using IOS_DIR: $IOS_DIR"

          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV

      # -------------------------
      # 4Ô∏è‚É£ Generate Xcode project
      # -------------------------
      - name: Generate Xcode project
        run: |
          set -e
          cd "$IOS_DIR"
          xcodegen generate

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 4, \"step_state\": \"done\", \"log\": \"iOS: üèó Xcode project generated\" }"

      # -------------------------
      # 5Ô∏è‚É£ Locate project + scheme + bundle id
      # -------------------------
      - name: Locate Xcode project and scheme + bundle id
        run: |
          set -e

          XCODEPROJ=$(find "$IOS_DIR" -maxdepth 2 -name "*.xcodeproj" | head -n 1 || true)
          if [ -z "$XCODEPROJ" ]; then
            echo "‚ùå No .xcodeproj found under IOS_DIR"
            echo "üìÅ IOS_DIR listing:"
            ls -la "$IOS_DIR" || true
            exit 1
          fi

          SCHEME=$(xcodebuild -list -project "$XCODEPROJ" | sed -n '/Schemes:/,$p' | sed -n '2p' | xargs || true)
          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found"
            xcodebuild -list -project "$XCODEPROJ" || true
            exit 1
          fi

          # Read bundle id from Info.plist
          INFO_PLIST="$IOS_DIR/App/Info.plist"
          if [ ! -f "$INFO_PLIST" ]; then
            echo "‚ùå Info.plist not found at $INFO_PLIST"
            ls -la "$IOS_DIR/App" || true
            exit 1
          fi

          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$INFO_PLIST" | xargs || true)
          if [ -z "$BUNDLE_ID" ]; then
            echo "‚ùå Could not read CFBundleIdentifier from Info.plist"
            exit 1
          fi

          echo "‚úÖ XCODEPROJ=$XCODEPROJ"
          echo "‚úÖ SCHEME=$SCHEME"
          echo "‚úÖ BUNDLE_ID=$BUNDLE_ID"

          echo "XCODEPROJ=$XCODEPROJ" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 5, \"step_state\": \"done\", \"log\": \"iOS: üì± Queued on macOS runner (scheme: $SCHEME)\" }"

      # -------------------------
      # 6Ô∏è‚É£ Setup signing (keychain + provisioning profile)
      # -------------------------
      - name: Setup iOS signing
        run: |
          set -e

          echo "üîê Setting up temporary keychain..."
          KEYCHAIN_PATH="$RUNNER_TEMP/novabridge-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db
          security default-keychain -s "$KEYCHAIN_PATH"

          echo "üìú Importing P12 certificate..."
          echo "$IOS_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" -k "$KEYCHAIN_PATH" -P "$IOS_P12_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/security

          # Allow codesign to access the key without UI prompt
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "üì¶ Installing provisioning profile..."
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "$IOS_MOBILEPROVISION_BASE64" | base64 --decode > "$RUNNER_TEMP/profile.mobileprovision"

          # Extract UUID and Name from the provisioning profile
          security cms -D -i "$RUNNER_TEMP/profile.mobileprovision" > "$RUNNER_TEMP/profile.plist"

          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" "$RUNNER_TEMP/profile.plist" | xargs || true)
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print :Name" "$RUNNER_TEMP/profile.plist" | xargs || true)

          if [ -z "$PROFILE_UUID" ] || [ -z "$PROFILE_NAME" ]; then
            echo "‚ùå Could not parse provisioning profile UUID/Name"
            exit 1
          fi

          cp "$RUNNER_TEMP/profile.mobileprovision" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"

          echo "‚úÖ Installed provisioning profile:"
          echo "  UUID=$PROFILE_UUID"
          echo "  NAME=$PROFILE_NAME"

          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 6, \"step_state\": \"active\", \"log\": \"iOS: üîê Signing assets installed (team: $IOS_TEAM_ID)\" }"

      # -------------------------
      # 7Ô∏è‚É£ Archive + Export IPA
      # -------------------------
      - name: Archive and export IPA
        run: |
          set -e
          cd "$IOS_DIR"

          echo "üèó Archiving (signed)..."
          ARCHIVE_PATH="$RUNNER_TEMP/${SCHEME}.xcarchive"
          EXPORT_DIR="$RUNNER_TEMP/export"
          mkdir -p "$EXPORT_DIR"

          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            -destination generic/platform=iOS \
            DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            clean archive

          echo "üßæ Creating ExportOptions.plist..."
          cat > "$RUNNER_TEMP/ExportOptions.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${IOS_EXPORT_METHOD}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${IOS_TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key>
              <string>${PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF

          echo "üì¶ Exporting IPA..."
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_DIR" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist"

          IPA_PATH=$(find "$EXPORT_DIR" -maxdepth 1 -name "*.ipa" | head -n 1 || true)
          if [ -z "$IPA_PATH" ]; then
            echo "‚ùå IPA not generated"
            echo "üìÅ Export dir listing:"
            ls -la "$EXPORT_DIR" || true
            exit 1
          fi

          echo "‚úÖ IPA generated at: $IPA_PATH"
          echo "IPA_PATH=$IPA_PATH" >> $GITHUB_ENV

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 7, \"step_state\": \"done\", \"log\": \"iOS: üì¶ IPA exported (${IOS_EXPORT_METHOD})\" }"

      # -------------------------
      # 8Ô∏è‚É£ Package legacy artifact ZIP (kept) + upload both outputs + COMPLETE
      # -------------------------
      - name: Package iOS artifact (ZIP kept)
        run: |
          set -e
          cd work
          zip -r ios-artifact.zip .

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 7, \"step_state\": \"done\", \"log\": \"iOS: üì¶ iOS build packaged (legacy zip)\" }"

      - name: Upload IPA + artifact ZIP to Worker and COMPLETE
        run: |
          set -e

          # Upload legacy artifact ZIP (existing)
          curl -X PUT \
            --data-binary @work/ios-artifact.zip \
            "https://novabridge-ios-build-worker.novabridge.workers.dev/upload-artifact-ios/$BUILD_ID"

          # Upload IPA (new)
          curl -X PUT \
            --data-binary @"$IPA_PATH" \
            "https://novabridge-ios-build-worker.novabridge.workers.dev/upload-ipa-ios/$BUILD_ID"

          # Authoritative callback (terminal=true happens in worker here)
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"status\": \"success\", \"artifact_key\": \"ios/artifacts/$BUILD_ID.zip\", \"ipa_key\": \"ios/ipas/$BUILD_ID.ipa\", \"log\": \"iOS: üéâ Build complete (IPA ready)\" }"

      # -------------------------
      # ‚ùå Failure handler
      # -------------------------
      - name: Failure callback
        if: failure()
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"status\": \"failed\", \"log\": \"iOS: ‚ùå Build failed in GitHub Actions\" }"
