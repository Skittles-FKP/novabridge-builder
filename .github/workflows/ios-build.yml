name: NovaBridge iOS Build

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  build-ios:
    runs-on: macos-14

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: Validate input
        run: |
          set -e
          test -n "$BUILD_ID"
          test -n "$ZIP_URL"
          test -n "$CALLBACK_URL"
          test -n "$CALLBACK_TOKEN"

      - name: Download ZIP
        run: |
          curl -L "$ZIP_URL" -o ios.zip
          unzip ios.zip

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: |
          cd ios/NovaBridgeDemo-iOS
          xcodegen generate

      - name: Build (unsigned)
        run: |
          cd ios/NovaBridgeDemo-iOS
          xcodebuild \
            -project NovaBridgeDemo.xcodeproj \
            -scheme NovaBridgeDemo \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO build

      - name: Package artifact
        run: |
          cd ios/NovaBridgeDemo-iOS
          zip -r app.zip build

      - name: Callback success
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"build_id":"'"$BUILD_ID"'","status":"success","step":8}'
