name: NovaBridge iOS Build (Generated Project)

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}
      ARTIFACT_UPLOAD_TOKEN: ${{ secrets.ARTIFACT_UPLOAD_TOKEN }}
      IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
      IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}

    steps:
      # ------------------------------------------------------------
      # 0Ô∏è‚É£ Validate payload
      # ------------------------------------------------------------
      - name: Validate payload
        run: |
          set -e
          if [ -z "$BUILD_ID" ] || [ -z "$ZIP_URL" ] || [ -z "$CALLBACK_URL" ]; then
            echo "‚ùå Missing required payload values"
            exit 1
          fi

      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Download ZIP
      # ------------------------------------------------------------
      - name: Download iOS ZIP
        run: |
          set -e
          curl -L "$ZIP_URL" -o ios.zip
          unzip ios.zip -d work

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Install xcodegen
      # ------------------------------------------------------------
      - name: Install xcodegen
        run: brew install xcodegen

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Locate iOS project directory
      # ------------------------------------------------------------
      - name: Locate iOS project directory
        run: |
          set -e
          IOS_DIR=$(find work/ios -maxdepth 1 -type d -name "*-iOS" | head -n 1)
          if [ -z "$IOS_DIR" ]; then
            echo "‚ùå No iOS project directory found"
            exit 1
          fi
          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Generate Xcode project
      # ------------------------------------------------------------
      - name: Generate Xcode project
        run: |
          set -e
          cd "$IOS_DIR"
          xcodegen generate

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Locate Xcode project + target
      # ------------------------------------------------------------
      - name: Locate Xcode project and target
        run: |
          set -e
          XCODEPROJ=$(find "$IOS_DIR" -name "*.xcodeproj" | head -n 1)
          TARGET=$(xcodebuild -list -project "$XCODEPROJ" \
            | sed -n '/Targets:/,/Build Configurations:/p' \
            | sed '1d;$d' \
            | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
            | head -n 1)

          echo "XCODEPROJ=$XCODEPROJ" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Build iOS app (NO SIGNING ‚Äì UNCHANGED)
      # ------------------------------------------------------------
      - name: Build iOS app
        run: |
          set -e
          xcodebuild \
            -project "$XCODEPROJ" \
            -target "$TARGET" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      # ============================================================
      # üîç DEBUG STEP ‚Äî FORENSIC (TEMPORARY, SAFE)
      # ============================================================
      - name: üîç Debug P12 decode (safe)
        run: |
          set -e
          echo "Length of IOS_P12_BASE64:"
          echo "${#IOS_P12_BASE64}"

          echo "$IOS_P12_BASE64" | tr -d '\n\r ' | base64 --decode > test.p12 || true

          if [ ! -f test.p12 ]; then
            echo "‚ùå test.p12 not created"
            exit 1
          fi

          echo "Decoded file size:"
          ls -lh test.p12

          echo "File type:"
          file test.p12 || true

      # ============================================================
      # üîê IMPORT SIGNING CERTIFICATE
      # ============================================================
      - name: Import iOS signing certificate
        run: |
          set -e

          echo "$IOS_P12_BASE64" | tr -d '\n\r ' | base64 --decode > cert.p12

          if [ ! -s cert.p12 ]; then
            echo "‚ùå cert.p12 is empty or invalid"
            exit 1
          fi

          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain

          security import cert.p12 \
            -k build.keychain \
            -P "$IOS_P12_PASSWORD" \
            -f pkcs12 \
            -T /usr/bin/codesign

          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "" build.keychain

          echo "‚úÖ iOS signing certificate imported"

      # ============================================================
      # üì¶ ARCHIVE (SIGNED)
      # ============================================================
      - name: Archive iOS app
        continue-on-error: true
        run: |
          set +e
          mkdir -p build
          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$TARGET" \
            -configuration Release \
            -archivePath build/App.xcarchive \
            -destination generic/platform=iOS \
            DEVELOPMENT_TEAM=$IOS_TEAM_ID \
            CODE_SIGNING_ALLOWED=YES \
            archive || exit 0

      # ============================================================
      # üì± EXPORT IPA (SIGNED)
      # ============================================================
      - name: Export IPA
        continue-on-error: true
        run: |
          set +e
          mkdir -p build/ipa

          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
          "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>ad-hoc</string>
            <key>signingStyle</key><string>manual</string>
            <key>compileBitcode</key><false/>
            <key>teamID</key><string>${IOS_TEAM_ID}</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist || exit 0

      # ============================================================
      # ‚òÅÔ∏è UPLOAD IPA (NON-BLOCKING)
      # ============================================================
      - name: Upload IPA to Worker
        continue-on-error: true
        run: |
          IPA=$(find build/ipa -name "*.ipa" | head -n 1)
          if [ -f "$IPA" ]; then
            curl -X PUT \
              -H "x-novabridge-token: ${ARTIFACT_UPLOAD_TOKEN:-$CALLBACK_TOKEN}" \
              --data-binary @"$IPA" \
              "https://novabridge-ios-build-worker.novabridge.workers.dev/upload-artifact-ios/$BUILD_ID"
          fi

      # ------------------------------------------------------------
      # üì¶ Package ZIP artifact
      # ------------------------------------------------------------
      - name: Package iOS artifact
        run: |
          set -e
          cd work
          zip -r ios-artifact.zip .

      # ------------------------------------------------------------
      # ‚òÅÔ∏è Upload ZIP artifact
      # ------------------------------------------------------------
      - name: Upload ZIP artifact to Worker
        run: |
          set -e
          curl -X PUT \
            -H "x-novabridge-token: ${ARTIFACT_UPLOAD_TOKEN:-$CALLBACK_TOKEN}" \
            --data-binary @work/ios-artifact.zip \
            "https://novabridge-ios-build-worker.novabridge.workers.dev/upload-artifact-ios/$BUILD_ID"
