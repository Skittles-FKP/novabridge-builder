name: NovaBridge iOS Build (v1.1.3)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: ðŸ§ª Validate payload
        shell: bash
        run: |
          set -e
          echo "âž¡ BUILD_ID=$BUILD_ID"
          echo "âž¡ ZIP_URL=$ZIP_URL"
          echo "âž¡ CALLBACK_URL=$CALLBACK_URL"

          if [ -z "$BUILD_ID" ]; then echo "âŒ BUILD_ID missing"; exit 1; fi
          if [ -z "$ZIP_URL" ]; then echo "âŒ ZIP_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_URL" ]; then echo "âŒ CALLBACK_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_TOKEN" ]; then echo "âŒ CALLBACK_TOKEN missing (must be GitHub Secret)"; exit 1; fi
          echo "âž¡ CALLBACK_TOKEN_LENGTH=${#CALLBACK_TOKEN}"

      - name: ðŸ“£ Callback (Step 3 active) - Downloading Project
        shell: bash
        run: |
          set -e
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“¥ Downloading iOS project files\"}" >/dev/null

      - name: ðŸ“¥ Download iOS ZIP
        shell: bash
        run: |
          set -e
          curl -fL "$ZIP_URL" -o ios.zip
          file ios.zip

      - name: ðŸ“¦ Unzip
        shell: bash
        run: |
          set -e
          unzip -q ios.zip -d work
          echo "ðŸ“ Top-level:"
          ls -la work
          echo "ðŸ“ Find project.yml:"
          find work -name "project.yml" -maxdepth 6 -print || true

      - name: ðŸ“£ Callback (Step 3 done)
        shell: bash
        run: |
          set -e
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"done\",\"log\":\"iOS: âœ… Downloaded & extracted\"}" >/dev/null

      - name: ðŸ§° Install XcodeGen
        shell: bash
        run: |
          set -e
          brew update
          brew install xcodegen

      - name: ðŸ§© Generate Xcode project (XcodeGen) (Step 4)
        shell: bash
        run: |
          set -e

          # Locate the directory containing project.yml (the worker writes: ios/NovaBridgeDemo-iOS/project.yml)
          PROJECT_YML=$(find work -name "project.yml" -maxdepth 10 | head -n 1)
          if [ -z "$PROJECT_YML" ]; then
            echo "âŒ project.yml not found (ZIP scaffold is wrong)"
            echo "ðŸ“ Listing work tree:"
            find work -maxdepth 4 -type f -print
            exit 1
          fi

          IOS_DIR=$(dirname "$PROJECT_YML")
          echo "ðŸ“‚ IOS_DIR=$IOS_DIR"
          ls -la "$IOS_DIR"

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"active\",\"log\":\"iOS: ðŸ§© Generating Xcode project (xcodegen)\"}" >/dev/null

          (cd "$IOS_DIR" && xcodegen generate)

          echo "âœ… XcodeGen complete. Projects found:"
          find "$IOS_DIR" -maxdepth 2 -name "*.xcodeproj" -print

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"done\",\"log\":\"iOS: âœ… Xcode project generated\"}" >/dev/null

      - name: ðŸ”Ž Locate Xcode project + scheme
        shell: bash
        run: |
          set -e
          PROJECT_YML=$(find work -name "project.yml" -maxdepth 10 | head -n 1)
          IOS_DIR=$(dirname "$PROJECT_YML")

          XCODEPROJ=$(find "$IOS_DIR" -maxdepth 3 -name "*.xcodeproj" | head -n 1)
          if [ -z "$XCODEPROJ" ]; then
            echo "âŒ No Xcode project found after xcodegen"
            find "$IOS_DIR" -maxdepth 3 -print
            exit 1
          fi

          echo "ðŸ“¦ XCODEPROJ=$XCODEPROJ"

          echo "ðŸ§¾ Schemes:"
          xcodebuild -list -project "$XCODEPROJ" | tee schemes.txt

          # Extract first scheme line under "Schemes:" block safely (trim whitespace!)
          SCHEME=$(awk '
            $0 ~ /^Schemes:/ { in=1; next }
            in==1 && $0 ~ /^[[:space:]]*[A-Za-z0-9_.-]/ { gsub(/^[[:space:]]+/, "", $0); print $0; exit }
          ' schemes.txt)

          if [ -z "$SCHEME" ]; then
            echo "âŒ No scheme found"
            cat schemes.txt
            exit 1
          fi

          echo "ðŸŽ¯ SCHEME=$SCHEME"

          # Export for later steps
          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV
          echo "XCODEPROJ=$XCODEPROJ" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      - name: ðŸ“£ Callback (Step 5 active) - Queued on macOS Runner
        shell: bash
        run: |
          set -e
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“± Queued on macOS runner\"}" >/dev/null
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"done\",\"log\":\"iOS: âœ… Runner allocated\"}" >/dev/null

      - name: ðŸ”¨ Build with Xcode (Step 6)
        shell: bash
        run: |
          set -e

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: ðŸ”¨ Building with Xcode\"}" >/dev/null

          cd "$IOS_DIR"

          # Build (no signing)
          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            build | tee xcodebuild.log

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"done\",\"log\":\"iOS: âœ… Xcode build complete\"}" >/dev/null

      - name: ðŸ“¦ Package iOS build artifacts (Step 7)
        shell: bash
        run: |
          set -e

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“¦ Packaging iOS build artifacts\"}" >/dev/null

          cd "$IOS_DIR"
          mkdir -p out

          # Grab the built .app from DerivedData
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -type d -name "*.app" | grep "/Release-iphoneos/" | head -n 1 || true)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Could not find built .app in DerivedData"
            exit 1
          fi
          echo "ðŸ“ APP_PATH=$APP_PATH"

          cp -R "$APP_PATH" out/

          # Zip artifact
          ARTIFACT_ZIP="ios-build-$BUILD_ID.zip"
          (cd out && ditto -c -k --sequesterRsrc --keepParent . "../$ARTIFACT_ZIP")

          echo "âœ… Created artifact zip: $IOS_DIR/$ARTIFACT_ZIP"
          ls -la "$IOS_DIR/$ARTIFACT_ZIP"

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"done\",\"log\":\"iOS: âœ… Artifact packaged\"}" >/dev/null

          echo "ARTIFACT_ZIP=$IOS_DIR/$ARTIFACT_ZIP" >> $GITHUB_ENV

      - name: â˜ï¸ Upload artifact to iOS Worker (PUT) + finalize (Step 8)
        shell: bash
        run: |
          set -e

          curl -sS -X PUT "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":8,\"step_state\":\"active\",\"log\":\"iOS: â˜ï¸ Uploading artifact\"}" >/dev/null

          # PUT binary artifact to Worker
          curl -fL -X PUT "https://novabridge-ios-build-worker.novabridge.workers.dev/upload-artifact-ios/$BUILD_ID" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            --data-binary @"$ARTIFACT_ZIP"

          # Tell Worker terminal success (and provide artifact_key for audit if you want)
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"step\":8,\"step_state\":\"done\",\"log\":\"iOS: âœ… Complete\"}" >/dev/null

      - name: âŒ On failure â€” callback failed (terminal)
        if: failure()
        shell: bash
        run: |
          set -e
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\",\"step\":8,\"step_state\":\"failed\",\"error\":\"GitHub Actions failed\",\"log\":\"iOS: âŒ Build failed\"}" >/dev/null || true
