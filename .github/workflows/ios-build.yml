name: NovaBridge iOS Cloud Build (v1.2)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}

    steps:
      - name: ðŸ§ª Validate payload
        shell: bash
        run: |
          set -e
          if [ -z "$BUILD_ID" ]; then echo "âŒ BUILD_ID missing"; exit 1; fi
          if [ -z "$ZIP_URL" ]; then echo "âŒ ZIP_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_URL" ]; then echo "âŒ CALLBACK_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_TOKEN" ]; then echo "âŒ CALLBACK_TOKEN missing"; exit 1; fi
          echo "âž¡ BUILD_ID=$BUILD_ID"
          echo "âž¡ ZIP_URL=$ZIP_URL"
          echo "âž¡ CALLBACK_URL=$CALLBACK_URL"
          echo "âž¡ CALLBACK_TOKEN_LENGTH=${#CALLBACK_TOKEN}"

      - name: ðŸ§© Callback helper
        shell: bash
        run: |
          set -e
          cat > cb.sh << 'EOF'
          cb() {
            local payload="$1"
            curl -sS -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              --data "$payload" || true
          }
          EOF

      - name: 3ï¸âƒ£ iOS: Downloading Project
        shell: bash
        run: |
          set -e
          source cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“¥ Downloading iOS project files\"}"

          curl -L "$ZIP_URL" -o ios.zip
          unzip -q ios.zip -d work

      - name: 4ï¸âƒ£ iOS: Xcode Project Ready (locate project)
        shell: bash
        run: |
          set -e
          source cb.sh

          XCODEPROJ=$(find work -name "*.xcodeproj" | head -n 1)
          if [ -z "$XCODEPROJ" ]; then
            cb "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"failed\",\"status\":\"failed\",\"error\":\"No Xcode project found\"}"
            echo "âŒ No Xcode project found"
            find work -maxdepth 5 -type d -print
            exit 1
          fi

          PROJ_DIR=$(dirname "$XCODEPROJ")
          PROJ_NAME=$(basename "$XCODEPROJ")
          SCHEME="${PROJ_NAME%.xcodeproj}"

          echo "ðŸ“‚ XCODEPROJ=$XCODEPROJ"
          echo "ðŸ“‚ PROJ_DIR=$PROJ_DIR"
          echo "ðŸŽ¯ SCHEME=$SCHEME"

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"done\",\"log\":\"iOS: âœ… Xcode project ready ($PROJ_NAME)\"}"

      - name: 5ï¸âƒ£ iOS: Queued on macOS Runner
        shell: bash
        run: |
          set -e
          source cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“± Queued on macOS runner\"}"

      - name: 6ï¸âƒ£ iOS: Building with Xcode
        shell: bash
        run: |
          set -e
          source cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: ðŸ”¨ Building iOS app with Xcode\"}"

          XCODEPROJ=$(find work -name "*.xcodeproj" | head -n 1)
          PROJ_DIR=$(dirname "$XCODEPROJ")
          PROJ_NAME=$(basename "$XCODEPROJ")
          SCHEME="${PROJ_NAME%.xcodeproj}"

          DERIVED="$RUNNER_TEMP/DerivedData-$BUILD_ID"
          mkdir -p "$DERIVED"

          cd "$PROJ_DIR"

          # Build (unsigned)
          xcodebuild \
            -project "$PROJ_NAME" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -derivedDataPath "$DERIVED" \
            CODE_SIGNING_ALLOWED=NO \
            build | tee "$RUNNER_TEMP/xcodebuild-$BUILD_ID.log"

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"done\",\"log\":\"iOS: âœ… Xcode build finished\"}"

      - name: 7ï¸âƒ£ iOS: Packaging iOS Build
        shell: bash
        run: |
          set -e
          source cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“¦ Packaging iOS build artifacts\"}"

          DERIVED="$RUNNER_TEMP/DerivedData-$BUILD_ID"
          APP_PATH=$(find "$DERIVED/Build/Products/Release-iphoneos" -maxdepth 2 -name "*.app" | head -n 1)

          if [ -z "$APP_PATH" ]; then
            cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"failed\",\"status\":\"failed\",\"error\":\"Build succeeded but .app not found\"}"
            echo "âŒ .app not found in derived data"
            find "$DERIVED/Build/Products" -maxdepth 4 -type d -print || true
            exit 1
          fi

          mkdir -p out
          cp -R "$APP_PATH" "out/"
          (cd out && zip -r "../ios-artifact-$BUILD_ID.zip" .)

          echo "âœ… Packaged: ios-artifact-$BUILD_ID.zip"

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"done\",\"log\":\"iOS: âœ… Packaged artifact zip\"}"

      - name: â˜ï¸ Upload artifact ZIP to Cloudflare R2
        shell: bash
        run: |
          set -e
          source cb.sh

          if ! command -v aws >/dev/null 2>&1; then
            echo "Installing awscli..."
            brew install awscli
          fi

          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
          export AWS_DEFAULT_REGION="auto"

          ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          KEY="ios/artifacts/${BUILD_ID}.zip"

          aws s3 cp "ios-artifact-$BUILD_ID.zip" "s3://${R2_BUCKET}/${KEY}" --endpoint-url "$ENDPOINT"

          cb "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"step\":8,\"step_state\":\"done\",\"artifact_key\":\"$KEY\",\"log\":\"iOS: âœ… Uploaded artifact to R2\"}"

      - name: ðŸ“Ž Upload xcodebuild log as GitHub artifact (debug)
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-log-${{ env.BUILD_ID }}
          path: ${{ runner.temp }}/xcodebuild-${{ env.BUILD_ID }}.log
