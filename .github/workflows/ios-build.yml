name: NovaBridge iOS Build (Generated Project)

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}
      ARTIFACT_UPLOAD_TOKEN: ${{ secrets.ARTIFACT_UPLOAD_TOKEN }}

    steps:
      # -------------------------
      # 0ï¸âƒ£ Validate payload + derive WORKER_BASE
      # -------------------------
      - name: Validate payload
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${BUILD_ID:-}" ] || [ -z "${ZIP_URL:-}" ] || [ -z "${CALLBACK_URL:-}" ]; then
            echo "âŒ Missing required payload values"
            echo "BUILD_ID=${BUILD_ID:-}"
            echo "ZIP_URL=${ZIP_URL:-}"
            echo "CALLBACK_URL=${CALLBACK_URL:-}"
            exit 1
          fi

          # Derive Worker base from callback URL (https://.../callback-ios -> https://...)
          WORKER_BASE="${CALLBACK_URL%/callback-ios}"
          echo "WORKER_BASE=$WORKER_BASE" >> "$GITHUB_ENV"
          echo "âœ… WORKER_BASE=$WORKER_BASE"

      # -------------------------
      # Helpers: callback + retry (FAILS if callback fails)
      # -------------------------
      - name: Define callback helpers
        shell: bash
        run: |
          set -euo pipefail
          cat > /tmp/nb_cb.sh <<'EOS'
          #!/usr/bin/env bash
          set -euo pipefail

          post_cb() {
            local payload="$1"
            curl --fail-with-body -sS -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" > /dev/null
          }

          cb_retry() {
            local payload="$1"
            local tries="${2:-6}"
            local delay="${3:-2}"
            local i=1
            while true; do
              if post_cb "$payload"; then
                return 0
              fi
              if [ "$i" -ge "$tries" ]; then
                echo "âŒ Callback failed after $tries attempts."
                echo "Payload: $payload"
                return 1
              fi
              echo "âš ï¸ Callback failed (attempt $i/$tries). Retrying in ${delay}s..."
              sleep "$delay"
              i=$((i+1))
            done
          }
          EOS
          chmod +x /tmp/nb_cb.sh

      # -------------------------
      # 3ï¸âƒ£ Download Project (ACTIVE -> DONE)
      # -------------------------
      - name: Download iOS ZIP
        shell: bash
        run: |
          set -euo pipefail
          source /tmp/nb_cb.sh

          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 3, \"step_state\": \"active\", \"log\": \"iOS: ğŸ“¥ Downloading project ZIP\" }"

          curl --fail-with-body -sS -L "$ZIP_URL" -o ios.zip
          unzip -q ios.zip -d work

          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 3, \"step_state\": \"done\", \"log\": \"iOS: âœ… Project ZIP downloaded + extracted\" }"

      # -------------------------
      # Install xcodegen
      # -------------------------
      - name: Install xcodegen
        shell: bash
        run: |
          set -euo pipefail
          brew install xcodegen

      # -------------------------
      # Locate iOS project directory
      # -------------------------
      - name: Locate iOS project directory
        shell: bash
        run: |
          set -euo pipefail
          IOS_DIR=$(find work/ios -maxdepth 2 -type d -name "*-iOS" | head -n 1)
          if [ -z "${IOS_DIR:-}" ]; then
            echo "âŒ No iOS project directory found"
            find work -maxdepth 4 -type d || true
            exit 1
          fi
          echo "IOS_DIR=$IOS_DIR" >> "$GITHUB_ENV"
          echo "âœ… IOS_DIR=$IOS_DIR"

      # -------------------------
      # 4ï¸âƒ£ Generate Xcode Project (ACTIVE -> DONE)
      # -------------------------
      - name: Generate Xcode project
        shell: bash
        run: |
          set -euo pipefail
          source /tmp/nb_cb.sh

          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 4, \"step_state\": \"active\", \"log\": \"iOS: ğŸ— Generating Xcode project (xcodegen)\" }"

          cd "$IOS_DIR"
          xcodegen generate

          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 4, \"step_state\": \"done\", \"log\": \"iOS: âœ… Xcode project generated\" }"

      # -------------------------
      # 5ï¸âƒ£ Queued on macOS Runner (DONE) + resolve target
      # -------------------------
      - name: Locate Xcode project and target
        shell: bash
        run: |
          set -euo pipefail
          source /tmp/nb_cb.sh

          XCODEPROJ=$(find "$IOS_DIR" -name "*.xcodeproj" | head -n 1)
          if [ -z "${XCODEPROJ:-}" ]; then
            echo "âŒ No Xcode project found"
            exit 1
          fi

          TARGET=$(xcodebuild -list -project "$XCODEPROJ" \
            | sed -n '/Targets:/,/Build Configurations:/p' \
            | sed '1d;$d' \
            | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
            | grep -v '^$' \
            | head -n 1)

          if [ -z "${TARGET:-}" ]; then
            echo "âŒ No target found"
            xcodebuild -list -project "$XCODEPROJ" || true
            exit 1
          fi

          echo "XCODEPROJ=$XCODEPROJ" >> "$GITHUB_ENV"
          echo "TARGET=$TARGET" >> "$GITHUB_ENV"
          echo "âœ… Using target: [$TARGET]"

          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 5, \"step_state\": \"done\", \"log\": \"iOS: ğŸ–¥ macOS runner ready â€¢ target resolved: $TARGET\" }"

      # -------------------------
      # 6ï¸âƒ£ Build with Xcode (ACTIVE -> DONE)
      # -------------------------
      - name: Build iOS app
        shell: bash
        run: |
          set -euo pipefail
          source /tmp/nb_cb.sh

          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 6, \"step_state\": \"active\", \"log\": \"iOS: ğŸ”¨ Building with Xcode\" }"

          xcodebuild \
            -project "$XCODEPROJ" \
            -target "$TARGET" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 6, \"step_state\": \"done\", \"log\": \"iOS: âœ… Xcode build completed\" }"

      # -------------------------
      # 7ï¸âƒ£ Package iOS Build (ACTIVE -> DONE)
      # -------------------------
      - name: Package iOS artifact
        shell: bash
        run: |
          set -euo pipefail
          source /tmp/nb_cb.sh

          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 7, \"step_state\": \"active\", \"log\": \"iOS: ğŸ“¦ Packaging iOS build\" }"

          cd work
          rm -f ios-artifact.zip
          zip -qr ios-artifact.zip .

          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 7, \"step_state\": \"done\", \"log\": \"iOS: âœ… Artifact packaged\" }"

      # -------------------------
      # 8ï¸âƒ£ Upload artifact + COMPLETE (DONE)
      # -------------------------
      - name: Upload artifact to Worker + Complete
        shell: bash
        run: |
          set -euo pipefail
          source /tmp/nb_cb.sh

          UPLOAD_TOKEN="${ARTIFACT_UPLOAD_TOKEN:-$CALLBACK_TOKEN}"

          echo "ğŸ“¤ Uploading artifact to: $WORKER_BASE/upload-artifact-ios/$BUILD_ID"
          curl --fail-with-body -sS -X PUT \
            -H "x-novabridge-token: $UPLOAD_TOKEN" \
            --data-binary @work/ios-artifact.zip \
            "$WORKER_BASE/upload-artifact-ios/$BUILD_ID" \
            > /tmp/upload_resp.json

          echo "âœ… Upload response:"
          cat /tmp/upload_resp.json || true

          # Mark step 8 done + success (guarantees UI flip)
          cb_retry "{ \"build_id\": \"$BUILD_ID\", \"step\": 8, \"step_state\": \"done\", \"status\": \"success\", \"log\": \"iOS: ğŸ‰ Build complete (artifact uploaded)\" }"

      # -------------------------
      # âŒ Failure handler
      # -------------------------
      - name: Failure callback
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"status\": \"failed\", \"log\": \"iOS: âŒ Build failed in GitHub Actions\" }" \
            || true
