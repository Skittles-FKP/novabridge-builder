name: NovaBridge iOS Build (Generated Project)

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: Validate payload + token
        shell: bash
        run: |
          set -euo pipefail
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"
          echo "‚û° CALLBACK_TOKEN_LENGTH=${#CALLBACK_TOKEN}"
          if [ -z "${BUILD_ID:-}" ] || [ -z "${ZIP_URL:-}" ] || [ -z "${CALLBACK_URL:-}" ]; then
            echo "‚ùå Missing payload values"
            exit 1
          fi
          if [ -z "${CALLBACK_TOKEN:-}" ]; then
            echo "‚ùå CALLBACK_TOKEN missing (must be GitHub Secret)"
            exit 1
          fi

      - name: Callback helper
        shell: bash
        run: |
          set -euo pipefail
          cat > cb.sh <<'EOF'
          cb () {
            local payload="$1"
            echo "‚û° cb payload: $payload"
            curl --fail-with-body -sS -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" >/dev/null
          }
          EOF
          chmod +x cb.sh

      - name: Step 3 - Download ZIP
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"active\",\"log\":\"iOS: üì• Downloading iOS project files\"}"

          curl -fL "$ZIP_URL" -o ios.zip
          unzip -q ios.zip -d work

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"done\",\"log\":\"iOS: ‚úÖ Project ZIP downloaded\"}"

      - name: Install xcodegen
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install xcodegen

      - name: Step 4 - Generate Xcode project
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"active\",\"log\":\"iOS: üèó Generating Xcode project\"}"

          PROJECT_YML=$(find work -name "project.yml" | head -n 1 || true)
          if [ -z "$PROJECT_YML" ]; then
            echo "‚ùå project.yml not found"
            find work -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          IOS_DIR=$(dirname "$PROJECT_YML")
          cd "$IOS_DIR"
          xcodegen generate

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"done\",\"log\":\"iOS: ‚úÖ Xcode project generated\"}"

      - name: Step 5 - Locate project + scheme
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"active\",\"log\":\"iOS: üì± Queued on macOS runner\"}"

          XCODEPROJ=$(find work -name "*.xcodeproj" | head -n 1 || true)
          if [ -z "$XCODEPROJ" ]; then
            echo "‚ùå No .xcodeproj found"
            find work -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          echo "XCODEPROJ=$XCODEPROJ" >> "$GITHUB_ENV"

          SCHEME=$(/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -list -project "$XCODEPROJ" \
            | sed -n '/Schemes:/,$p' | tail -n +2 | sed 's/^[[:space:]]*//' | head -n 1)

          if [ -z "${SCHEME:-}" ]; then
            echo "‚ùå No scheme found"
            /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -list -project "$XCODEPROJ"
            exit 1
          fi

          echo "SCHEME=$SCHEME" >> "$GITHUB_ENV"
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"done\",\"log\":\"iOS: ‚úÖ Scheme detected: $SCHEME\"}"

      - name: Step 6 - Build with Xcode (unsigned)
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: üî® Building with Xcode\"}"

          /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"done\",\"log\":\"iOS: ‚úÖ Xcode build completed\"}"

      - name: Step 7 - Package artifact zip
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"active\",\"log\":\"iOS: üì¶ Packaging iOS build\"}"
          cd work
          zip -qr ios-artifact.zip .
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"done\",\"log\":\"iOS: ‚úÖ iOS build packaged\"}"

      - name: Step 8 - Upload artifact to Worker (terminalize)
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh

          UPLOAD_URL="https://novabridge-ios-build-worker.novabridge.workers.dev/upload-artifact-ios/$BUILD_ID"
          echo "‚¨Ü Uploading: $UPLOAD_URL"

          curl --fail-with-body -sS -X PUT \
            -H "Content-Type: application/zip" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            --data-binary @work/ios-artifact.zip \
            "$UPLOAD_URL" >/dev/null

          cb "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"step\":8,\"step_state\":\"done\",\"artifact_key\":\"ios/artifacts/$BUILD_ID.zip\",\"log\":\"iOS: üéâ Complete\"}"

      - name: Failure callback
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\",\"log\":\"iOS: ‚ùå Build failed in GitHub Actions\"}" || true
