name: NovaBridge iOS Build v1.1.4

on:
  workflow_dispatch:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-14

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: Validate payload
        run: |
          set -euo pipefail
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"
          echo "‚û° CALLBACK_TOKEN_LENGTH=${#CALLBACK_TOKEN}"

          if [ -z "${BUILD_ID:-}" ] || [ -z "${ZIP_URL:-}" ] || [ -z "${CALLBACK_URL:-}" ]; then
            echo "‚ùå Missing required payload values"
            exit 1
          fi
          if [ -z "${CALLBACK_TOKEN:-}" ]; then
            echo "‚ùå CALLBACK_TOKEN missing"
            exit 1
          fi

      - name: Helper: callback function
        shell: bash
        run: |
          set -euo pipefail
          cat > cb.sh <<'SH'
          cb () {
            local payload="$1"
            echo "‚û° cb payload: $payload"
            curl -sS -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload"
          }
          SH
          chmod +x cb.sh

      - name: Step 3 active ‚Äî Downloading Project
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"active\",\"log\":\"iOS: üì• Downloading iOS project files\"}" || true

      - name: Download iOS ZIP
        run: |
          set -euo pipefail
          rm -rf work ios.zip
          mkdir -p work
          curl -fL "$ZIP_URL" -o ios.zip
          unzip -q ios.zip -d work

      - name: Locate iOS project directory
        run: |
          set -euo pipefail
          echo "üìÅ Listing work:"
          find work -maxdepth 4 -type f | head -n 100

          # Prefer work/ios/<Something-iOS>
          IOS_DIR=$(find work -type f -name "project.yml" -print0 | xargs -0 -n 1 dirname | head -n 1)

          if [ -z "${IOS_DIR:-}" ]; then
            echo "‚ùå project.yml not found anywhere under extracted ZIP"
            exit 1
          fi

          echo "üìÇ IOS_DIR=$IOS_DIR"
          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV

      - name: Install XcodeGen
        run: |
          set -euo pipefail
          brew update
          brew install xcodegen

      - name: Step 4 active ‚Äî Generating Xcode Project
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"active\",\"log\":\"iOS: üß± Generating Xcode project with XcodeGen\"}" || true

      - name: Generate Xcode project with XcodeGen
        run: |
          set -euo pipefail
          cd "$IOS_DIR"
          test -f project.yml
          xcodegen

          echo "üì¶ Xcode projects found:"
          ls -la *.xcodeproj || true

      - name: Generate minimal AppIcon (uses AppIcon-1024.png in IOS_DIR)
        run: |
          set -euo pipefail
          cd "$IOS_DIR"

          ICON_SRC="AppIcon-1024.png"
          ICONSET="App/Assets.xcassets/AppIcon.appiconset"

          if [ ! -f "$ICON_SRC" ]; then
            echo "‚ùå AppIcon-1024.png missing in $IOS_DIR"
            exit 1
          fi

          mkdir -p "$ICONSET"

          cat > "$ICONSET/Contents.json" <<'EOF'
          {
            "images": [
              { "idiom": "ios-marketing", "size": "1024x1024", "scale": "1x", "filename": "AppIcon-1024.png" }
            ],
            "info": { "version": 1, "author": "xcode" }
          }
          EOF

          # Don't fail if already identical
          cp -f "$ICON_SRC" "$ICONSET/AppIcon-1024.png" || true

      - name: Detect Xcode project + scheme (JSON-safe)
        run: |
          set -euo pipefail
          cd "$IOS_DIR"

          XCODEPROJ=$(ls -1 *.xcodeproj 2>/dev/null | head -n 1 || true)
          if [ -z "${XCODEPROJ:-}" ]; then
            echo "‚ùå No .xcodeproj found after xcodegen"
            exit 1
          fi

          echo "üì¶ XCODEPROJ=$XCODEPROJ"

          # Use xcodebuild -list -json for reliable parsing
          python3 - <<PY
import json, subprocess, sys
xcodeproj = "${XCODEPROJ}"
cmd = ["xcodebuild","-list","-json","-project", xcodeproj]
out = subprocess.check_output(cmd, text=True)
data = json.loads(out)
schemes = data.get("project", {}).get("schemes", []) or []
if not schemes:
    print("NO_SCHEME")
    sys.exit(0)
print(schemes[0])
PY
          SCHEME=$(python3 - <<PY
import json, subprocess
xcodeproj = "${XCODEPROJ}"
out = subprocess.check_output(["xcodebuild","-list","-json","-project", xcodeproj], text=True)
data = json.loads(out)
schemes = data.get("project", {}).get("schemes", []) or []
print(schemes[0] if schemes else "")
PY
          )

          if [ -z "${SCHEME:-}" ]; then
            echo "‚ùå No scheme found"
            echo "üßæ Raw list:"
            xcodebuild -list -project "$XCODEPROJ" || true
            exit 1
          fi

          echo "üéØ SCHEME=$SCHEME"

          echo "XCODEPROJ=$XCODEPROJ" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      - name: Step 5 active ‚Äî Queued on macOS Runner
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"active\",\"log\":\"iOS: üì± Queued on macOS runner\"}" || true

      - name: Step 6 active ‚Äî Building with Xcode
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: üî® Building iOS app with Xcode\"}" || true

      - name: Build iOS (no signing)
        run: |
          set -euo pipefail
          cd "$IOS_DIR"

          # Clean derived data for repeatability
          DERIVED="$RUNNER_TEMP/DerivedData"
          rm -rf "$DERIVED"
          mkdir -p "$DERIVED"

          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            -derivedDataPath "$DERIVED" \
            CODE_SIGNING_ALLOWED=NO \
            build | tee "$RUNNER_TEMP/xcodebuild.log"

      - name: Step 7 active ‚Äî Packaging iOS Build
        shell: bash
        run: |
          set -euo pipefail
          source ./cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"active\",\"log\":\"iOS: üì¶ Packaging iOS build artifacts\"}" || true

      - name: Package artifact zip
        run: |
          set -euo pipefail
          DERIVED="$RUNNER_TEMP/DerivedData"
          APP_PATH=$(find "$DERIVED" -type d -name "*.app" | head -n 1 || true)

          if [ -z "${APP_PATH:-}" ]; then
            echo "‚ùå Built .app not found"
            exit 1
          fi

          mkdir -p artifact
          cp -R "$APP_PATH" artifact/

          cd artifact
          zip -qr ios-build.zip .

      - name: Callback success (artifact base64 ‚Üí Worker R2)
        run: |
          set -euo pipefail
          source ./cb.sh
          cd artifact

          # base64 without newlines (portable)
          B64=$(base64 ios-build.zip | tr -d '\n')

          cb "{
            \"build_id\":\"$BUILD_ID\",
            \"status\":\"success\",
            \"step\":8,
            \"step_state\":\"done\",
            \"artifact_key\":\"ios/artifacts/$BUILD_ID.zip\",
            \"artifact_blob_b64\":\"$B64\",
            \"log\":\"‚úÖ iOS build completed successfully\"
          }"

      - name: Callback failure
        if: failure()
        run: |
          set -euo pipefail
          source ./cb.sh

          # Attach last ~200 lines of xcodebuild log if present
          TAIL=""
          if [ -f "$RUNNER_TEMP/xcodebuild.log" ]; then
            TAIL=$(tail -n 200 "$RUNNER_TEMP/xcodebuild.log" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          else
            TAIL="\"(no xcodebuild log found)\""
          fi

          cb "{
            \"build_id\":\"$BUILD_ID\",
            \"status\":\"failed\",
            \"step\":6,
            \"step_state\":\"failed\",
            \"error\":\"iOS build failed\",
            \"log\":\"‚ùå iOS build failed\",
            \"details\": $TAIL
          }" || true
