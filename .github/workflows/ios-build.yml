name: NovaBridge iOS Build

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      # ----------------------------
      # 0Ô∏è‚É£ Validate payload
      # ----------------------------
      - name: üîç Validate payload
        run: |
          set -e
          for v in BUILD_ID ZIP_URL CALLBACK_URL CALLBACK_TOKEN; do
            if [ -z "${!v}" ]; then
              echo "‚ùå Missing $v"
              exit 1
            fi
          done

      # ----------------------------
      # 1Ô∏è‚É£ Download ZIP
      # ----------------------------
      - name: üì¶ Download iOS project ZIP
        run: |
          set -e
          curl -fL "$ZIP_URL" -o ios.zip
          file ios.zip
          unzip ios.zip

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"done\",\"log\":\"iOS: üì• Project ZIP downloaded\"}"

      # ----------------------------
      # 2Ô∏è‚É£ Generate Xcode project
      # ----------------------------
      - name: üß© Generate Xcode project
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          brew install xcodegen
          xcodegen generate

          echo "üîç Searching for .xcodeproj..."
          PROJECT_PATH=$(find . -name "*.xcodeproj" | head -n 1)

          if [ -z "$PROJECT_PATH" ]; then
            echo "‚ùå No .xcodeproj generated by XcodeGen"
            find . -maxdepth 3
            exit 1
          fi

          echo "üìÅ Found project: $PROJECT_PATH"

          echo "$PROJECT_PATH" > /tmp/nb_project_path

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"done\",\"log\":\"iOS: üß© Xcode project generated\"}"

      # ----------------------------
      # 3Ô∏è‚É£ Build with Xcode
      # ----------------------------
      - name: üî® Build with Xcode
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          PROJECT_PATH=$(cat /tmp/nb_project_path)

          echo "üìÅ Using project: $PROJECT_PATH"

          echo "üîç Listing schemes..."
          xcodebuild -list -project "$PROJECT_PATH"

          SCHEME=$(xcodebuild -list -project "$PROJECT_PATH" \
            | awk '/Schemes:/ {found=1; next} found && NF {print; exit}')

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found in project"
            exit 1
          fi

          echo "üéØ Building scheme: $SCHEME"

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: üî® Building with Xcode ($SCHEME)\"}"

          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      # ----------------------------
      # 4Ô∏è‚É£ Package build
      # ----------------------------
      - name: üì¶ Package iOS build
        run: |
          set -e
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "‚ùå .app not found"
            exit 1
          fi

          mkdir -p artifact
          ditto "$APP_PATH" artifact/App.app
          zip -r ios-build.zip artifact

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"done\",\"log\":\"iOS: üì¶ Build packaged\"}"

      # ----------------------------
      # 5Ô∏è‚É£ Upload artifact
      # ----------------------------
      - name: ‚òÅÔ∏è Upload artifact to Worker
        run: |
          curl -X PUT "$CALLBACK_URL/../artifact-ios/$BUILD_ID" \
            -H "Content-Type: application/zip" \
            --data-binary @ios-build.zip

      # ----------------------------
      # 6Ô∏è‚É£ Final success callback
      # ----------------------------
      - name: ‚úÖ Notify success
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"log\":\"iOS: ‚úÖ Build completed successfully\"}"
