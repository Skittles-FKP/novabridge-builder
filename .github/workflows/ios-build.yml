name: NovaBridge iOS Build v1.1.4

on:
  workflow_dispatch:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-14

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      # ----------------------------
      # 1Ô∏è‚É£ Validate payload
      # ----------------------------
      - name: Validate payload
        run: |
          set -e
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"

          if [ -z "$BUILD_ID" ] || [ -z "$ZIP_URL" ] || [ -z "$CALLBACK_URL" ]; then
            echo "‚ùå Missing required payload values"
            exit 1
          fi

      # ----------------------------
      # 2Ô∏è‚É£ Download ZIP from Worker
      # ----------------------------
      - name: Download iOS ZIP
        run: |
          set -e
          curl -L "$ZIP_URL" -o ios.zip
          unzip ios.zip -d work

      # ----------------------------
      # 3Ô∏è‚É£ Locate iOS project folder
      # ----------------------------
      - name: Locate iOS project
        run: |
          set -e
          echo "üìÅ Contents of work/ios:"
          ls work/ios

          IOS_DIR=$(find work/ios -maxdepth 1 -type d -name "*-iOS" | head -n 1)
          if [ -z "$IOS_DIR" ]; then
            echo "‚ùå iOS project directory not found"
            exit 1
          fi

          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV

      # ----------------------------
      # 4Ô∏è‚É£ Install XcodeGen
      # ----------------------------
      - name: Install XcodeGen
        run: |
          set -e
          brew install xcodegen

      # ----------------------------
      # 5Ô∏è‚É£ Generate Xcode project
      # ----------------------------
      - name: Generate Xcode project
        run: |
          set -e
          cd "$IOS_DIR"

          if [ ! -f project.yml ]; then
            echo "‚ùå project.yml not found"
            exit 1
          fi

          xcodegen

      # ----------------------------
      # 6Ô∏è‚É£ Generate AppIcon.appiconset
      # ----------------------------
      - name: Generate App Icons
        run: |
          set -e
          cd "$IOS_DIR"

          ICON_SRC="AppIcon-1024.png"
          ICONSET="App/Assets.xcassets/AppIcon.appiconset"

          if [ ! -f "$ICON_SRC" ]; then
            echo "‚ùå AppIcon-1024.png missing"
            exit 1
          fi

          mkdir -p "$ICONSET"

          cat > "$ICONSET/Contents.json" <<EOF
          {
            "images": [
              { "idiom": "ios-marketing", "size": "1024x1024", "scale": "1x", "filename": "AppIcon-1024.png" }
            ],
            "info": { "version": 1, "author": "xcode" }
          }
          EOF

          cp "$ICON_SRC" "$ICONSET/AppIcon-1024.png"

      # ----------------------------
      # 7Ô∏è‚É£ Detect Xcode project & scheme
      # ----------------------------
      - name: Detect scheme
        run: |
          set -e
          cd "$IOS_DIR"

          XCODEPROJ=$(ls *.xcodeproj | head -n 1)
          if [ -z "$XCODEPROJ" ]; then
            echo "‚ùå No .xcodeproj found"
            exit 1
          fi

          SCHEME=$(xcodebuild -list -project "$XCODEPROJ" \
            | awk '/Schemes:/ {getline; print $1}')

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found"
            exit 1
          fi

          echo "XCODEPROJ=$XCODEPROJ" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      # ----------------------------
      # 8Ô∏è‚É£ Build iOS app (no signing)
      # ----------------------------
      - name: Build iOS app
        run: |
          set -e
          cd "$IOS_DIR"

          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      # ----------------------------
      # 9Ô∏è‚É£ Package build artifact
      # ----------------------------
      - name: Package iOS build
        run: |
          set -e
          cd "$IOS_DIR"

          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -type d -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Built .app not found"
            exit 1
          fi

          mkdir -p artifact
          cp -R "$APP_PATH" artifact/

          cd artifact
          zip -r ios-build.zip .

      # ----------------------------
      # üîü Callback success + artifact
      # ----------------------------
      - name: Callback success
        run: |
          set -e
          cd "$IOS_DIR/artifact"

          B64=$(base64 ios-build.zip)

          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{
              \"build_id\": \"$BUILD_ID\",
              \"status\": \"success\",
              \"step\": 8,
              \"step_state\": \"done\",
              \"artifact_key\": \"ios/artifacts/$BUILD_ID.zip\",
              \"artifact_blob_b64\": \"$B64\",
              \"log\": \"‚úÖ iOS build completed successfully\"
            }"

      # ----------------------------
      # ‚ùå Failure callback
      # ----------------------------
      - name: Callback failure
        if: failure()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{
              \"build_id\": \"$BUILD_ID\",
              \"status\": \"failed\",
              \"step\": 6,
              \"step_state\": \"failed\",
              \"error\": \"iOS build failed\"
            }"
