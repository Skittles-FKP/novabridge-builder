name: NovaBridge iOS Build

on:
  repository_dispatch:
    types:
      - novabridge_ios_build_v1

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      # ----- Payload from iOS Worker dispatch -----
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

      # ----- Cloudflare R2 -----
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_BUCKET: novabridge-builds

      # ----- Worker callback auth -----
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      # -------------------------------------------------
      # 1Ô∏è‚É£ Debug incoming dispatch payload
      # -------------------------------------------------
      - name: üß™ Print incoming dispatch payload
        run: |
          echo "===== CLIENT PAYLOAD ====="
          echo '${{ toJson(github.event.client_payload) }}'
          echo "=========================="
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      # -------------------------------------------------
      # 2Ô∏è‚É£ Validate required inputs (FAIL FAST)
      # -------------------------------------------------
      - name: ‚úÖ Validate inputs
        run: |
          if [ -z "$BUILD_ID" ]; then echo "‚ùå BUILD_ID missing"; exit 1; fi
          if [ -z "$ZIP_URL" ]; then echo "‚ùå ZIP_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_URL" ]; then echo "‚ùå CALLBACK_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_TOKEN" ]; then echo "‚ùå CALLBACK_TOKEN missing"; exit 1; fi
          echo "‚úÖ All required inputs present"

      # -------------------------------------------------
      # 3Ô∏è‚É£ Download ZIP generated by iOS Worker
      # -------------------------------------------------
      - name: üì¶ Download iOS project ZIP
        run: |
          curl -L "$ZIP_URL" -o ios.zip
          unzip ios.zip -d ios

          echo "üìÇ ZIP contents (preview)"
          ls -R ios | head -n 200

      # -------------------------------------------------
      # 4Ô∏è‚É£ Install XcodeGen
      # -------------------------------------------------
      - name: üîß Install XcodeGen
        run: |
          brew update
          brew install xcodegen

      # -------------------------------------------------
      # 5Ô∏è‚É£ Generate Xcode project
      # -------------------------------------------------
      - name: üß© Generate Xcode project
        run: |
          IOS_DIR=$(find ios -name project.yml | head -n 1 | xargs dirname)
          if [ -z "$IOS_DIR" ]; then
            echo "‚ùå project.yml not found"
            exit 1
          fi

          echo "üìÇ IOS_DIR=$IOS_DIR"
          cd "$IOS_DIR"

          xcodegen generate

          echo "üì¶ Generated Xcode projects:"
          find . -maxdepth 2 -name "*.xcodeproj" -print

      # -------------------------------------------------
      # 6Ô∏è‚É£ Build with xcodebuild (VERBOSE)
      # -------------------------------------------------
      - name: üî® Build iOS app with Xcode
        run: |
          IOS_DIR=$(find ios -name "*.xcodeproj" | head -n 1 | xargs dirname)
          PROJECT=$(find "$IOS_DIR" -name "*.xcodeproj" | head -n 1 | xargs basename)
          SCHEME="${PROJECT%.xcodeproj}"

          echo "üìÇ IOS_DIR=$IOS_DIR"
          echo "üì¶ PROJECT=$PROJECT"
          echo "üéØ SCHEME=$SCHEME"

          cd "$IOS_DIR"

          echo "üßæ Available schemes:"
          xcodebuild -list -project "$PROJECT"

          set -o pipefail
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build \
            | tee xcodebuild.log

      # -------------------------------------------------
      # 7Ô∏è‚É£ Upload build logs (ALWAYS)
      # -------------------------------------------------
      - name: üìé Upload xcodebuild.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-log-${{ env.BUILD_ID }}
          path: |
            ios/**/xcodebuild.log
            **/xcodebuild.log

      # -------------------------------------------------
      # 8Ô∏è‚É£ Package iOS build artifact
      # -------------------------------------------------
      - name: üì¶ Package iOS artifact
        if: success()
        run: |
          zip -r ios-artifact-$BUILD_ID.zip ios
          ls -lh ios-artifact-$BUILD_ID.zip

      # -------------------------------------------------
      # 9Ô∏è‚É£ Upload artifact to Cloudflare R2
      # -------------------------------------------------
      - name: ‚òÅÔ∏è Upload artifact to R2
        if: success()
        run: |
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region us-east-1

          aws s3 cp \
            ios-artifact-$BUILD_ID.zip \
            s3://$R2_BUCKET/ios/artifacts/$BUILD_ID.zip \
            --endpoint-url=https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com

      # -------------------------------------------------
      # üîü CALLBACK SUCCESS (PRINT HTTP RESPONSE)
      # -------------------------------------------------
      - name: üì° Callback success (print response)
        if: success()
        run: |
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ARTIFACT_KEY=ios/artifacts/$BUILD_ID.zip"

          curl -i -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifact_key\":\"ios/artifacts/$BUILD_ID.zip\"}"

      # -------------------------------------------------
      # üî¥ CALLBACK FAILURE (PRINT HTTP RESPONSE)
      # -------------------------------------------------
      - name: ‚ùå Callback failure (print response)
        if: failure()
        run: |
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"
          echo "‚û° BUILD_ID=$BUILD_ID"

          curl -i -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\"}"
