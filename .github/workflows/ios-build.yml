name: NovaBridge iOS Build (Generated Project)

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]
  workflow_dispatch:

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 30

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Validate payload
      # ------------------------------------------------------------
      - name: ‚úÖ Validate payload
        shell: bash
        run: |
          set -e
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"

          if [ -z "$BUILD_ID" ] || [ -z "$ZIP_URL" ] || [ -z "$CALLBACK_URL" ]; then
            echo "‚ùå Missing required payload values"
            exit 1
          fi

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Install xcodegen
      # ------------------------------------------------------------
      - name: üîß Install xcodegen
        shell: bash
        run: |
          set -e
          brew update
          brew install xcodegen

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Download build ZIP
      # ------------------------------------------------------------
      - name: üì• Download iOS build ZIP
        shell: bash
        run: |
          set -e
          curl -L "$ZIP_URL" -o ios.zip
          unzip ios.zip -d work

          echo "üìÅ Contents:"
          find work -maxdepth 5 -print

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Generate Xcode project
      # ------------------------------------------------------------
      - name: üèó Generate Xcode project
        shell: bash
        run: |
          set -e

          PROJECT_YML=$(find work -name "project.yml" | head -n 1)
          if [ -z "$PROJECT_YML" ]; then
            echo "‚ùå project.yml not found"
            find work -print
            exit 1
          fi

          IOS_DIR=$(dirname "$PROJECT_YML")
          echo "üìÅ Using iOS dir: $IOS_DIR"

          cd "$IOS_DIR"
          xcodegen generate

          echo "üì¶ Generated projects:"
          find . -name "*.xcodeproj" -print

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Locate project + scheme (FIXED)
      # ------------------------------------------------------------
      - name: üîé Locate Xcode project + scheme
        shell: bash
        run: |
          set -e

          XCODEPROJ=$(find work -name "*.xcodeproj" | head -n 1)
          if [ -z "$XCODEPROJ" ]; then
            echo "‚ùå No Xcode project found"
            find work -print
            exit 1
          fi

          echo "üì¶ XCODEPROJ=$XCODEPROJ"

          xcodebuild -list -project "$XCODEPROJ" | tee schemes.txt

          # ‚úÖ ROBUST scheme extraction (BSD awk safe)
          SCHEME=$(sed -n '/Schemes:/,$p' schemes.txt \
            | tail -n +2 \
            | sed 's/^[[:space:]]*//' \
            | sed '/^$/d' \
            | head -n 1)

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found (after parsing)"
            cat schemes.txt
            exit 1
          fi

          echo "üéØ SCHEME=$SCHEME"

          echo "XCODEPROJ=$XCODEPROJ" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Build iOS app (unsigned)
      # ------------------------------------------------------------
      - name: üî® Build iOS app
        shell: bash
        run: |
          set -e

          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      # ------------------------------------------------------------
      # 7Ô∏è‚É£ Package artifact
      # ------------------------------------------------------------
      - name: üì¶ Package iOS build artifact
        shell: bash
        run: |
          set -e

          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå .app not found"
            exit 1
          fi

          mkdir -p artifact
          cp -R "$APP_PATH" artifact/App.app
          cd artifact
          zip -r ios-build.zip App.app

      # ------------------------------------------------------------
      # 8Ô∏è‚É£ Upload artifact
      # ------------------------------------------------------------
      - name: ‚òÅÔ∏è Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ env.BUILD_ID }}
          path: artifact/ios-build.zip

      # ------------------------------------------------------------
      # 9Ô∏è‚É£ Callback SUCCESS
      # ------------------------------------------------------------
      - name: üîÅ Callback success
        shell: bash
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{
              \"build_id\": \"$BUILD_ID\",
              \"status\": \"success\",
              \"step\": 8,
              \"step_state\": \"done\",
              \"artifact_key\": \"ios/artifacts/$BUILD_ID.zip\"
            }"

      # ------------------------------------------------------------
      # ‚ùå Callback failure
      # ------------------------------------------------------------
      - name: ‚ùå Callback failure
        if: failure()
        shell: bash
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{
              \"build_id\": \"$BUILD_ID\",
              \"status\": \"failed\",
              \"step\": 6,
              \"step_state\": \"failed\",
              \"error\": \"GitHub Actions build failed\"
            }"
