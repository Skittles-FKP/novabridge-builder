name: NovaBridge iOS Build v1.1

on:
  repository_dispatch:
    types:
      - novabridge_ios_build_v1

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 60

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

      # R2
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_BUCKET: novabridge-builds

      # Optional TestFlight/App Store (Fastlane)
      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_P8_BASE64: ${{ secrets.ASC_KEY_P8_BASE64 }}

      # Optional code signing (if you decide to export IPA later)
      # IOS_DIST_P12_BASE64: ${{ secrets.IOS_DIST_P12_BASE64 }}
      # IOS_DIST_P12_PASSWORD: ${{ secrets.IOS_DIST_P12_PASSWORD }}
      # IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}

    steps:
      - name: üß™ Print incoming dispatch payload
        run: |
          echo '${{ toJson(github.event.client_payload) }}'
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: ‚úÖ Validate inputs
        run: |
          if [ -z "$BUILD_ID" ]; then echo "‚ùå BUILD_ID missing"; exit 1; fi
          if [ -z "$ZIP_URL" ]; then echo "‚ùå ZIP_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_URL" ]; then echo "‚ùå CALLBACK_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_TOKEN" ]; then echo "‚ùå CALLBACK_TOKEN missing"; exit 1; fi

      - name: üì° Callback helper (bash functions)
        shell: bash
        run: |
          cat << 'EOF' > cb.sh
          cb() {
            step="$1"
            step_state="$2"
            msg="$3"
            status="$4" # optional: success|failed
            extra="$5"  # optional: JSON fragment
            payload="{\"build_id\":\"$BUILD_ID\",\"step\":$step,\"step_state\":\"$step_state\",\"log\":\"$msg\""
            if [ -n "$status" ]; then payload="$payload, \"status\":\"$status\""; fi
            if [ -n "$extra" ]; then payload="$payload, $extra"; fi
            payload="$payload}"
            echo "‚û° cb payload: $payload"
            curl -i -sS -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload" | head -n 20
          }
          EOF

      # -------------------- Step 3 --------------------
      - name: üì• Download iOS project ZIP (Step 3)
        shell: bash
        run: |
          source cb.sh
          cb 3 active "iOS: üì• Downloading iOS project files" ""
          curl -L "$ZIP_URL" -o ios.zip
          unzip ios.zip -d ios
          cb 3 done "iOS: ‚úÖ Downloaded iOS project files" ""

      # -------------------- Step 4 --------------------
      - name: üîß Install XcodeGen (part of Step 4)
        run: |
          brew update
          brew install xcodegen

      - name: üß© Generate Xcode project (Step 4)
        shell: bash
        run: |
          source cb.sh
          cb 4 active "iOS: üß© Generating Xcode project" ""
          IOS_DIR=$(find ios -name project.yml | head -n 1 | xargs dirname)
          if [ -z "$IOS_DIR" ]; then
            cb 4 failed "iOS: ‚ùå project.yml not found" "failed" "\"error\":\"project.yml not found\""
            exit 1
          fi
          cd "$IOS_DIR"
          xcodegen generate
          cb 4 done "iOS: ‚úÖ Xcode project generated" ""

      # -------------------- Step 5 --------------------
      - name: üì± Queued on macOS runner (Step 5)
        shell: bash
        run: |
          source cb.sh
          cb 5 done "iOS: üì± Queued on macOS runner" ""

      # -------------------- Step 6 --------------------
      - name: üî® Build with Xcode (Step 6)
        shell: bash
        run: |
          source cb.sh
          cb 6 active "iOS: üî® Building iOS app with Xcode" ""

          IOS_DIR=$(find ios -name "*.xcodeproj" | head -n 1 | xargs dirname)
          PROJECT=$(find "$IOS_DIR" -name "*.xcodeproj" | head -n 1 | xargs basename)
          SCHEME="${PROJECT%.xcodeproj}"

          cd "$IOS_DIR"

          set -o pipefail
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build \
            | tee xcodebuild.log

          cb 6 done "iOS: ‚úÖ Xcode build complete" ""

      # -------------------- Step 7 --------------------
      - name: üì¶ Package iOS build artifact (Step 7)
        if: success()
        shell: bash
        run: |
          source cb.sh
          cb 7 active "iOS: üì¶ Packaging iOS build artifacts" ""
          zip -r ios-artifact-$BUILD_ID.zip ios
          cb 7 done "iOS: ‚úÖ Packaged iOS artifacts" ""

      # -------------------- Upload to R2 --------------------
      - name: ‚òÅÔ∏è Upload artifact to R2
        if: success()
        run: |
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region us-east-1

          aws s3 cp \
            ios-artifact-$BUILD_ID.zip \
            s3://$R2_BUCKET/ios/artifacts/$BUILD_ID.zip \
            --endpoint-url=https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com

      # -------------------- Step 8 (Complete) + callback success --------------------
      - name: ‚úÖ Callback success (Step 8)
        if: success()
        shell: bash
        run: |
          source cb.sh
          cb 8 done "iOS: ‚úÖ Complete" "success" "\"artifact_key\":\"ios/artifacts/$BUILD_ID.zip\""

      - name: ‚ùå Callback failure
        if: failure()
        shell: bash
        run: |
          source cb.sh
          cb 6 failed "iOS: ‚ùå Build failed" "failed" "\"error\":\"xcodebuild failed\""

      # -------------------- Step 9: TestFlight (optional hook) --------------------
      # NOTE: To truly upload to TestFlight you typically need a signed IPA.
      # This hook is provided; enable once signing/export is configured.
      - name: üì± TestFlight upload (Step 9) ‚Äî optional
        if: success() && env.ASC_KEY_ID != '' && env.ASC_ISSUER_ID != '' && env.ASC_KEY_P8_BASE64 != ''
        shell: bash
        run: |
          source cb.sh
          cb 9 active "iOS: üì± Preparing TestFlight upload (requires IPA signing/export)" ""
          # Placeholder: enable once you add archive+export IPA + fastlane pilot.
          cb 9 done "iOS: ‚úÖ TestFlight step configured (enable IPA export + pilot)" "" "\"testflight\":{\"enabled\":true,\"note\":\"Enable IPA export + fastlane pilot\"}"

      # -------------------- Step 10: App Store submission (optional hook) --------------------
      - name: üè¨ App Store submission (Step 10) ‚Äî optional
        if: success() && env.ASC_KEY_ID != '' && env.ASC_ISSUER_ID != '' && env.ASC_KEY_P8_BASE64 != ''
        shell: bash
        run: |
          source cb.sh
          cb 10 active "iOS: üè¨ App Store submission configured (requires metadata/screenshots + signed IPA)" ""
          cb 10 done "iOS: ‚úÖ App Store step configured" "" "\"appstore\":{\"enabled\":true,\"note\":\"Add fastlane deliver + metadata\"}"

      # -------------------- Upload xcodebuild.log always --------------------
      - name: üìé Upload xcodebuild.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-log-${{ env.BUILD_ID }}
          path: |
            **/xcodebuild.log
