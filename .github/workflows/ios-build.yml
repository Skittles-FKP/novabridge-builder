name: NovaBridge iOS Build (Generated Project)

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      # -------------------------
      # 0Ô∏è‚É£ Validate payload
      # -------------------------
      - name: Validate payload
        run: |
          set -euo pipefail
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"
          echo "‚û° CALLBACK_TOKEN_LENGTH=${#CALLBACK_TOKEN}"

          if [ -z "${BUILD_ID:-}" ] || [ -z "${ZIP_URL:-}" ] || [ -z "${CALLBACK_URL:-}" ]; then
            echo "‚ùå Missing required payload values"
            exit 1
          fi

          if [ -z "${CALLBACK_TOKEN:-}" ]; then
            echo "‚ùå CALLBACK_TOKEN secret is missing/empty"
            exit 1
          fi

      # -------------------------
      # Helper: callback function
      # -------------------------
      - name: Define callback helper
        shell: bash
        run: |
          cat > cb.sh << 'EOF'
          cb() {
            local payload="$1"
            echo "‚û° cb payload: $payload"
            curl -fsS -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              -d "$payload"
          }
          EOF

      # -------------------------
      # 1Ô∏è‚É£ Download ZIP
      # -------------------------
      - name: Download iOS ZIP
        shell: bash
        run: |
          set -euo pipefail
          source cb.sh

          curl -fsSL "$ZIP_URL" -o ios.zip
          unzip -q ios.zip -d work

          echo "üìÅ Listing extracted structure:"
          find work -maxdepth 4 -type d -print

          cb "{ \"build_id\": \"$BUILD_ID\", \"step\": 3, \"step_state\": \"done\", \"log\": \"iOS: üì• Project ZIP downloaded\" }"

      # -------------------------
      # 2Ô∏è‚É£ Install xcodegen
      # -------------------------
      - name: Install xcodegen
        run: |
          set -euo pipefail
          brew update
          brew install xcodegen

      # -------------------------
      # 3Ô∏è‚É£ Locate project folder + Generate Xcode project
      # -------------------------
      - name: Generate Xcode project
        shell: bash
        run: |
          set -euo pipefail
          source cb.sh

          # Find the folder that contains project.yml (created by Worker ZIP)
          PROJECT_YML="$(find work -name project.yml -print -quit)"
          if [ -z "$PROJECT_YML" ]; then
            echo "‚ùå project.yml not found"
            echo "üìÅ Debug listing:"
            find work -maxdepth 6 -type f -print
            exit 1
          fi

          IOS_DIR="$(dirname "$PROJECT_YML")"
          echo "üì¶ Found project.yml at: $PROJECT_YML"
          echo "üìÅ Using iOS project dir: $IOS_DIR"

          cd "$IOS_DIR"
          xcodegen generate

          cb "{ \"build_id\": \"$BUILD_ID\", \"step\": 4, \"step_state\": \"done\", \"log\": \"iOS: üèó Xcode project generated\" }"

      # -------------------------
      # 4Ô∏è‚É£ Locate project + scheme (handles spaces correctly)
      # -------------------------
      - name: Locate Xcode project and scheme
        id: locate
        shell: bash
        run: |
          set -euo pipefail
          source cb.sh

          XCODEPROJ="$(find work -name "*.xcodeproj" | head -n 1)"
          if [ -z "$XCODEPROJ" ]; then
            echo "‚ùå No Xcode project found"
            find work -maxdepth 6 -type f -print
            exit 1
          fi

          echo "üì¶ XCODEPROJ=$XCODEPROJ"
          echo "üîç Listing schemes..."
          xcodebuild -list -project "$XCODEPROJ"

          # ‚úÖ Grab the FIRST non-empty line AFTER "Schemes:" and trim whitespace
          SCHEME="$(
            xcodebuild -list -project "$XCODEPROJ" \
            | awk 'found && NF {print; exit} /^Schemes:/{found=1}' \
            | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
          )"

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found"
            exit 1
          fi

          echo "üéØ SCHEME=$SCHEME"

          echo "XCODEPROJ=$XCODEPROJ" >> "$GITHUB_ENV"
          echo "SCHEME=$SCHEME" >> "$GITHUB_ENV"

          cb "{ \"build_id\": \"$BUILD_ID\", \"step\": 5, \"step_state\": \"done\", \"log\": \"iOS: üì± Queued on macOS runner (scheme: $SCHEME)\" }"

      # -------------------------
      # 5Ô∏è‚É£ Build with Xcode
      # -------------------------
      - name: Build iOS app
        shell: bash
        run: |
          set -euo pipefail
          source cb.sh

          cb "{ \"build_id\": \"$BUILD_ID\", \"step\": 6, \"step_state\": \"active\", \"log\": \"iOS: üî® Building with Xcode\" }"

          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

          cb "{ \"build_id\": \"$BUILD_ID\", \"step\": 6, \"step_state\": \"done\", \"log\": \"iOS: ‚úÖ Build completed\" }"

      # -------------------------
      # 6Ô∏è‚É£ Package artifact
      # -------------------------
      - name: Package iOS artifact
        shell: bash
        run: |
          set -euo pipefail
          source cb.sh

          cd work
          zip -qr ios-artifact.zip .

          cb "{ \"build_id\": \"$BUILD_ID\", \"step\": 7, \"step_state\": \"done\", \"log\": \"iOS: üì¶ iOS build packaged\" }"

      # -------------------------
      # 7Ô∏è‚É£ Upload artifact + COMPLETE
      # -------------------------
      - name: Upload artifact to Worker
        shell: bash
        run: |
          set -euo pipefail
          source cb.sh

          curl -fsS -X PUT \
            --data-binary @work/ios-artifact.zip \
            "https://novabridge-ios-build-worker.novabridge.workers.dev/upload-artifact-ios/$BUILD_ID"

          cb "{ \"build_id\": \"$BUILD_ID\", \"status\": \"success\", \"artifact_key\": \"ios/artifacts/$BUILD_ID.zip\", \"log\": \"iOS: üéâ Build complete\" }"

      # -------------------------
      # ‚ùå Failure handler
      # -------------------------
      - name: Failure callback
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          source cb.sh || true

          # Best-effort callback; don't fail the failure handler
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"status\": \"failed\", \"log\": \"iOS: ‚ùå Build failed in GitHub Actions\" }" || true
