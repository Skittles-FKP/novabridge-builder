name: NovaBridge iOS Cloud Build (v1.2.1)

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - novabridge_ios_build_v1

jobs:
  ios-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}

    steps:
      - name: ðŸ§ª Validate payload
        shell: bash
        run: |
          set -e
          if [ -z "${BUILD_ID:-}" ]; then echo "âŒ BUILD_ID missing"; exit 1; fi
          if [ -z "${ZIP_URL:-}" ]; then echo "âŒ ZIP_URL missing"; exit 1; fi
          if [ -z "${CALLBACK_URL:-}" ]; then echo "âŒ CALLBACK_URL missing"; exit 1; fi
          if [ -z "${CALLBACK_TOKEN:-}" ]; then echo "âŒ CALLBACK_TOKEN missing"; exit 1; fi
          echo "âž¡ BUILD_ID=$BUILD_ID"
          echo "âž¡ ZIP_URL=$ZIP_URL"
          echo "âž¡ CALLBACK_URL=$CALLBACK_URL"
          echo "âž¡ CALLBACK_TOKEN_LENGTH=${#CALLBACK_TOKEN}"

      - name: ðŸ§© Create callback helper (cb)
        shell: bash
        run: |
          set -e
          cat > cb.sh <<'EOF'
          cb() {
            local payload="$1"
            curl -sS -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "x-novabridge-token: $CALLBACK_TOKEN" \
              --data "$payload" >/dev/null || true
          }
          EOF

      - name: 3ï¸âƒ£ Download project ZIP
        shell: bash
        run: |
          set -e
          source cb.sh

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“¥ Downloading iOS project files\"}"

          rm -rf work ios.zip || true
          curl -L "$ZIP_URL" -o ios.zip

          # Fail early if ZIP is not valid (your earlier issue was downloading a 401 JSON body)
          if ! unzip -t ios.zip >/dev/null 2>&1; then
            echo "âŒ Downloaded file is not a valid zip"
            cb "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"failed\",\"status\":\"failed\",\"error\":\"ZIP download invalid (not a zip)\"}"
            exit 1
          fi

          unzip -q ios.zip -d work

      - name: 4ï¸âƒ£ Locate Xcode project + scheme
        shell: bash
        run: |
          set -e
          source cb.sh

          XCODEPROJ="$(find work -name '*.xcodeproj' | head -n 1 || true)"
          if [ -z "$XCODEPROJ" ]; then
            echo "âŒ No Xcode project found"
            cb "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"failed\",\"status\":\"failed\",\"error\":\"No Xcode project found\"}"
            find work -maxdepth 6 -type d -print || true
            exit 1
          fi

          PROJ_DIR="$(dirname "$XCODEPROJ")"
          PROJ_NAME="$(basename "$XCODEPROJ")"
          SCHEME="${PROJ_NAME%.xcodeproj}"

          echo "ðŸ“‚ XCODEPROJ=$XCODEPROJ"
          echo "ðŸ“‚ PROJ_DIR=$PROJ_DIR"
          echo "ðŸŽ¯ SCHEME=$SCHEME"

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"done\",\"log\":\"iOS: âœ… Xcode project ready ($PROJ_NAME)\"}"

          # Persist for later steps
          echo "$PROJ_DIR" > "$RUNNER_TEMP/PROJ_DIR.txt"
          echo "$PROJ_NAME" > "$RUNNER_TEMP/PROJ_NAME.txt"
          echo "$SCHEME"   > "$RUNNER_TEMP/SCHEME.txt"

      - name: 5ï¸âƒ£ Runner queue
        shell: bash
        run: |
          set -e
          source cb.sh
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“± Queued on macOS runner\"}"
          cb "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"done\",\"log\":\"iOS: âœ… Runner executing\"}"

      - name: 6ï¸âƒ£ Build with Xcode (unsigned)
        shell: bash
        run: |
          set -e
          source cb.sh

          PROJ_DIR="$(cat "$RUNNER_TEMP/PROJ_DIR.txt")"
          PROJ_NAME="$(cat "$RUNNER_TEMP/PROJ_NAME.txt")"
          SCHEME="$(cat "$RUNNER_TEMP/SCHEME.txt")"

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: ðŸ”¨ Building iOS app with Xcode\"}"

          DERIVED="$RUNNER_TEMP/DerivedData-$BUILD_ID"
          mkdir -p "$DERIVED"

          cd "$PROJ_DIR"

          # Build (unsigned)
          xcodebuild \
            -project "$PROJ_NAME" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -derivedDataPath "$DERIVED" \
            CODE_SIGNING_ALLOWED=NO \
            build | tee "$RUNNER_TEMP/xcodebuild-$BUILD_ID.log"

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"done\",\"log\":\"iOS: âœ… Xcode build finished\"}"

      - name: 7ï¸âƒ£ Package artifact zip
        shell: bash
        run: |
          set -e
          source cb.sh

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"active\",\"log\":\"iOS: ðŸ“¦ Packaging iOS build artifacts\"}"

          DERIVED="$RUNNER_TEMP/DerivedData-$BUILD_ID"
          APP_PATH="$(find "$DERIVED/Build/Products/Release-iphoneos" -maxdepth 3 -name '*.app' | head -n 1 || true)"

          if [ -z "$APP_PATH" ]; then
            echo "âŒ .app not found"
            cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"failed\",\"status\":\"failed\",\"error\":\"Build succeeded but .app not found\"}"
            find "$DERIVED/Build/Products" -maxdepth 5 -type d -print || true
            exit 1
          fi

          rm -rf out "ios-artifact-$BUILD_ID.zip" || true
          mkdir -p out
          cp -R "$APP_PATH" out/

          (cd out && zip -r "../ios-artifact-$BUILD_ID.zip" . >/dev/null)

          cb "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"done\",\"log\":\"iOS: âœ… Packaged artifact zip\"}"

      - name: â˜ï¸ Upload artifact to Cloudflare R2
        shell: bash
        run: |
          set -e
          source cb.sh

          if ! command -v aws >/dev/null 2>&1; then
            echo "Installing awscli..."
            brew install awscli
          fi

          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
          export AWS_DEFAULT_REGION="auto"

          ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          KEY="ios/artifacts/${BUILD_ID}.zip"

          aws s3 cp "ios-artifact-$BUILD_ID.zip" "s3://${R2_BUCKET}/${KEY}" --endpoint-url "$ENDPOINT"

          # Final callback (marks terminal in worker, enables download in UI)
          cb "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"step\":8,\"step_state\":\"done\",\"artifact_key\":\"$KEY\",\"log\":\"iOS: âœ… Uploaded artifact to R2\"}"

      - name: ðŸ“Ž Upload xcodebuild log (debug artifact)
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-log-${{ github.event.client_payload.build_id }}
          path: ${{ runner.temp }}/xcodebuild-${{ github.event.client_payload.build_id }}.log
