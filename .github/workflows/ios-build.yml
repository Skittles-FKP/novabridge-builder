name: NovaBridge iOS Build

on:
  repository_dispatch:
    types: [novabridge_ios_build_v1]

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}

      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_BUCKET: novabridge-builds
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      - name: üì¶ Download iOS ZIP
        run: |
          curl -L "$ZIP_URL" -o ios.zip
          unzip ios.zip -d ios

      - name: üîß Install XcodeGen
        run: |
          brew install xcodegen

      - name: üèó Generate Xcode project
        run: |
          IOS_DIR=$(find ios -name project.yml | head -n 1 | xargs dirname)
          cd "$IOS_DIR"
          xcodegen generate

      - name: üèó Build iOS app (unsigned)
        run: |
          IOS_DIR=$(find ios -name "*.xcodeproj" | head -n 1 | xargs dirname)
          PROJECT=$(find "$IOS_DIR" -name "*.xcodeproj" | head -n 1 | xargs basename)
          SCHEME="${PROJECT%.xcodeproj}"
          cd "$IOS_DIR"
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -destination generic/platform=iOS \
            build \
            CODE_SIGNING_ALLOWED=NO

      - name: üì¶ Package build output
        run: |
          zip -r ios-artifact-$BUILD_ID.zip ios

      - name: ‚òÅÔ∏è Upload artifact to R2
        run: |
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region us-east-1
          aws s3 cp ios-artifact-$BUILD_ID.zip \
            s3://$R2_BUCKET/ios/artifacts/$BUILD_ID.zip \
            --endpoint-url=https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com

      - name: üì° Callback success
        if: success()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifact_key\":\"ios/artifacts/$BUILD_ID.zip\"}"

      - name: ‚ùå Callback failure
        if: failure()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\"}"
