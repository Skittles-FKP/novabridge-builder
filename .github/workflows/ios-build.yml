name: NovaBridge iOS Build (STABLE)

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - novabridge_ios_build_v1

jobs:
  ios-build:
    runs-on: macos-14

    steps:
      - name: Extract payload
        run: |
          echo "BUILD_ID=${{ github.event.client_payload.build_id }}"
          echo "ZIP_URL=${{ github.event.client_payload.zip_url }}"
          echo "CALLBACK_URL=${{ github.event.client_payload.callback_url }}"
          echo "CALLBACK_TOKEN_PRESENT=${{ secrets.CALLBACK_TOKEN != '' }}"

      - name: Validate inputs (no silent failure)
        run: |
          set -e

          BUILD_ID="${{ github.event.client_payload.build_id }}"
          ZIP_URL="${{ github.event.client_payload.zip_url }}"
          CALLBACK_URL="${{ github.event.client_payload.callback_url }}"
          CALLBACK_TOKEN="${{ secrets.CALLBACK_TOKEN }}"

          if [ -z "$BUILD_ID" ]; then
            echo "‚ùå BUILD_ID missing"
            exit 1
          fi

          if [ -z "$ZIP_URL" ]; then
            echo "‚ùå ZIP_URL missing from repository_dispatch payload"
            exit 1
          fi

          if [ -z "$CALLBACK_URL" ]; then
            echo "‚ùå CALLBACK_URL missing"
            exit 1
          fi

          if [ -z "$CALLBACK_TOKEN" ]; then
            echo "‚ùå CALLBACK_TOKEN missing (check repo secrets)"
            exit 1
          fi

          echo "‚úÖ Inputs validated"

      - name: Download iOS project ZIP
        run: |
          set -e
          echo "‚¨áÔ∏è Downloading ZIP from: ${{ github.event.client_payload.zip_url }}"
          curl -fL "${{ github.event.client_payload.zip_url }}" -o ios.zip
          unzip -q ios.zip

      - name: Generate Xcode project
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS
          brew install xcodegen || true
          xcodegen generate --spec project.yml
          ls -la

      - name: Build with Xcode
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          PROJECT=$(ls *.xcodeproj | head -n 1)
          if [ -z "$PROJECT" ]; then
            echo "‚ùå No .xcodeproj found"
            exit 1
          fi

          SCHEME=$(xcodebuild -list -project "$PROJECT" \
            | sed -n '/Schemes:/,$p' | tail -n +2 | head -n 1 | xargs)

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found"
            exit 1
          fi

          echo "üì¶ Project: $PROJECT"
          echo "üéØ Scheme: $SCHEME"

          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Package build
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS
          zip -qr ios-artifact.zip .

      - name: Upload artifact to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          set -e
          brew install awscli || true
          aws s3 cp ios/NovaBridgeDemo-iOS/ios-artifact.zip \
            s3://${{ secrets.R2_BUCKET }}/ios/artifacts/${{ github.event.client_payload.build_id }}.zip \
            --endpoint-url https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com

      - name: Callback SUCCESS
        if: success()
        run: |
          curl -sS -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{\"build_id\":\"${{ github.event.client_payload.build_id }}\",\"status\":\"success\",\"artifact_key\":\"ios/artifacts/${{ github.event.client_payload.build_id }}.zip\"}"

      - name: Callback FAILED
        if: failure()
        run: |
          curl -sS -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{\"build_id\":\"${{ github.event.client_payload.build_id }}\",\"status\":\"failed\"}"
