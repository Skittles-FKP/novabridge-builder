name: NovaBridge iOS Build v1.1.1 (R2)

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - novabridge_ios_build_v1

jobs:
  ios-build:
    runs-on: macos-14

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

      # R2 (same idea as Android pipeline)
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}

      # Where we store iOS artifacts in R2
      ARTIFACT_KEY: ios/artifacts/${{ github.event.client_payload.build_id }}.zip

    steps:
      - name: Validate payload + secrets
        shell: bash
        run: |
          set -e
          for v in BUILD_ID ZIP_URL CALLBACK_URL CALLBACK_TOKEN R2_ACCESS_KEY_ID R2_SECRET_ACCESS_KEY R2_BUCKET R2_ACCOUNT_ID; do
            if [ -z "${!v:-}" ]; then echo "‚ùå $v missing"; exit 1; fi
          done
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"
          echo "‚û° ARTIFACT_KEY=$ARTIFACT_KEY"

      # ----------------------------
      # Step 3: Downloading Project
      # ----------------------------
      - name: Download iOS project ZIP
        shell: bash
        run: |
          set -e
          curl -L "$ZIP_URL" -o ios.zip
          unzip -q ios.zip

      - name: Callback - Step 3 done
        shell: bash
        run: |
          set -e
          python3 - <<'PY'
          import json, os, subprocess
          payload = {"build_id": os.environ["BUILD_ID"], "step": 3, "step_state": "done", "log": "iOS: üì• Downloaded project"}
          subprocess.check_call([
            "curl","-sS","-X","POST", os.environ["CALLBACK_URL"],
            "-H","Content-Type: application/json",
            "-H", f"x-novabridge-token: {os.environ['CALLBACK_TOKEN']}",
            "-d", json.dumps(payload)
          ])
          PY

      # ----------------------------
      # Step 4: Generating Xcode Project
      # ----------------------------
      - name: Generate Xcode project (xcodegen)
        shell: bash
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS
          brew install xcodegen || true
          xcodegen

      - name: Callback - Step 4 done
        shell: bash
        run: |
          set -e
          python3 - <<'PY'
          import json, os, subprocess
          payload = {"build_id": os.environ["BUILD_ID"], "step": 4, "step_state": "done", "log": "iOS: üß© Xcode project generated"}
          subprocess.check_call([
            "curl","-sS","-X","POST", os.environ["CALLBACK_URL"],
            "-H","Content-Type: application/json",
            "-H", f"x-novabridge-token: {os.environ['CALLBACK_TOKEN']}",
            "-d", json.dumps(payload)
          ])
          PY

      # ----------------------------
      # Step 5: Queued on macOS Runner
      # (We mark it done immediately since we're already running)
      # ----------------------------
      - name: Callback - Step 5 done (runner started)
        shell: bash
        run: |
          set -e
          python3 - <<'PY'
          import json, os, subprocess
          payload = {"build_id": os.environ["BUILD_ID"], "step": 5, "step_state": "done", "log": "iOS: üì± Runner started"}
          subprocess.check_call([
            "curl","-sS","-X","POST", os.environ["CALLBACK_URL"],
            "-H","Content-Type: application/json",
            "-H", f"x-novabridge-token: {os.environ['CALLBACK_TOKEN']}",
            "-d", json.dumps(payload)
          ])
          PY

      # ----------------------------
      # Step 6: Building with Xcode
      # ----------------------------
      - name: Build with Xcode (unsigned)
        shell: bash
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          PROJECT="$(ls -1 *.xcodeproj 2>/dev/null | head -n 1 || true)"
          if [ -z "$PROJECT" ]; then
            echo "‚ùå No Xcode project found"
            exit 1
          fi

          SCHEME="$(xcodebuild -list -project "$PROJECT" | sed -n '/Schemes:/,$p' | tail -n +2 | head -n 1 | xargs)"
          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found"
            exit 1
          fi

          echo "PROJECT=$PROJECT"
          echo "SCHEME=$SCHEME"

          # Build unsigned
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Callback - Step 6 done
        shell: bash
        run: |
          set -e
          python3 - <<'PY'
          import json, os, subprocess
          payload = {"build_id": os.environ["BUILD_ID"], "step": 6, "step_state": "done", "log": "iOS: üî® Xcode build completed"}
          subprocess.check_call([
            "curl","-sS","-X","POST", os.environ["CALLBACK_URL"],
            "-H","Content-Type: application/json",
            "-H", f"x-novabridge-token: {os.environ['CALLBACK_TOKEN']}",
            "-d", json.dumps(payload)
          ])
          PY

      # ----------------------------
      # Step 7: Packaging iOS Build
      # ----------------------------
      - name: Package iOS build artifact
        shell: bash
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS
          mkdir -p output
          if [ -d build ]; then cp -R build output/; fi
          zip -qr ios-artifact.zip output
          ls -lh ios-artifact.zip

      - name: Callback - Step 7 done
        shell: bash
        run: |
          set -e
          python3 - <<'PY'
          import json, os, subprocess
          payload = {"build_id": os.environ["BUILD_ID"], "step": 7, "step_state": "done", "log": "iOS: üì¶ Build packaged"}
          subprocess.check_call([
            "curl","-sS","-X","POST", os.environ["CALLBACK_URL"],
            "-H","Content-Type: application/json",
            "-H", f"x-novabridge-token: {os.environ['CALLBACK_TOKEN']}",
            "-d", json.dumps(payload)
          ])
          PY

      # ----------------------------
      # Upload to Cloudflare R2
      # ----------------------------
      - name: Install AWS CLI
        shell: bash
        run: |
          set -e
          brew install awscli || true
          aws --version

      - name: Upload artifact to R2
        shell: bash
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
          export AWS_DEFAULT_REGION="auto"

          ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"

          # Upload as ios/artifacts/<BUILD_ID>.zip
          aws s3 cp "ios-artifact.zip" "s3://${R2_BUCKET}/${ARTIFACT_KEY}" \
            --endpoint-url "$ENDPOINT" \
            --no-progress

          echo "‚úÖ Uploaded to R2: s3://${R2_BUCKET}/${ARTIFACT_KEY}"

      # ----------------------------
      # Step 8: Complete (terminal)
      # ----------------------------
      - name: Final callback (SUCCESS + artifact_key)
        shell: bash
        run: |
          set -e
          python3 - <<'PY'
          import json, os, subprocess
          payload = {
            "build_id": os.environ["BUILD_ID"],
            "status": "success",
            "step": 8,
            "step_state": "done",
            "artifact_key": os.environ["ARTIFACT_KEY"],
            "log": "iOS: ‚úÖ Build complete (artifact uploaded)"
          }
          subprocess.check_call([
            "curl","-sS","-X","POST", os.environ["CALLBACK_URL"],
            "-H","Content-Type: application/json",
            "-H", f"x-novabridge-token: {os.environ['CALLBACK_TOKEN']}",
            "-d", json.dumps(payload)
          ])
          PY

      # ----------------------------
      # Failure handler (terminal fail)
      # ----------------------------
      - name: Final callback (FAILED)
        if: failure()
        shell: bash
        run: |
          set -e
          python3 - <<'PY'
          import json, os, subprocess
          payload = {
            "build_id": os.environ["BUILD_ID"],
            "status": "failed",
            "step": 8,
            "step_state": "failed",
            "error": "GitHub Actions iOS workflow failed",
            "log": "iOS: ‚ùå Workflow failed"
          }
          subprocess.call([
            "curl","-sS","-X","POST", os.environ["CALLBACK_URL"],
            "-H","Content-Type: application/json",
            "-H", f"x-novabridge-token: {os.environ['CALLBACK_TOKEN']}",
            "-d", json.dumps(payload)
          ])
          PY
