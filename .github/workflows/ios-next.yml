name: NovaBridge iOS NEXT Build

on:
  repository_dispatch:
    types:
      - novabridge_ios_build_next
  workflow_dispatch:

jobs:
  ios-next-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      RAW_PLUGINS: ${{ toJson(github.event.client_payload.plugins) }}

    steps:
      # ------------------------------------------------------------
      # 0Ô∏è‚É£ Checkout
      # ------------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Download iOS ZIP
      # ------------------------------------------------------------
      - name: Download iOS ZIP
        run: |
          set -e
          mkdir -p work
          curl -L "$ZIP_URL" -o work/app.zip
          unzip -q work/app.zip -d work/app

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 3, \"step_state\": \"done\", \"log\": \"iOS NEXT: ZIP downloaded\" }"

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Locate iOS project directory
      # ------------------------------------------------------------
      - name: Locate iOS project
        run: |
          set -e
          IOS_DIR=$(find work/app -name Info.plist | head -n 1 | xargs dirname)
          if [ -z "$IOS_DIR" ]; then
            echo "‚ùå No iOS project directory found"
            exit 1
          fi
          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Install iOS plugin injector
      # ------------------------------------------------------------
      - name: Install iOS plugin injector
        run: |
          set -e
          cd tools/ios-plugins
          npm ci
          npx tsc
          cd -

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Apply iOS plugins
      # ------------------------------------------------------------
      - name: Apply iOS plugins
        run: |
          set -e

          PLUGINS_JSON="$RAW_PLUGINS"
          if [ -z "$PLUGINS_JSON" ] || [ "$PLUGINS_JSON" = "null" ]; then
            PLUGINS_JSON="{}"
          fi

          echo "üîå Applying iOS plugins: $PLUGINS_JSON"

          if [ ! -f "$IOS_DIR/App.entitlements" ]; then
            echo '<?xml version="1.0" encoding="UTF-8"?>' > "$IOS_DIR/App.entitlements"
            echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$IOS_DIR/App.entitlements"
            echo '<plist version="1.0"><dict></dict></plist>' >> "$IOS_DIR/App.entitlements"
          fi

          node tools/ios-plugins/dist/injectIosPlugins.js \
            --infoPlist "$IOS_DIR/Info.plist" \
            --entitlements "$IOS_DIR/App.entitlements" \
            --plugins "$PLUGINS_JSON"

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 4, \"step_state\": \"done\", \"log\": \"iOS NEXT: Plugins applied\" }"

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Generate Xcode project (conditional)
      # ------------------------------------------------------------
      - name: Prepare Xcode project
        run: |
          set -e
          cd "$IOS_DIR"

          if [ -f "project.yml" ]; then
            echo "üß© project.yml found ‚Äî running XcodeGen"
            brew install xcodegen
            xcodegen
          else
            echo "‚ÑπÔ∏è No project.yml found ‚Äî using existing Xcode project"
          fi

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 5, \"step_state\": \"done\", \"log\": \"iOS NEXT: Xcode project ready\" }"

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Resolve Xcode target
      # ------------------------------------------------------------
      - name: Resolve Xcode target
        run: |
          set -e
          cd "$IOS_DIR"
          TARGET=$(xcodebuild -list -json | jq -r '.project.targets[0]')
          echo "XCODE_TARGET=$TARGET" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 7Ô∏è‚É£ Build with Xcode (unsigned)
      # ------------------------------------------------------------
      - name: Build with Xcode
        run: |
          set -e
          cd "$IOS_DIR"
          xcodebuild \
            -project *.xcodeproj \
            -scheme "$XCODE_TARGET" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            build

          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{ \"build_id\": \"$BUILD_ID\", \"step\": 6, \"step_state\": \"done\", \"log\": \"iOS NEXT: Build completed\" }"

      # ------------------------------------------------------------
      # 8Ô∏è‚É£ Package artifact
      # ------------------------------------------------------------
      - name: Package iOS artifact
        run: |
          set -e
          cd work
          zip -r ios-build.zip app

      # ------------------------------------------------------------
      # 9Ô∏è‚É£ Upload artifact
      # ------------------------------------------------------------
      - name: Upload artifact
        run: |
          set -e
          curl -X POST "$CALLBACK_URL/upload-ios-zip/$BUILD_ID" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            --data-binary "@work/ios-build.zip"

      # ------------------------------------------------------------
      # ‚úÖ Done
      # ------------------------------------------------------------
      - name: Done
        run: echo "‚úÖ iOS NEXT build completed successfully"
