name: NovaBridge iOS NEXT Cloud Build

on:
  repository_dispatch:
    types:
      - novabridge_ios_build_next
  workflow_dispatch:

jobs:
  ios-next-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      # Plugins JSON passed through from UI / worker (safe default)
      PLUGINS_JSON: ${{ github.event.client_payload.plugins || '{}' }}

    steps:
      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Download iOS ZIP from Worker
      # ------------------------------------------------------------
      - name: Download iOS ZIP
        run: |
          set -e
          mkdir -p work
          curl -L "$ZIP_URL" -o work/source.zip

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Extract ZIP
      # ------------------------------------------------------------
      - name: Extract iOS ZIP
        run: |
          set -e
          unzip -q work/source.zip -d work/app

      # ------------------------------------------------------------
      # üß© NEW ‚Äî Apply iOS Plugins (Info.plist + Entitlements)
      # ------------------------------------------------------------
      - name: Apply iOS plugins (NEXT only)
        run: |
          set -e
          echo "üîå Applying iOS plugins: $PLUGINS_JSON"

          # Ensure entitlements file exists
          if [ ! -f work/app/App/App.entitlements ]; then
            echo '<?xml version="1.0" encoding="UTF-8"?>' > work/app/App/App.entitlements
            echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> work/app/App/App.entitlements
            echo '<plist version="1.0"><dict></dict></plist>' >> work/app/App/App.entitlements
          fi

          node tools/ios-plugins/injectIosPlugins.js \
            --infoPlist work/app/App/Info.plist \
            --entitlements work/app/App/App.entitlements \
            --plugins "$PLUGINS_JSON"

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Install XcodeGen
      # ------------------------------------------------------------
      - name: Install XcodeGen
        run: |
          brew install xcodegen

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Generate Xcode Project
      # ------------------------------------------------------------
      - name: Generate Xcode project
        run: |
          set -e
          cd work/app
          xcodegen generate

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Build with Xcode
      # ------------------------------------------------------------
      - name: Build iOS app
        run: |
          set -e
          cd work/app
          xcodebuild \
            -project *.xcodeproj \
            -scheme * \
            -configuration Release \
            -sdk iphoneos \
            build \
            CODE_SIGNING_ALLOWED=NO

      # ------------------------------------------------------------
      # 7Ô∏è‚É£ Package iOS Artifact ZIP
      # ------------------------------------------------------------
      - name: Package iOS artifact
        run: |
          set -e
          cd work
          zip -qr ios-artifact.zip app
          echo "üì¶ iOS NEXT artifact packaged"

      # ------------------------------------------------------------
      # 8Ô∏è‚É£ Upload ZIP back to iOS NEXT Worker (R2)
      # ------------------------------------------------------------
      - name: Upload iOS artifact to NEXT worker
        run: |
          set -e
          curl -sS -X PUT \
            -H "x-novabridge-token: ${{ secrets.ARTIFACT_UPLOAD_TOKEN || secrets.CALLBACK_TOKEN }}" \
            --data-binary @work/ios-artifact.zip \
            "${{ github.event.client_payload.callback_url | replace('/callback-ios','') }}/upload-artifact-ios/${BUILD_ID}"

      # ------------------------------------------------------------
      # 9Ô∏è‚É£ Notify Worker (final callback)
      # ------------------------------------------------------------
      - name: Notify iOS NEXT worker (final)
        run: |
          set -e
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{\"build_id\":\"${BUILD_ID}\",\"status\":\"success\"}"

      # ------------------------------------------------------------
      # ‚úÖ Done
      # ------------------------------------------------------------
      - name: Done
        run: echo "‚úÖ iOS NEXT build completed successfully"
