name: NovaBridge iOS Cloud Build (NEXT)

on:
  repository_dispatch:
    types:
      - novabridge_ios_build_next
  workflow_dispatch:

jobs:
  ios-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      PLUGINS_JSON: ${{ github.event.client_payload.plugins_json || '{}' }}

    steps:
      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout
      # ------------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Setup Node (for plugin injector)
      # ------------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Download iOS ZIP
      # ------------------------------------------------------------
      - name: Download iOS ZIP
        run: |
          set -e
          mkdir -p work
          curl -L "$ZIP_URL" -o ios.zip
          unzip -q ios.zip -d work

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Locate iOS project directory
      # ------------------------------------------------------------
      - name: Locate iOS project directory
        run: |
          set -e
          IOS_DIR=$(find work -maxdepth 3 -type d -name "*.xcodeproj" | sed 's|/[^/]*$||' | head -n 1)
          if [ -z "$IOS_DIR" ]; then
            echo "‚ùå No iOS project directory found"
            exit 1
          fi
          echo "IOS_DIR=$IOS_DIR" >> $GITHUB_ENV
          echo "üìÅ iOS dir: $IOS_DIR"

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Apply iOS plugins (Info.plist + entitlements)
      # ------------------------------------------------------------
      - name: Apply iOS plugins
        run: |
          set -e
          echo "üîå Applying iOS plugins: $PLUGINS_JSON"

          node tools/ios-plugins/dist/injectIosPlugins.js \
            --infoPlist "$IOS_DIR/Info.plist" \
            --entitlements "$IOS_DIR/App.entitlements" \
            --plugins "$PLUGINS_JSON"

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Resolve Xcode project + scheme (ROBUST FIX)
      # ------------------------------------------------------------
      - name: Resolve Xcode project + scheme
        shell: bash
        run: |
          set -e

          XCODEPROJ=$(find "$IOS_DIR" -name "*.xcodeproj" | head -n 1)
          if [ -z "$XCODEPROJ" ]; then
            echo "‚ùå No .xcodeproj found"
            exit 1
          fi

          echo "üßæ xcodebuild -list output:"
          xcodebuild -list -project "$XCODEPROJ"

          SCHEMES=$(xcodebuild -list -project "$XCODEPROJ" | python3 - <<'PY'
          import sys

          lines = sys.stdin.read().splitlines()
          schemes = []
          capture = False

          for line in lines:
              if line.strip() == "Schemes:":
                  capture = True
                  continue
              if capture:
                  if line.strip() == "":
                      continue
                  if not line.startswith(" "):
                      break
                  schemes.append(line.strip())

          for s in schemes:
              print(s)
          PY
          )

          if [ -z "$SCHEMES" ]; then
            echo "‚ùå No schemes found"
            exit 1
          fi

          APP_NAME="$(basename "$XCODEPROJ" .xcodeproj)"
          PICK=$(echo "$SCHEMES" | grep -i -m1 "^$APP_NAME$" || true)
          if [ -z "$PICK" ]; then
            PICK=$(echo "$SCHEMES" | head -n 1)
          fi

          echo "XCODEPROJ=$XCODEPROJ" >> "$GITHUB_ENV"
          echo "SCHEME=$PICK" >> "$GITHUB_ENV"

          echo "‚úÖ Selected scheme: $PICK"

      # ------------------------------------------------------------
      # 7Ô∏è‚É£ Build with Xcode (unsigned)
      # ------------------------------------------------------------
      - name: Build iOS app (Xcode)
        run: |
          set -e

          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            build

      # ------------------------------------------------------------
      # 8Ô∏è‚É£ Package ZIP artifact
      # ------------------------------------------------------------
      - name: Package iOS build output
        run: |
          set -e
          mkdir -p artifact
          zip -qr ios-build-${BUILD_ID}.zip "$IOS_DIR"
          echo "ARTIFACT=ios-build-${BUILD_ID}.zip" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 9Ô∏è‚É£ Upload artifact to GitHub
      # ------------------------------------------------------------
      - name: Upload iOS ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ env.BUILD_ID }}
          path: ios-build-${{ env.BUILD_ID }}.zip

      # ------------------------------------------------------------
      # üîü Notify Worker (terminal = true)
      # ------------------------------------------------------------
      - name: Notify iOS Worker
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\"}"

      # ------------------------------------------------------------
      # ‚úÖ Done
      # ------------------------------------------------------------
      - name: Done
        run: echo "‚úÖ iOS NEXT build completed successfully"
