name: NovaBridge iOS Cloud Build (NEXT)

on:
  repository_dispatch:
    types:
      - novabridge_ios_build_next
  workflow_dispatch:

jobs:
  ios-next-build:
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      WORKER_BASE: https://novabridge-ios-build-worker-next.novabridge.workers.dev

    steps:
      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Extract & sanitize dispatch payload
      # ------------------------------------------------------------
      - name: Extract dispatch payload
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import json, os

          ev = json.load(open(os.environ["GITHUB_EVENT_PATH"], "r"))
          cp = ev.get("client_payload") or {}

          def pick(*keys):
              for k in keys:
                  if cp.get(k):
                      return cp.get(k)
              return ""

          build_id = pick("build_id", "buildId")
          zip_url = pick("zip_url", "zipUrl")
          callback_url = pick("callback_url", "callbackUrl")

          plugins = cp.get("plugins") or {}
          if isinstance(plugins, str):
              try:
                  plugins = json.loads(plugins)
              except:
                  plugins = {}
          if not isinstance(plugins, dict):
              plugins = {}

          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"BUILD_ID={build_id}\n")
              f.write(f"ZIP_URL={zip_url}\n")
              f.write(f"CALLBACK_URL={callback_url}\n")
              f.write(f"PLUGINS_JSON={json.dumps(plugins, separators=(',', ':'))}\n")
          PY

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Validate payload
      # ------------------------------------------------------------
      - name: Validate payload
        run: |
          set -e
          [ -n "$BUILD_ID" ]
          [ -n "$ZIP_URL" ]

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Download iOS ZIP from Worker
      # ------------------------------------------------------------
      - name: Download iOS ZIP
        run: |
          set -e
          rm -rf work
          mkdir -p work
          echo "‚¨áÔ∏è Downloading iOS ZIP:"
          echo "$ZIP_URL"
          curl -fL "$ZIP_URL" -o ios.zip
          unzip -q ios.zip -d work

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Tooling
      # ------------------------------------------------------------
      - name: Install xcodegen
        run: brew install xcodegen

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Locate project.yml
      # ------------------------------------------------------------
      - name: Locate iOS project directory
        run: |
          set -e
          SPEC=$(find work -type f -name "project.yml" | head -n 1)
          [ -n "$SPEC" ]
          IOS_DIR="$(dirname "$SPEC")"
          echo "IOS_DIR=$IOS_DIR" >> "$GITHUB_ENV"

      # ------------------------------------------------------------
      # 7Ô∏è‚É£ Apply iOS plugins (Info.plist + entitlements)
      # ------------------------------------------------------------
      - name: Apply iOS plugins
        run: |
          set -e

          echo "üîå Applying iOS plugins JSON:"
          echo "$PLUGINS_JSON"

          cd tools/ios-plugins
          npm ci || npm install
          npx tsc
          cd ../..

          INFO_PLIST=$(find "$IOS_DIR" -type f -name "Info.plist" | head -n 1)
          [ -n "$INFO_PLIST" ]

          ENTITLEMENTS=$(find "$IOS_DIR" -type f -name "*.entitlements" | head -n 1 || true)
          if [ -z "$ENTITLEMENTS" ]; then
            ENTITLEMENTS="$(dirname "$INFO_PLIST")/App.entitlements"
            echo '<?xml version="1.0" encoding="UTF-8"?><plist version="1.0"><dict/></plist>' > "$ENTITLEMENTS"
          fi

          node tools/ios-plugins/dist/injectIosPlugins.js \
            --infoPlist "$INFO_PLIST" \
            --entitlements "$ENTITLEMENTS" \
            --plugins "$PLUGINS_JSON"

      # ------------------------------------------------------------
      # 8Ô∏è‚É£ Generate Xcode project
      # ------------------------------------------------------------
      - name: Generate Xcode project
        run: |
          set -e
          cd "$IOS_DIR"
          xcodegen generate

      # ------------------------------------------------------------
      # 9Ô∏è‚É£ Resolve scheme safely
      # ------------------------------------------------------------
      - name: Resolve Xcode scheme
        shell: bash
        run: |
          set -e

          XCODEPROJ=$(find "$IOS_DIR" -type d -name "*.xcodeproj" | head -n 1)
          [ -n "$XCODEPROJ" ]

          echo "üßæ xcodebuild -list:"
          xcodebuild -list -project "$XCODEPROJ"

          SCHEME=$(xcodebuild -list -project "$XCODEPROJ" | python3 - <<'PY'
          import sys
          lines = sys.stdin.read().splitlines()
          grab = False
          for l in lines:
              if l.strip() == "Schemes:":
                  grab = True
                  continue
              if grab:
                  if not l.startswith(" "):
                      break
                  s = l.strip()
                  if s:
                      print(s)
                      break
          PY
          )

          [ -n "$SCHEME" ]

          echo "XCODEPROJ=$XCODEPROJ" >> "$GITHUB_ENV"
          echo "SCHEME=$SCHEME" >> "$GITHUB_ENV"
          echo "‚úÖ Using scheme: $SCHEME"

      # ------------------------------------------------------------
      # üîü Build with Xcode
      # ------------------------------------------------------------
      - name: Build with Xcode
        run: |
          set -e
          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            build

      # ------------------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Package iOS artifact ZIP
      # ------------------------------------------------------------
      - name: Package iOS artifact
        run: |
          set -e
          cd "$IOS_DIR"
          zip -qr "$GITHUB_WORKSPACE/ios-build-${BUILD_ID}.zip" .

      # ------------------------------------------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ Upload artifact to iOS NEXT Worker (THIS IS THE FIX)
      # ------------------------------------------------------------
      - name: Upload artifact to iOS NEXT Worker
        run: |
          set -e

          ZIP_PATH="ios-build-${BUILD_ID}.zip"

          echo "‚¨ÜÔ∏è Uploading ZIP to iOS NEXT Worker:"
          echo "$WORKER_BASE/upload-artifact-ios/$BUILD_ID"

          curl -f -X PUT "$WORKER_BASE/upload-artifact-ios/$BUILD_ID" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            --data-binary "@$ZIP_PATH"

      # ------------------------------------------------------------
      # 1Ô∏è‚É£3Ô∏è‚É£ Done
      # ------------------------------------------------------------
      - name: Done
        run: echo "‚úÖ iOS NEXT build completed successfully"
