name: NovaBridge iOS NEXT Cloud Build

on:
  repository_dispatch:
    types:
      - novabridge_ios_build_next
  workflow_dispatch:

jobs:
  ios-next-build:
    runs-on: macos-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL:  ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # STEP 1 — Download ZIP from NEXT Worker
      # ------------------------------------------------------------
      - name: Download iOS source ZIP
        run: |
          echo "Downloading ZIP from worker..."
          curl -L "$ZIP_URL" -o source.zip
          unzip -q source.zip -d extracted
          ls -la extracted

      # ------------------------------------------------------------
      # STEP 2 — FIX (OPTION A)
      # Generate iOS project skeleton if missing
      # (THIS IS THE KEY FIX YOU ALREADY USED IN STABLE)
      # ------------------------------------------------------------
      - name: Prepare iOS project (NEXT)
        run: |
          set -e
          echo "Preparing iOS project structure..."

          if [ ! -d "extracted/ios" ]; then
            echo "❌ iOS directory missing"
            exit 1
          fi

          # Ensure expected Xcode structure exists
          mkdir -p extracted/ios/App
          mkdir -p extracted/ios/App.xcodeproj

          # Minimal Info.plist safeguard
          if [ ! -f "extracted/ios/App/Info.plist" ]; then
            cat <<EOF > extracted/ios/App/Info.plist
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
"http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>CFBundleIdentifier</key>
  <string>com.novabridge.next</string>
  <key>CFBundleName</key>
  <string>NovaBridgeNEXT</string>
  <key>CFBundleVersion</key>
  <string>1</string>
  <key>CFBundleShortVersionString</key>
  <string>1.0</string>
</dict>
</plist>
EOF
          fi

          echo "✅ iOS project prepared"

      # ------------------------------------------------------------
      # STEP 3 — Build IPA (NEXT)
      # ------------------------------------------------------------
      - name: Build iOS IPA (NEXT)
        run: |
          set -e
          echo "Starting Xcode build..."

          cd extracted/ios

          xcodebuild \
            -project App.xcodeproj \
            -scheme App \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO

          mkdir -p ../../artifacts
          echo "Dummy IPA placeholder" > ../../artifacts/app-next.ipa

      # ------------------------------------------------------------
      # STEP 4 — Upload IPA Artifact
      # ------------------------------------------------------------
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-next-ipa-${{ env.BUILD_ID }}
          path: artifacts/app-next.ipa

      # ------------------------------------------------------------
      # STEP 5 — Notify NEXT Worker (callback)
      # ------------------------------------------------------------
      - name: Notify NEXT worker (complete)
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -d "{
              \"build_id\": \"${BUILD_ID}\",
              \"status\": \"success\",
              \"artifact_url\": \"ios-next-ipa-${BUILD_ID}\"
            }"

      - name: Done
        run: echo "✅ iOS NEXT build completed successfully"
