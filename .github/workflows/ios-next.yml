name: NovaBridge iOS Cloud Build (NEXT)

on:
  repository_dispatch:
    types:
      - novabridge_ios_build_next
  workflow_dispatch:

jobs:
  ios-next-build:
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Extract dispatch payload (safe; no YAML expression tricks)
      # ------------------------------------------------------------
      - name: Extract dispatch payload
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import json, os

          ev = json.load(open(os.environ["GITHUB_EVENT_PATH"], "r"))
          cp = ev.get("client_payload") or {}

          build_id = cp.get("build_id") or cp.get("buildId") or ""
          zip_url = cp.get("zip_url") or cp.get("zipUrl") or ""
          callback_url = cp.get("callback_url") or cp.get("callbackUrl") or ""

          plugins = cp.get("plugins") or cp.get("plugins_json") or {}
          if isinstance(plugins, str):
            try:
              plugins = json.loads(plugins)
            except Exception:
              plugins = {}
          if not isinstance(plugins, dict):
            plugins = {}

          with open(os.environ["GITHUB_ENV"], "a") as f:
            f.write(f"BUILD_ID={build_id}\n")
            f.write(f"ZIP_URL={zip_url}\n")
            f.write(f"CALLBACK_URL={callback_url}\n")
            f.write(f"PLUGINS_JSON={json.dumps(plugins, separators=(',', ':'))}\n")
          PY

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Validate payload
      # ------------------------------------------------------------
      - name: Validate dispatch payload
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${BUILD_ID:-}" ] || [ -z "${ZIP_URL:-}" ] || [ -z "${CALLBACK_URL:-}" ]; then
            echo "‚ùå Missing required payload values (BUILD_ID / ZIP_URL / CALLBACK_URL)"
            exit 1
          fi

          echo "‚úÖ Payload validated: BUILD_ID=$BUILD_ID"

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ UI Step 2: GitHub dispatched
      # ------------------------------------------------------------
      - name: Mark GitHub dispatched
        shell: bash
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":2,\"step_state\":\"done\",\"log\":\"iOS NEXT: GitHub workflow started\"}" || true

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Download iOS ZIP (UI Step 3)
      # ------------------------------------------------------------
      - name: Download iOS ZIP
        shell: bash
        run: |
          set -e
          rm -rf work
          mkdir -p work

          echo "‚¨áÔ∏è Downloading ZIP: $ZIP_URL"
          curl -L "$ZIP_URL" -o ios.zip
          unzip -q ios.zip -d work

          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"done\",\"log\":\"iOS NEXT: ZIP downloaded\"}" || true

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Install tooling
      # ------------------------------------------------------------
      - name: Install xcodegen
        shell: bash
        run: |
          brew install xcodegen

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Locate project.yml -> IOS_DIR (FIX)
      # ------------------------------------------------------------
      - name: Locate iOS project directory (project.yml)
        shell: bash
        run: |
          set -e

          echo "üîç Searching for project.yml‚Ä¶"
          SPEC=$(find work -type f -name "project.yml" | head -n 1 || true)

          if [ -z "$SPEC" ]; then
            echo "‚ùå No project.yml found in ZIP (cannot run xcodegen)"
            echo "üìÅ Contents:"
            find work -maxdepth 4 -type d
            find work -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          IOS_DIR="$(dirname "$SPEC")"
          echo "‚úÖ Found project.yml: $SPEC"
          echo "üìÅ IOS_DIR: $IOS_DIR"

          echo "IOS_DIR=$IOS_DIR" >> "$GITHUB_ENV"

          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"working\",\"log\":\"iOS NEXT: project.yml located (xcodegen ready)\"}" || true

      # ------------------------------------------------------------
      # 7Ô∏è‚É£ Apply iOS plugins (Info.plist + entitlements) ‚Äî robust file finding
      # ------------------------------------------------------------
      - name: Apply iOS plugins (Info.plist + entitlements)
        shell: bash
        run: |
          set -e
          echo "üîå Applying iOS plugins: ${PLUGINS_JSON:-{}}"

          # Build plugin tool (repo now contains tools/ios-plugins)
          cd tools/ios-plugins
          npm ci || npm install
          npx --yes --package typescript@5.6.3 tsc
          cd ../..

          # Find Info.plist anywhere under IOS_DIR
          INFO_PLIST=$(find "$IOS_DIR" -type f -name "Info.plist" | head -n 1 || true)
          if [ -z "$INFO_PLIST" ]; then
            echo "‚ùå Info.plist not found under IOS_DIR=$IOS_DIR"
            find "$IOS_DIR" -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          # Find or create entitlements file
          ENTITLEMENTS=$(find "$IOS_DIR" -type f -name "*.entitlements" | head -n 1 || true)
          if [ -z "$ENTITLEMENTS" ]; then
            ENTITLEMENTS="$(dirname "$INFO_PLIST")/App.entitlements"
            echo '<?xml version="1.0" encoding="UTF-8"?><plist version="1.0"><dict/></plist>' > "$ENTITLEMENTS"
          fi

          node tools/ios-plugins/dist/injectIosPlugins.js \
            --infoPlist "$INFO_PLIST" \
            --entitlements "$ENTITLEMENTS" \
            --plugins "${PLUGINS_JSON:-{}}"

          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"done\",\"log\":\"iOS NEXT: Plugins injected\"}" || true

      # ------------------------------------------------------------
      # 8Ô∏è‚É£ Run XcodeGen to create .xcodeproj (UI Step 5 start)
      # ------------------------------------------------------------
      - name: Generate Xcode project (xcodegen)
        shell: bash
        run: |
          set -e
          cd "$IOS_DIR"
          echo "üèóÔ∏è Running xcodegen in: $IOS_DIR"
          xcodegen generate

      # ------------------------------------------------------------
      # 9Ô∏è‚É£ Resolve XCODEPROJ + Scheme (robust)
      # ------------------------------------------------------------
      - name: Resolve Xcode project + scheme
        shell: bash
        run: |
          set -e

          XCODEPROJ=$(find "$IOS_DIR" -type d -name "*.xcodeproj" | head -n 1 || true)
          if [ -z "$XCODEPROJ" ]; then
            echo "‚ùå xcodegen did not produce an .xcodeproj"
            find "$IOS_DIR" -maxdepth 3 -type d
            exit 1
          fi

          echo "‚úÖ XCODEPROJ: $XCODEPROJ"
          echo "üßæ xcodebuild -list output:"
          xcodebuild -list -project "$XCODEPROJ"

          SCHEME=$(xcodebuild -list -project "$XCODEPROJ" | python3 - <<'PY'
          import sys
          lines = sys.stdin.read().splitlines()
          capture = False
          schemes = []

          for l in lines:
              if l.strip() == "Schemes:":
                  capture = True
                  continue
              if capture:
                  if not l.startswith(" "):
                      break
                  if l.strip():
                      schemes.append(l.strip())

          print(schemes[0] if schemes else "")
          PY
          )

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme detected"
            exit 1
          fi

          echo "XCODEPROJ=$XCODEPROJ" >> "$GITHUB_ENV"
          printf "SCHEME=%s\n" "$SCHEME" >> "$GITHUB_ENV"

          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"done\",\"log\":\"iOS NEXT: Xcode project + scheme resolved ($SCHEME)\"}" || true

      # ------------------------------------------------------------
      # üîü Build with Xcode (UI Step 6)
      # ------------------------------------------------------------
      - name: Build with Xcode (unsigned)
        shell: bash
        run: |
          set -e

          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"working\",\"log\":\"iOS NEXT: Building with Xcode‚Ä¶\"}" || true

          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            build

          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"done\",\"log\":\"iOS NEXT: Xcode build completed\"}" || true

      # ------------------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Package ZIP artifact (UI Step 7)
      # ------------------------------------------------------------
      - name: Package iOS ZIP artifact
        shell: bash
        run: |
          set -e
          cd "$IOS_DIR"
          zip -qr "$GITHUB_WORKSPACE/ios-build-${BUILD_ID}.zip" .

          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"done\",\"log\":\"iOS NEXT: Artifact packaged\"}" || true

      # ------------------------------------------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ Upload ZIP artifact to GitHub
      # ------------------------------------------------------------
      - name: Upload artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ios-next-${{ env.BUILD_ID }}
          path: ios-build-${{ env.BUILD_ID }}.zip

      # ------------------------------------------------------------
      # 1Ô∏è‚É£3Ô∏è‚É£ Upload ZIP to Worker (R2) + Complete (UI Step 8)
      # ------------------------------------------------------------
      - name: Upload ZIP to Worker and complete
        shell: bash
        run: |
          set -e

          BASE=$(python3 - <<'PY'
          import os
          print(os.environ["CALLBACK_URL"].split("/callback")[0])
          PY
          )

          RESP=$(curl -s -X POST "$BASE/upload/ios-zip/$BUILD_ID" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/zip" \
            --data-binary @"ios-build-${BUILD_ID}.zip" || true)

          ARTIFACT_URL=$(python3 - <<'PY'
          import json, sys
          try:
            print(json.loads(sys.argv[1]).get("artifactUrl",""))
          except:
            print("")
          PY
          "$RESP")

          curl -s -X POST "$CALLBACK_URL" \
            -H "x-novabridge-token: ${{ secrets.CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":8,\"step_state\":\"done\",\"status\":\"success\",\"terminal\":true,\"artifactUrl\":\"$ARTIFACT_URL\",\"log\":\"iOS NEXT: Upload complete\"}" || true

      - name: Done
        run: echo "‚úÖ iOS NEXT build completed successfully"
