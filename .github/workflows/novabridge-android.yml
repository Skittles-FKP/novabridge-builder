name: NovaBridge Cloud Build (Android)

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}
      PROGRESS_URL: ${{ github.event.client_payload.progressUrl }}
      GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Small helper: function to send progress to the Worker
      - name: Define progress helper
        shell: bash
        run: |
          cat << 'EOF' > send_progress.sh
          #!/usr/bin/env bash
          BUILD_ID="$1"
          STEP="$2"
          STATUS="$3"
          PROGRESS="$4"
          MESSAGE="$5"

          if [ -z "$PROGRESS_URL" ]; then
            echo "No PROGRESS_URL configured, skipping progress ping"
            exit 0
          fi

          echo ">>> Progress: [$PROGRESS%] $STEP ($STATUS) - $MESSAGE"

          curl -sS -X POST "$PROGRESS_URL" \
            -H "Content-Type: application/json" \
            -d "$(node - << JS
              const payload = {
                buildId: "$BUILD_ID",
                step: "$STEP",
                status: "$STATUS",
                progress: Number("$PROGRESS"),
                message: "$MESSAGE"
              };
              process.stdout.write(JSON.stringify(payload));
JS
            )" >/dev/null 2>&1 || echo "Progress ping failed (ignored)"
          EOF

          chmod +x send_progress.sh

      - name: Report progress â€“ Preparing environment
        shell: bash
        run: |
          ./send_progress.sh "$BUILD_ID" "Preparing Environment" "running" 5 "GitHub runner acquired"

      - name: Show payload
        shell: bash
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          echo "PROGRESS_URL=$PROGRESS_URL"

      - name: Report progress â€“ Downloading ZIP
        shell: bash
        run: |
          ./send_progress.sh "$BUILD_ID" "Generating Native Project" "running" 15 "Downloading Android ZIP from Worker"

      - name: Download ZIP from Worker
        shell: bash
        run: |
          mkdir -p build
          echo "Downloading ZIP from $ZIP_URL"
          curl -L "$ZIP_URL" -o build/project.zip

      - name: Report progress â€“ Unzipping project
        shell: bash
        run: |
          ./send_progress.sh "$BUILD_ID" "Generating Native Project" "running" 25 "Unzipping Android project"

      - name: Unzip Android project (root = project/)
        shell: bash
        run: |
          mkdir -p build/project
          unzip -o build/project.zip -d build/project
          ls -R build/project

      - name: Report progress â€“ Setting up JDK
        shell: bash
        run: |
          ./send_progress.sh "$BUILD_ID" "Preparing Environment" "running" 35 "Setting up JDK 17"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Report progress â€“ Running Gradle build
        shell: bash
        run: |
          ./send_progress.sh "$BUILD_ID" "Running Build Tasks" "running" 50 "Running Gradle assembleRelease"

      - name: Build Release APK with system Gradle
        shell: bash
        run: |
          cd build/project
          echo "ðŸ— Running Gradle assembleRelease..."
          gradle assembleRelease

      - name: Report progress â€“ Locating APK
        if: success()
        shell: bash
        run: |
          ./send_progress.sh "$BUILD_ID" "Packaging Artifact" "running" 75 "Locating built APK"

      - name: Find APK
        if: success()
        id: find_apk
        shell: bash
        run: |
          APK_PATH=$(find build/project -name "*.apk" -print -quit)
          echo "APK_PATH=$APK_PATH"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV

      # OPTIONAL: Upload to R2 or GitHub artifacts â€“ placeholder here
      - name: Report progress â€“ Uploading artifact (placeholder)
        if: env.APK_PATH != ''
        shell: bash
        run: |
          ./send_progress.sh "$BUILD_ID" "Uploading to R2" "running" 85 "APK located at $APK_PATH (upload step placeholder)"

      # ---------- SUCCESS CALLBACK ----------
      - name: Notify NovaBridge Worker callback (success)
        if: success() && env.APK_PATH != ''
        shell: bash
        run: |
          ARTIFACT_URL="$GITHUB_RUN_URL"  # You can replace with real R2 URL later

          echo "Sending success callback to $CALLBACK_URL"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(node - << JS
              const payload = {
                buildId: "$BUILD_ID",
                status: "success",
                artifactUrl: "$ARTIFACT_URL",
                step: "Build Complete",
                progress: 100,
                message: "Android build completed successfully"
              };
              process.stdout.write(JSON.stringify(payload));
JS
            )"

          ./send_progress.sh "$BUILD_ID" "Build Complete" "success" 100 "Android build completed successfully"

      # ---------- FAILURE CALLBACK ----------
      - name: Notify NovaBridge Worker callback (failure)
        if: failure()
        shell: bash
        run: |
          echo "Sending failure callback to $CALLBACK_URL"

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(node - << JS
              const payload = {
                buildId: "$BUILD_ID",
                status: "error",
                artifactUrl: null,
                step: "Build Failed",
                progress: 100,
                message: "GitHub Actions Android build failed"
              };
              process.stdout.write(JSON.stringify(payload));
JS
            )"

          ./send_progress.sh "$BUILD_ID" "Build Failed" "error" 100 "GitHub Actions Android build failed"
