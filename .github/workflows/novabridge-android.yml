# .github/workflows/novabridge-android-v16-5.yml

name: NovaBridge Android Cloud Build v16.5

on:
  repository_dispatch:
    types: [novabridge_android_build_v16_5]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      APP_NAME: ${{ github.event.client_payload.app_name }}
      PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
      PROJECT_URL: ${{ github.event.client_payload.project_url }}

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üß™ Show incoming payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üèó Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: üì• Download native ZIP from Worker
        run: |
          set -e
          if [ -z "$ZIP_URL" ]; then
            echo "Missing ZIP_URL"; exit 1;
          fi
          echo "Downloading ZIP from $ZIP_URL"
          curl -fSL "$ZIP_URL" -o project.zip
          ls -lh project.zip

      - name: üì¶ Extract Android project
        run: |
          set -e
          mkdir -p android_project
          unzip -o project.zip -d android_project || (echo "unzip failed"; exit 1)
          ls -R android_project || true

      - name: üèó Run Gradle assembleRelease
        working-directory: android_project
        run: |
          set -e
          echo "Running Gradle assembleRelease‚Ä¶"
          gradle assembleRelease --warning-mode all

      - name: üîç Locate release APK
        id: find_apk
        working-directory: android_project
        run: |
          set -e
          APK_PATH=$(find . -type f -name "*release*.apk" | head -n 1 || true)
          if [ -z "$APK_PATH" ]; then
            echo "No APK found!"
            echo "apk_path=" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          echo "Found APK at: $APK_PATH"
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"

      # You can optionally upload the APK as a GitHub artifact
      - name: üì§ Upload APK as artifact
        if: success() && steps.find_apk.outputs.apk_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: novabridge-android-apk
          path: android_project/${{ steps.find_apk.outputs.apk_path }}

      - name: ‚úÖ Notify Worker (success)
        if: success()
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL, skipping callback."
            exit 0
          fi

          # For now, artifact_url points to the GitHub Actions run page
          ARTIFACT_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          echo "Notifying Worker: success ‚Üí $CALLBACK_URL"
          jq -n \
            --arg id "$BUILD_ID" \
            --arg status "success" \
            --arg msg "GitHub Actions build completed successfully" \
            --arg art "$ARTIFACT_URL" \
            '{build_id: $id, status: $status, message: $msg, artifact_url: $art}' \
          | curl -fSL -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -d @-

      - name: ‚ùå Notify Worker (failure)
        if: failure()
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL, skipping failure callback."
            exit 0
          fi

          MSG="GitHub Actions build failed ‚Äì check workflow logs"
          echo "Notifying Worker: failure ‚Üí $CALLBACK_URL"

          jq -n \
            --arg id "$BUILD_ID" \
            --arg status "error" \
            --arg msg "$MSG" \
            '{build_id: $id, status: $status, message: $msg, artifact_url: null}' \
          | curl -fSL -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -d @-
