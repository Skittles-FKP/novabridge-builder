name: NovaBridge Android Cloud Build v15.9.2 (Stable)

on:
  repository_dispatch:
    types: [novabridge_android_build_v15_9_2]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID:       ${{ github.event.client_payload.build_id }}
      ZIP_URL:        ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL:   ${{ github.event.client_payload.callback_url }}
      APP_NAME:       ${{ github.event.client_payload.app_name }}
      PACKAGE_NAME:   ${{ github.event.client_payload.package_name }}
      PROJECT_URL:    ${{ github.event.client_payload.project_url }}

    steps:

      - name: üß© Checkout Repo
        uses: actions/checkout@v4

      - name: üß™ Debug Incoming Payload
        run: |
          echo "--- Incoming Payload ---"
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"

      ###########################################################
      # 1) DOWNLOAD NATIVE PROJECT ZIP FROM WORKER
      ###########################################################

      - name: üì• Download Project ZIP
        run: |
          echo "Downloading ZIP from $ZIP_URL"
          curl -L "$ZIP_URL" --output project.zip

      - name: üì¶ Extract ZIP
        run: |
          unzip project.zip -d build || (echo "ZIP extraction failed" && exit 1)

      ###########################################################
      # 2) SETUP JAVA / GRADLE
      ###########################################################

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: üèó Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      ###########################################################
      # 3) RUN ANDROID BUILD
      ###########################################################

      - name: üî® Build Android (Gradle)
        working-directory: build
        run: |
          echo "Running Gradle build..."
          ./gradlew assembleRelease --stacktrace --warning-mode all

      ###########################################################
      # 4) UPLOAD ARTIFACT (APK)
      ###########################################################

      - name: üì§ Find release APK
        id: apk-path
        run: |
          APK=$(find build -name "*.apk" | head -n 1)
          echo "apk_path=$APK" >> $GITHUB_OUTPUT

      ###########################################################
      # 5) NOTIFY WORKER (SUCCESS)
      ###########################################################

      - name: ‚úÖ Notify Worker ‚Äì Success
        if: success()
        run: |
          echo "Notifying Worker of SUCCESS..."
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"message\":\"Build completed successfully\",\"artifact_url\":\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

      ###########################################################
      # 6) NOTIFY WORKER (FAILURE)
      ###########################################################

      - name: ‚ùå Notify Worker ‚Äì Failure
        if: failure()
        run: |
          echo "Notifying Worker of FAILURE..."
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"error\",\"message\":\"GitHub Actions build failed ‚Äì check logs\",\"artifact_url\":null}"
