name: NovaBridge Android Cloud Build v15.8

on:
  repository_dispatch:
    types: [novabridge_android_build_v15_8]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      APP_NAME: ${{ github.event.client_payload.app_name }}
      PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
      PROJECT_URL: ${{ github.event.client_payload.project_url }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

    steps:
      - name: üìå Show received payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: üì• Download native ZIP from Worker
        run: |
          echo "Downloading ZIP from $ZIP_URL"
          curl -L "$ZIP_URL" --output project.zip
          ls -alh project.zip || true

      - name: üì¶ Extract ZIP
        run: |
          if file project.zip | grep -q "Zip archive"; then
            unzip project.zip -d build
          else
            echo "‚ùå Not a ZIP file"
            exit 1
          fi

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üèó Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: üèó Run Gradle build (assembleRelease)
        working-directory: build
        run: |
          echo "Starting Gradle Build..."
          chmod +x ./gradlew || true
          ./gradlew assembleRelease --warning-mode all

      - name: üì§ Find APK artifact
        run: |
          APK_PATH=$(find build -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "‚ùå No APK found"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV

      - name: üì§ Upload APK to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "novabridge-apk"
          path: ${{ env.APK_PATH }}

      - name: ‚úÖ Notify Worker (success)
        if: success()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "success" \
              --arg msg "Build completed successfully" \
              --arg apk "github://artifact/novabridge-apk" \
              '{build_id:$id, status:$status, message:$msg, artifact_url:$apk}')"

      - name: ‚ùå Notify Worker (failure)
        if: failure()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "error" \
              --arg msg "GitHub Actions build failed" \
              '{build_id:$id, status:$status, message:$msg, artifact_url:null}')"
