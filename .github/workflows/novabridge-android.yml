name: NovaBridge Cloud Build (Android)

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: Notify Worker â€“ preparing environment
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d '{"stage":"prepare"}'

      - name: Download ZIP from Worker
        run: |
          mkdir -p build
          echo "Downloading ZIP from $ZIP_URL"
          curl -L "$ZIP_URL" -o build/project.zip

      - name: Notify Worker â€“ extracting project
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d '{"stage":"extract"}'

      - name: Unzip Android project
        run: |
          mkdir -p build
          unzip -o build/project.zip -d build
          echo "--- PROJECT STRUCTURE ---"
          ls -R build

      # ðŸ”¥ Golden Milestone Fix:
      # Auto-detect correct project root
      - name: Detect Android project root
        id: detect_root
        run: |
          echo "Detecting Android project root..."
          ROOT=$(find build -maxdepth 4 -name "AndroidManifest.xml" -printf '%h\n' | head -n 1)
          if [ -z "$ROOT" ]; then
            echo "âŒ ERROR: Could not find Android project root"
            exit 1
          fi
          echo "ROOT=$ROOT" >> $GITHUB_ENV
          echo "Detected ROOT: $ROOT"

      - name: Notify Worker â€“ running build tasks
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d '{"stage":"build"}'

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: Build Release APK (system Gradle)
        run: |
          echo "Using root: $ROOT"
          cd "$ROOT"
          echo "ðŸ— Running Gradle assembleRelease with system Gradle..."
          gradle assembleRelease --warning-mode all

      - name: Find APK
        id: find_apk
        run: |
          APK=$(find build -name "*.apk" | head -n 1)
          if [ -z "$APK" ]; then
            echo "âŒ No APK found"
            exit 1
          fi
          echo "APK=$APK" >> $GITHUB_ENV
          echo "Found APK at: $APK"

      - name: Notify Worker â€“ packaging completed
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d '{"stage":"package"}'

      - name: Notify Worker â€“ upload result
        run: |
          PAYLOAD=$(jq -n \
            --arg id "$BUILD_ID" \
            --arg apk "$APK" \
            '{buildId: $id, status: "success", artifactPath: $apk}')
          
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

      - name: Final status
        run: |
          echo "Build finished successfully!"
