name: NovaBridge Cloud Build (Android)

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: Download ZIP from Worker
        run: |
          mkdir -p build
          echo "Downloading ZIP from $ZIP_URL"
          curl -L "$ZIP_URL" -o build/project.zip

      - name: Unzip Android project (root = project/)
        run: |
          mkdir -p build
          unzip -o build/project.zip -d build
          ls -R build

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: Build Release APK with system Gradle
        run: |
          cd build/project
          ls
          gradle assembleRelease

      - name: Find APK
        id: find_apk
        run: |
          APK_PATH=$(find build/project -name "*.apk" | head -n 1)
          echo "APK_PATH=$APK_PATH"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV

      - name: Upload APK to R2 (optional â€“ if you wire AWS/R2 here)
        if: env.APK_PATH != ''
        run: |
          echo "Built APK at: $APK_PATH"
          # Here you could upload to R2 with aws s3 cp if configured

      - name: Notify NovaBridge Worker callback
        if: env.APK_PATH != ''
        run: |
          PAYLOAD=$(jq -n \
            --arg id "$BUILD_ID" \
            --arg url "APK_PATH_PLACEHOLDER" \
            '{buildId: $id, status: "success", artifactUrl: $url}')
          echo "Sending callback payload: $PAYLOAD"
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
