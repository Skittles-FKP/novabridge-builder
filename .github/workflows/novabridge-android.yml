name: "NovaBridge Android Cloud Build v15.4"

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: "Build ID from Worker"
        required: true
      zip_url:
        description: "Direct R2 ZIP URL"
        required: true
      callback_url:
        description: "Worker callback endpoint"
        required: true
  repository_dispatch:
    types: [android-build-request]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id || github.event.inputs.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url || github.event.inputs.callback_url }}

    steps:
      - name: üü° START ‚Äî Notify Worker (Starting)
        run: |
          if [ -n "${BUILD_ID}" ]; then
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"buildId\":\"$BUILD_ID\",\"status\":\"starting\",\"stepIndex\":0}"
          fi

      - name: üì• Download Project ZIP
        run: |
          echo "Downloading ZIP from: $ZIP_URL"
          curl -L "$ZIP_URL" -o project.zip

      - name: üì¶ Update Worker (Extracting)
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"status\":\"extracting\",\"stepIndex\":1}"

      - name: üìÇ Unzip Project
        run: |
          unzip project.zip -d build

      - name: üì¶ Notify Worker (Project Extracted)
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"status\":\"extracted\",\"stepIndex\":2}"

      # --------------------------------------------
      # ANDROID BUILD
      # --------------------------------------------

      - name: ‚òï Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üõ† Prepare root path
        id: detect-root
        run: |
          # Detect correct Gradle root
          if [ -f build/gradlew ]; then
            ROOT="build"
          elif [ -f build/android/gradlew ]; then
            ROOT="build/android"
          else
            ROOT="build"
          fi
          echo "ROOT=$ROOT" >> $GITHUB_OUTPUT

      - name: üüß Notify Worker (Running Build Tasks)
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"status\":\"running\",\"stepIndex\":4}"

      - name: üèó Build Release APK
        working-directory: ${{ steps.detect-root.outputs.ROOT }}
        run: |
          chmod +x gradlew || true
          ./gradlew assembleRelease --warning-mode all

      - name: üì¶ Notify Worker (Packaging APK)
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"status\":\"packaging\",\"stepIndex\":5}"

      # --------------------------------------------
      # FIND APK
      # --------------------------------------------

      - name: üîç Locate APK
        id: find-apk
        run: |
          APK_PATH=$(find . -name "*release*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "APK not found!"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT

      # --------------------------------------------
      # UPLOAD APK TO R2 BUCKET
      # --------------------------------------------

      - name: ‚òÅ Upload APK to R2
        run: |
          R2_URL="https://api.cloudflare.com/client/v4/accounts/${{ secrets.R2_ACCOUNT_ID }}/r2/buckets/novabridge-builds/objects/${BUILD_ID}.apk"
          curl -X PUT "$R2_URL" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            --data-binary @"${{ steps.find-apk.outputs.APK_PATH }}"

      - name: üì° Notify Worker (Uploading ‚Üí Complete)
        run: |
          APK_FINAL_URL="https://novabridge-build-worker.novabridge.workers.dev/api/r2/download?buildId=${BUILD_ID}"
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"status\":\"complete\",\"apkUrl\":\"$APK_FINAL_URL\",\"stepIndex\":7}"

      # --------------------------------------------
      # ON FAILURE, NOTIFY WORKER
      # --------------------------------------------

      - name: ‚ùå On Failure
        if: failure()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"status\":\"error\",\"stepIndex\":4,\"message\":\"GitHub Actions error\"}"
