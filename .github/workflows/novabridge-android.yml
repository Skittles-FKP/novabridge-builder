name: NovaBridge Cloud Build (Android)

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: Notify Worker (10% Preparing Environment)
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"progress\":10,\"step\":\"Preparing Environment\",\"status\":\"running\"}"

      - name: Download ZIP from Worker
        run: |
          mkdir -p build
          echo "Downloading ZIP: $ZIP_URL"
          curl -L "$ZIP_URL" -o build/project.zip

      - name: Notify Worker (25% Unzipping Project)
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"progress\":25,\"step\":\"Generating Native Project\",\"status\":\"running\"}"

      - name: Unzip Android project (root = project/)
        run: |
          unzip -o build/project.zip -d build
          ls -R build

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: Notify Worker (40% Running Build Tasks)
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"progress\":40,\"step\":\"Running Build Tasks\",\"status\":\"running\"}"

      - name: Build Release APK with system Gradle
        run: |
          cd build/project
          gradle assembleRelease

      - name: Find APK
        id: find_apk
        run: |
          APK_PATH=$(find build/project -name "*.apk" | head -n 1)
          echo "APK_PATH=$APK_PATH"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV

      - name: Notify Worker (70% Packaging Artifact)
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"progress\":70,\"step\":\"Packaging Artifact\",\"status\":\"running\"}"

      - name: Upload artifact to GitHub (optional)
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: ${{ env.APK_PATH }}

      - name: Notify Worker (100% COMPLETE)
        if: env.APK_PATH != ''
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"progress\":100,\"step\":\"Build Complete\",\"status\":\"success\",\"artifactUrl\":\"${{ env.APK_PATH }}\"}"

      - name: Notify Worker (FAILED)
        if: failure()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"progress\":0,\"step\":\"Build Failed\",\"status\":\"error\"}"
