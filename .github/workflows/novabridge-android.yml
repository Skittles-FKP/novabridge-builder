name: NovaBridge Android Builder

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}

    steps:

    # ---------------------------------------------------------
    # 0. Notify Worker: QUEUED
    # ---------------------------------------------------------
    - name: Notify worker (QUEUED)
      run: |
        curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"status\": \"queued\", \"step\": \"PREPARING_ENV\", \"percent\": 0, \"log\": \"GitHub Actions job queued\"}"

    # ---------------------------------------------------------
    # 1. Prepare environment
    # ---------------------------------------------------------
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: "temurin"
        java-version: "17"

    - name: Notify worker (PREPARING_ENV)
      run: |
        curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"status\": \"running\", \"step\": \"PREPARING_ENV\", \"percent\": 10, \"log\": \"Java 17 and environment configured\"}"

    # ---------------------------------------------------------
    # 2. Download ZIP from Worker R2
    # ---------------------------------------------------------
    - name: Download ZIP
      run: |
        mkdir -p build/project
        curl -L "$ZIP_URL" -o project.zip

    - name: Notify worker (GENERATING_PROJECT)
      run: |
        curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"status\": \"running\", \"step\": \"GENERATING_PROJECT\", \"percent\": 20, \"log\": \"Project ZIP downloaded from Worker\"}"

    # ---------------------------------------------------------
    # 3. Extract Android project
    # ---------------------------------------------------------
    - name: Extract project
      run: |
        unzip project.zip -d build/project

    - name: Notify worker (UPLOADING_ZIP)
      run: |
        curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"status\": \"running\", \"step\": \"UPLOADING_ZIP\", \"percent\": 35, \"log\": \"ZIP extracted to build/project\"}"

    # ---------------------------------------------------------
    # 4. Run Gradle Build
    # ---------------------------------------------------------
    - name: Grant permissions
      run: |
        chmod +x build/project/gradlew || true

    - name: Build Release APK
      working-directory: build/project
      run: |
        ./gradlew assembleRelease --warning-mode all

    - name: Notify worker (RUNNING_BUILD_TASKS)
      if: success()
      run: |
        curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"status\": \"running\", \"step\": \"RUNNING_BUILD_TASKS\", \"percent\": 70, \"log\": \"Gradle assembleRelease completed\"}"

    # If Gradle fails:
    - name: Notify worker (ERROR)
      if: failure()
      run: |
        ERR_MSG="Gradle build failed"
        curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"status\": \"error\", \"step\": \"RUNNING_BUILD_TASKS\", \"percent\": 0, \"log\": \"$ERR_MSG\", \"error\": \"$ERR_MSG\"}"

    # ---------------------------------------------------------
    # 5. Upload APK to GitHub as artifact
    # ---------------------------------------------------------
    - name: Find APK
      id: apk
      run: |
        APK_PATH=$(find build/project/app/build/outputs/apk/release -name "*.apk" | head -n 1)
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: novabridge-apk-${{ env.BUILD_ID }}
        path: ${{ steps.apk.outputs.apk_path }}

    - name: Notify worker (PACKAGING_ARTIFACT)
      run: |
        curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"status\": \"running\", \"step\": \"PACKAGING_ARTIFACT\", \"percent\": 85, \"log\": \"APK prepared and uploaded to GitHub artifacts\"}"

    # ---------------------------------------------------------
    # 6. FINAL CALLBACK â†’ COMPLETE
    # ---------------------------------------------------------
    - name: Notify worker (COMPLETE)
      run: |
        ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"status\": \"success\", \"step\": \"COMPLETE\", \"percent\": 100, \"artifactUrl\": \"$ARTIFACT_URL\", \"log\": \"Build completed successfully\"}"
