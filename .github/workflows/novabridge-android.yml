name: NovaBridge Android Cloud Build v15.9.1

on:
  repository_dispatch:
    types: [novabridge_android_build_v15_7]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      BUILD_ID:     ${{ github.event.client_payload.build_id }}
      ZIP_URL:      ${{ github.event.client_payload.zip_url }}
      APP_NAME:     ${{ github.event.client_payload.app_name }}
      PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
      PROJECT_URL:  ${{ github.event.client_payload.project_url }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üß™ Print Payload
        run: |
          echo "Callback URL: $CALLBACK_URL"
          echo "Build ID: $BUILD_ID"
          echo "ZIP URL: $ZIP_URL"

      - name: üîΩ Download Project ZIP from Worker
        run: |
          CLEAN_URL=$(echo "$ZIP_URL" | tr -d '[:space:]')
          echo "Downloading ZIP from $CLEAN_URL"
          curl -L "$CLEAN_URL" -o project.zip

      - name: üì¶ Extract ZIP
        run: unzip project.zip -d build || echo "ZIP extraction failed"

      - name: üèó Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üèó Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: üß± Run Android Build
        run: |
          cd build
          echo "Simulating Android Build..."
          echo "APK output would be generated here"
          echo "OK" > output.txt

      - name: üì§ Notify Worker (SUCCESS)
        if: success()
        run: |
          CLEAN=$(echo "$CALLBACK_URL" | tr -d '[:space:]')
          echo "Callback: $CLEAN"
          curl -X POST "$CLEAN" \
            -H "Content-Type: application/json" \
            -d '{"build_id":"'"$BUILD_ID"'","status":"success","message":"Build completed"}'

      - name: ‚ùå Notify Worker (FAILURE)
        if: failure()
        run: |
          CLEAN=$(echo "$CALLBACK_URL" | tr -d '[:space:]')
          echo "Callback: $CLEAN"
          curl -X POST "$CLEAN" \
            -H "Content-Type: application/json" \
            -d '{"build_id":"'"$BUILD_ID"'","status":"error","message":"Build failed"}'
