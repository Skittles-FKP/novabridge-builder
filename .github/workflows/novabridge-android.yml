name: NovaBridge Android Cloud Build v16.8

on:
  repository_dispatch:
    types: [novabridge_android_build_v16_8]

  # Optional (manual trigger for testing)
  workflow_dispatch:

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üß™ Show incoming payload
        run: |
          echo "BUILD_ID=${BUILD_ID}"
          echo "ZIP_URL=${ZIP_URL}"
          echo "CALLBACK_URL=${CALLBACK_URL}"

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üß± Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: üì• Download and unzip native Android project
        run: |
          set -e
          if [ -z "$ZIP_URL" ]; then
            echo "‚ùå ZIP_URL missing from dispatch payload"
            exit 1
          fi

          echo "Downloading ZIP from: $ZIP_URL"
          curl -L "$ZIP_URL" -o project.zip

          mkdir -p build
          unzip -q project.zip -d build

          echo "Contents of ./build:"
          ls -R build

      - name: üèó Run Gradle build (release ‚Üí debug fallback)
        working-directory: build/project
        run: |
          set -e
          echo "üìÇ Listing project root:"
          ls -la

          if [ -x "./gradlew" ]; then
            echo "Using Gradle Wrapper"
            ./gradlew assembleRelease --warning-mode all || ./gradlew assembleDebug --warning-mode all
          else
            echo "‚û°Ô∏è Running system Gradle"
            gradle assembleRelease --warning-mode all || gradle assembleDebug --warning-mode all
          fi

      - name: üîç Locate built APK (v16.8 fix)
        id: find_apk
        working-directory: build/project
        run: |
          set -e
          echo "Searching for APKs‚Ä¶"

          APK_PATH=$(find app/build/outputs/apk -type f \
            \( -name "*release*.apk" -o -name "*debug*.apk" \) \
            | head -n 1 || true)

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå No APK found!"
            echo "All output files:"
            find app/build -type f | sed 's/^/  /'
            exit 1
          fi

          echo "Found APK at: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

      - name: ‚òÅÔ∏è Upload APK to Cloudflare R2
        run: |
          set -e

          if [ -z "${{ steps.find_apk.outputs.apk_path }}" ]; then
            echo "‚ùå APK path missing"
            exit 1
          fi

          APK_PATH="${{ steps.find_apk.outputs.apk_path }}"
          DEST_PATH="apks/${BUILD_ID}.apk"

          echo "Configuring AWS CLI for Cloudflare R2‚Ä¶"
          aws configure set aws_access_key_id "${{ secrets.R2_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.R2_SECRET_ACCESS_KEY }}"
          aws configure set default.region us-east-1

          echo "Uploading $APK_PATH ‚Üí s3://${{ secrets.R2_BUCKET }}/$DEST_PATH"

          aws s3 cp "$APK_PATH" \
            "s3://${{ secrets.R2_BUCKET }}/$DEST_PATH" \
            --endpoint-url "https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com"

          ARTIFACT_URL="https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com/${{ secrets.R2_BUCKET }}/$DEST_PATH"

          echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_ENV
          echo "APK uploaded successfully: $ARTIFACT_URL"

      - name: ‚úÖ Notify Worker (success)
        if: success()
        run: |
          set -e
          echo "Notifying Worker SUCCESS ‚Üí ${CALLBACK_URL}"
          curl -X POST "${CALLBACK_URL}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "success" \
              --arg art "$ARTIFACT_URL" \
              --arg msg "Build completed successfully" \
              '{build_id: $id, status: $status, artifact_url: $art, message: $msg}')"

      - name: ‚ùå Notify Worker (failure)
        if: failure()
        run: |
          set -e
          MSG="GitHub Actions Android build failed"
          echo "Notifying Worker FAILURE ‚Üí ${CALLBACK_URL}"
          curl -X POST "${CALLBACK_URL}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "error" \
              --arg msg "$MSG" \
              '{build_id: $id, status: $status, message: $msg}')"
