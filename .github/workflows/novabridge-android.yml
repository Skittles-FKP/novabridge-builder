name: NovaBridge Android Cloud Build v16.2 (Stable)

on:
  repository_dispatch:
    types: [novabridge_android_build_v16_2]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      # Payload from Worker (camelCase or snake_case normalised by Worker)
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      BUILD_ID:     ${{ github.event.client_payload.build_id }}
      APP_NAME:     ${{ github.event.client_payload.app_name }}
      PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
      PROJECT_URL:  ${{ github.event.client_payload.project_url }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üß™ Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: üèó Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: ‚òï Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # üîß Your real Android project generation goes here
      - name: üì¶ Prepare Android project (stub)
        run: |
          set -e
          mkdir -p build/app
          echo "NovaBridge placeholder project" > build/app/README.txt

      # üîß Your real Gradle command goes here
      - name: üèó Run Gradle build (stub)
        working-directory: build
        run: |
          set -e
          echo "Simulating Gradle assembleRelease..."
          echo "Simulated build OK"

      # ---------- SAFE CALLBACKS ----------

      - name: ‚úÖ Notify Worker (success)
        if: success()
        run: |
          if [ -z "${CALLBACK_URL}" ]; then
            echo "No CALLBACK_URL provided ‚Äì skipping success callback."
            exit 0
          fi

          echo "Notifying Worker: success ‚Üí ${CALLBACK_URL}"

          # Do NOT fail build if callback fails
          curl -sS -X POST "${CALLBACK_URL}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "success" \
              --arg msg "GitHub Actions build completed successfully" \
              '{build_id: $id, status: $status, message: $msg, artifact_url: null}')" \
          || echo "Callback (success) failed, but build is already successful."

      - name: ‚ùå Notify Worker (failure)
        if: failure()
        run: |
          if [ -z "${CALLBACK_URL}" ]; then
            echo "No CALLBACK_URL provided ‚Äì skipping failure callback."
            exit 0
          fi

          echo "Notifying Worker: failure ‚Üí ${CALLBACK_URL}"
          MSG="GitHub Actions build failed ‚Äì check workflow logs"

          # Do NOT fail job further if callback fails
          curl -sS -X POST "${CALLBACK_URL}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "error" \
              --arg msg "$MSG" \
              '{build_id: $id, status: $status, message: $msg, artifact_url: null}')" \
          || echo "Callback (failure) failed (curl error), original build error already recorded."
