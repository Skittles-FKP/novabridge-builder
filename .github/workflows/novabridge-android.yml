name: NovaBridge Android Cloud Build

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: "NovaBridge Build ID"
        required: true
        type: string
      zip_url:
        description: "URL to download Android project ZIP (Worker proxy)"
        required: true
        type: string
      callback_url:
        description: "Worker callback URL"
        required: true
        type: string
      app_name:
        description: "App name (for logs)"
        required: false
        type: string
      package_name:
        description: "Android package name (for logs)"
        required: false
        type: string
      project_url:
        description: "Base44 project URL (for logs)"
        required: false
        type: string

jobs:
  android-cloud-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.inputs.build_id }}
      ZIP_URL: ${{ github.event.inputs.zip_url }}
      CALLBACK_URL: ${{ github.event.inputs.callback_url }}
      APP_NAME: ${{ github.event.inputs.app_name }}
      PACKAGE_NAME: ${{ github.event.inputs.package_name }}
      PROJECT_URL: ${{ github.event.inputs.project_url }}

    steps:
      - name: üßæ Show inputs
        run: |
          echo "BUILD_ID: $BUILD_ID"
          echo "ZIP_URL: $ZIP_URL"
          echo "CALLBACK_URL: $CALLBACK_URL"
          echo "APP_NAME: $APP_NAME"
          echo "PACKAGE_NAME: $PACKAGE_NAME"
          echo "PROJECT_URL: $PROJECT_URL"

      - name: üì• Download Android project ZIP
        run: |
          echo "Downloading ZIP from: $ZIP_URL"
          curl -fL "$ZIP_URL" -o project.zip

      - name: üìÇ Extract project
        run: |
          mkdir -p build
          unzip -q project.zip -d build
          echo "Extracted contents:"
          ls -R build

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üß± Run Gradle assembleRelease
        working-directory: build
        run: |
          echo "Running Gradle assembleRelease with system Gradle..."
          gradle --version
          gradle assembleRelease --warning-mode all

      - name: üì¶ Locate APK
        id: find_apk
        working-directory: build
        run: |
          echo "Searching for APK..."
          APK_PATH=$(find . -type f -name "*release*.apk" | head -n 1 || true)
          if [ -z "$APK_PATH" ]; then
            echo "No APK found."
            echo "apk_url=" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "Found APK at: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

      - name: ‚òÅÔ∏è Upload APK as artifact (GitHub)
        if: steps.find_apk.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: novabridge-apk-${{ env.BUILD_ID }}
          path: build/${{ steps.find_apk.outputs.apk_path }}

      - name: üì° Notify Worker ‚Äì success
        if: success()
        run: |
          APK_URL="(GitHub artifact: novabridge-apk-${BUILD_ID})"
          echo "Calling callback: $CALLBACK_URL"
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<JSON
          {
            "buildId": "$BUILD_ID",
            "status": "success",
            "phase": "complete",
            "apkUrl": "$APK_URL",
            "message": "Gradle assembleRelease completed successfully"
          }
JSON

      - name: üì° Notify Worker ‚Äì failure
        if: failure()
        run: |
          echo "Notifying Worker of failure..."
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<JSON
          {
            "buildId": "$BUILD_ID",
            "status": "error",
            "phase": "error",
            "message": "GitHub Actions build failed ‚Äì check workflow logs"
          }
JSON
