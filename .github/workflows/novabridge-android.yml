name: NovaBridge Cloud Android Build

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      # ---- Progress: workflow started ----
      - name: Notify Worker â€“ job started
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL provided, skipping callback."
            exit 0
          fi

          echo "Notifying worker: started"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "started" \
              --arg msg "GitHub Actions workflow started" \
              '{buildId:$id,status:$status,message:$msg}')"

      # ---- Download ZIP from Build Worker ----
      - name: Download ZIP from Worker
        run: |
          if [ -z "$ZIP_URL" ]; then
            echo "âŒ ZIP_URL is empty, cannot continue."
            exit 1
          fi

          mkdir -p build
          echo "Downloading ZIP from $ZIP_URL"
          curl -L "$ZIP_URL" -o build/project.zip
          ls -lh build

      # ---- Progress: downloaded ZIP ----
      - name: Notify Worker â€“ ZIP downloaded
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL provided, skipping callback."
            exit 0
          fi

          echo "Notifying worker: downloading_zip"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "downloading_zip" \
              --arg msg "ZIP downloaded from Build Worker" \
              '{buildId:$id,status:$status,message:$msg}')"

      # ---- Unzip Android project into build/ ----
      - name: Unzip Android project
        run: |
          cd build
          echo "Unzipping project.zip into ./build"
          unzip -o project.zip
          echo "Contents of build/:"
          ls -R .

      # ---- Progress: unzipped ----
      - name: Notify Worker â€“ unzipped project
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL provided, skipping callback."
            exit 0
          fi

          echo "Notifying worker: unzipping"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "unzipping" \
              --arg msg "Android project unzipped into build/" \
              '{buildId:$id,status:$status,message:$msg}')"

      # ---- Detect Android project root via settings.gradle ----
      - name: Detect Android project root
        id: detect_root
        run: |
          echo "Detecting Android project root (settings.gradle)..."
          ROOT=$(find build -maxdepth 2 -name "settings.gradle" -printf '%h\n' | head -n 1 || true)

          if [ -z "$ROOT" ]; then
            echo "âŒ ERROR: Could not find settings.gradle under build/"
            ls -R build || true
            exit 1
          fi

          echo "Detected ROOT: $ROOT"
          echo "ROOT=$ROOT" >> $GITHUB_ENV

      # ---- Progress: root detected ----
      - name: Notify Worker â€“ root detected
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL provided, skipping callback."
            exit 0
          fi

          echo "Notifying worker: detecting_root"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "detecting_root" \
              --arg msg "Gradle project root detected at $ROOT" \
              '{buildId:$id,status:$status,message:$msg}')"

      # ---- Set up JDK 17 ----
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ---- Progress: running Gradle ----
      - name: Notify Worker â€“ running Gradle
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL provided, skipping callback."
            exit 0
          fi

          echo "Notifying worker: building"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "building" \
              --arg msg "Running Gradle assembleRelease" \
              '{buildId:$id,status:$status,message:$msg}')"

      # ---- Build Release APK with system Gradle ----
      - name: Build Release APK with system Gradle
        run: |
          echo "Using ROOT: $ROOT"
          cd "$ROOT"
          echo "ðŸ— Running Gradle assembleRelease with system Gradle..."
          gradle assembleRelease --no-daemon --warning-mode all

      # ---- Find built APK ----
      - name: Find built APK
        id: find_apk
        run: |
          echo "Searching for APK under $ROOT..."
          APK_PATH=$(find "$ROOT" -type f -name "*.apk" | head -n 1 || true)

          if [ -z "$APK_PATH" ]; then
            echo "âŒ No APK found after build"
            exit 1
          fi

          echo "Found APK at: $APK_PATH"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV

      # ---- Progress: success ----
      - name: Notify Worker â€“ build success
        if: success()
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL provided, skipping callback."
            exit 0
          fi

          echo "Notifying worker: success"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "success" \
              --arg msg "Android build completed successfully" \
              --arg apk "$APK_PATH" \
              '{buildId:$id,status:$status,message:$msg,artifactUrl:$apk}')"

      # ---- Progress: failure ----
      - name: Notify Worker â€“ build failed
        if: failure()
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL provided, skipping callback."
            exit 0
          fi

          MSG="GitHub Actions build failed â€“ check workflow logs"
          echo "Notifying worker: error â€“ $MSG"

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "error" \
              --arg msg "$MSG" \
              '{buildId:$id,status:$status,message:$msg}')"
