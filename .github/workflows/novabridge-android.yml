name: NovaBridge Android Cloud Build

on:
  # Direct trigger from NovaBridge Build Worker (via /actions/workflows/â€¦/dispatches)
  workflow_dispatch:
    inputs:
      buildId:
        description: "NovaBridge build ID"
        required: true
        type: string
      zipUrl:
        description: "URL of Android project ZIP"
        required: true
        type: string
      callbackUrl:
        description: "Worker callback URL"
        required: true
        type: string

  # Optional: keep this if you ever use repository_dispatch
  repository_dispatch:
    types: [novabridge-android-build]

jobs:
  android-cloud-build:
    runs-on: ubuntu-latest

    env:
      # Support BOTH workflow_dispatch and repository_dispatch payload styles
      BUILD_ID: ${{ github.event.inputs.buildId || github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.inputs.zipUrl || github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.inputs.callbackUrl || github.event.client_payload.callbackUrl }}

      WORKER_URL: https://novabridge-build-worker.novabridge.workers.dev

    steps:
      # ----------------------------------------------------
      # 1. Basic setup
      # ----------------------------------------------------
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          if [ -z "$BUILD_ID" ] || [ -z "$ZIP_URL" ] || [ -z "$CALLBACK_URL" ]; then
            echo "âŒ Missing one of BUILD_ID / ZIP_URL / CALLBACK_URL"
            exit 1
          fi

      - name: Notify start â†’ Preparing Environment
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$BUILD_ID" '{
              id: $id,
              status: "running",
              phase: "cloud",
              message: "GitHub Actions started",
              progress: {
                percent: 5,
                stepIndex: 1,
                stepsTotal: 7,
                stepLabel: "Preparing Environment",
                status: "running"
              }
            }')"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install unzip, curl, jq
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl jq

      # ----------------------------------------------------
      # 2. Download & extract native Android project
      # ----------------------------------------------------
      - name: Download Android project ZIP
        run: |
          echo "Downloading ZIP from: $ZIP_URL"
          curl -fSL "$ZIP_URL" -o project.zip
          ls -lh project.zip

      - name: Notify â†’ Extracting Native Project
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$BUILD_ID" '{
              id: $id,
              status: "running",
              phase: "cloud",
              message: "Extracting native ZIP",
              progress: {
                percent: 15,
                stepIndex: 2,
                stepsTotal: 7,
                stepLabel: "Extracting Native Project",
                status: "running"
              }
            }')"

      - name: Unzip project
        run: |
          mkdir -p build
          unzip -q project.zip -d build
          echo "Extracted structure:"
          ls -R build || true

      - name: Detect Gradle root
        id: gradle-root
        run: |
          ROOT=""
          if [ -f "build/settings.gradle" ] || [ -f "build/settings.gradle.kts" ]; then
            ROOT="build"
          elif [ -f "build/app/settings.gradle" ] || [ -f "build/app/settings.gradle.kts" ]; then
            ROOT="build/app"
          else
            echo "âŒ Could not find Gradle settings.gradle under build/"
            find build -maxdepth 4 -type f \( -name "settings.gradle" -o -name "settings.gradle.kts" \) -print
            exit 1
          fi
          echo "ROOT=$ROOT" >> $GITHUB_OUTPUT
          echo "Detected Gradle root: $ROOT"

      - name: Notify â†’ Project Extracted
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$BUILD_ID" '{
              id: $id,
              status: "running",
              phase: "cloud",
              message: "Project extracted",
              progress: {
                percent: 25,
                stepIndex: 3,
                stepsTotal: 7,
                stepLabel: "Project Extracted",
                status: "running"
              }
            }')"

      # ----------------------------------------------------
      # 3. Run Gradle build with SYSTEM Gradle (no wrapper assumption)
      # ----------------------------------------------------
      - name: Run Gradle assembleRelease (system Gradle)
        working-directory: ${{ steps.gradle-root.outputs.ROOT }}
        run: |
          echo "Using ROOT: $PWD"
          echo "ðŸ— Running Gradle assembleRelease with system Gradle..."
          gradle assembleRelease --warning-mode all

      - name: Notify â†’ Running Build Tasks
        if: success()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$BUILD_ID" '{
              id: $id,
              status: "running",
              phase: "cloud",
              message: "Gradle build completed",
              progress: {
                percent: 50,
                stepIndex: 4,
                stepsTotal: 7,
                stepLabel: "Running Build Tasks",
                status: "running"
              }
            }')"

      # ----------------------------------------------------
      # 4. Find APK/AAB artifact
      # ----------------------------------------------------
      - name: Locate APK/AAB
        id: apk
        working-directory: ${{ steps.gradle-root.outputs.ROOT }}
        run: |
          echo "Searching for APK/AAB..."
          FILE=$(find . -type f \( -name "*.apk" -o -name "*.aab" \) | head -n 1 || true)
          if [ -z "$FILE" ]; then
            echo "âŒ No APK/AAB found after build."
            find . -maxdepth 6 -type f | sed 's/^/  /'
            exit 1
          fi
          echo "ARTIFACT_PATH=$FILE" >> $GITHUB_OUTPUT
          echo "Found artifact: $FILE"

      - name: Notify â†’ Packaging APK
        if: success()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$BUILD_ID" '{
              id: $id,
              status: "running",
              phase: "cloud",
              message: "Packaging APK",
              progress: {
                percent: 75,
                stepIndex: 5,
                stepsTotal: 7,
                stepLabel: "Packaging APK",
                status: "running"
              }
            }')"

      # ----------------------------------------------------
      # 5. Upload artifact back to Worker (R2 handled there)
      # ----------------------------------------------------
      - name: Upload artifact to Worker/R2
        if: success()
        env:
          ARTIFACT_PATH: ${{ steps.apk.outputs.ARTIFACT_PATH }}
        run: |
          echo "Uploading $ARTIFACT_PATH via Worker..."
          curl -X POST "${WORKER_URL}/api/builds/upload" \
            -H "Content-Type: application/octet-stream" \
            -H "x-build-id: ${BUILD_ID}" \
            --data-binary "@${ARTIFACT_PATH}"

      - name: Notify success
        if: success()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$BUILD_ID" '{
              id: $id,
              status: "success",
              phase: "cloud",
              message: "Android cloud build complete",
              progress: {
                percent: 100,
                stepIndex: 7,
                stepsTotal: 7,
                stepLabel: "Build Complete",
                status: "success"
              }
            }')"

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$BUILD_ID" '{
              id: $id,
              status: "error",
              phase: "cloud",
              message: "GitHub Actions build failed â€“ check workflow logs",
              progress: {
                percent: 50,
                stepIndex: 4,
                stepsTotal: 7,
                stepLabel: "Running Build Tasks",
                status: "error"
              }
            }')"
          exit 1
