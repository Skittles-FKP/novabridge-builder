name: NovaBridge Android Cloud Build

on:
  repository_dispatch:
    types: [android-cloud-build]

jobs:
  android-build:
    runs-on: ubuntu-latest

    steps:

    # -----------------------------------------
    # STEP 0: Parse GitHub Dispatch Payload
    # -----------------------------------------
    - name: Extract Build Metadata
      id: meta
      run: |
        echo "BUILD_ID=${{ github.event.client_payload.buildId }}" >> $GITHUB_ENV
        echo "ZIP_URL=${{ github.event.client_payload.zipUrl }}" >> $GITHUB_ENV
        echo "CALLBACK=https://novabridge-build-worker.novabridge.workers.dev/api/builds/callback" >> $GITHUB_ENV

    # -----------------------------------------
    # STEP 1: Notify Worker – Environment Ready
    # -----------------------------------------
    - name: Notify Worker - Preparing Environment
      run: |
        curl -X POST $CALLBACK \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"phase\": \"Preparing Environment\", \"percent\": 5, \"status\": \"running\"}"

    - name: Checkout Repo
      uses: actions/checkout@v4

    # -----------------------------------------
    # STEP 2: Download Source ZIP
    # -----------------------------------------
    - name: Download ZIP from Worker
      run: |
        mkdir -p build_src
        curl -L "$ZIP_URL" -o build_src/project.zip

        curl -X POST $CALLBACK \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"phase\": \"Extracting Native Project\", \"percent\": 15}"

    # -----------------------------------------
    # STEP 3: Extract ZIP
    # -----------------------------------------
    - name: Extract Project ZIP
      run: |
        unzip -o build_src/project.zip -d build

        curl -X POST $CALLBACK \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"phase\": \"Project Extracted\", \"percent\": 25}"

    # -----------------------------------------
    # STEP 4: Install JDK + Android SDK
    # -----------------------------------------
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: "temurin"
        java-version: "17"

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # -----------------------------------------
    # STEP 5: Locate Gradle Wrapper
    # -----------------------------------------
    - name: Locate Gradle Root
      id: gradle
      run: |
        ROOT=$(find build -name "gradlew" -printf "%h" | head -n 1)
        if [ -z "$ROOT" ]; then
          echo "ERROR: No gradlew found."
          exit 1
        fi
        echo "ROOT=$ROOT" >> $GITHUB_ENV

        curl -X POST $CALLBACK \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"phase\": \"Running Build Tasks\", \"percent\": 40}"

    # -----------------------------------------
    # STEP 6: Build APK
    # -----------------------------------------
    - name: Run Android Build
      run: |
        cd "$ROOT"
        chmod +x ./gradlew
        ./gradlew assembleRelease --warning-mode all

    # Notify Worker: Build Completed or Error
      continue-on-error: true

    - name: Notify Worker - Build Result
      run: |
        if [ "${{ steps.gradle.outcome }}" = "failure" ]; then
          curl -X POST $CALLBACK \
            -H "Content-Type: application/json" \
            -d "{\"buildId\": \"$BUILD_ID\", \"phase\": \"Build Failed\", \"status\": \"error\", \"percent\": 50}"
          exit 1
        else
          curl -X POST $CALLBACK \
            -H "Content-Type: application/json" \
            -d "{\"buildId\": \"$BUILD_ID\", \"phase\": \"Packaging APK\", \"percent\": 70}"
        fi

    # -----------------------------------------
    # STEP 7: Find Generated APK
    # -----------------------------------------
    - name: Locate APK
      id: apk
      run: |
        APK=$(find build -name "*.apk" | head -n 1)
        echo "APK=$APK" >> $GITHUB_ENV
        echo "Found APK: $APK"

        curl -X POST $CALLBACK \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"phase\": \"Uploading to R2\", \"percent\": 85}"

    # -----------------------------------------
    # STEP 8: Upload APK to Worker → R2
    # -----------------------------------------
    - name: Upload Artifact to Worker
      run: |
        curl -X POST "https://novabridge-build-worker.novabridge.workers.dev/api/builds/upload-apk" \
          -H "Content-Type: application/octet-stream" \
          -H "X-Build-Id: $BUILD_ID" \
          --data-binary @"$APK"

        curl -X POST $CALLBACK \
          -H "Content-Type: application/json" \
          -d "{\"buildId\": \"$BUILD_ID\", \"phase\": \"Build Complete\", \"percent\": 100, \"status\": \"complete\"}"
