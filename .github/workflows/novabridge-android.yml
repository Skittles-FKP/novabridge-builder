name: NovaBridge Cloud Android Build

on:
  workflow_dispatch:
    inputs:
      buildId:
        description: "Build ID"
        required: true
      zipUrl:
        description: "Download URL from Worker"
        required: true
      callbackUrl:
        description: "Worker callback URL"
        required: true
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl || github.event.inputs.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl || github.event.inputs.callbackUrl }}

    steps:
      - name: ğŸ” Validate Inputs
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: ğŸ“¡ Notify Worker â€” Preparing Environment
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"id\":\"$BUILD_ID\",\"phase\":\"prepare\",\"status\":\"running\",\"progress\":5,\"message\":\"Preparing build environment...\"}"

      - name: ğŸ§° Install JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: ğŸ“¦ Download Project ZIP
        run: |
          mkdir -p build
          curl -L "$ZIP_URL" -o build/project.zip

      - name: ğŸ—‚ Extract Project
        run: |
          unzip -o build/project.zip -d build
          echo "Contents:"
          ls -R build

      - name: ğŸ“¡ Notify Worker â€” Project Extracted
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"id\":\"$BUILD_ID\",\"phase\":\"extract\",\"status\":\"running\",\"progress\":20,\"message\":\"Native project extracted\"}"

      - name: ğŸ” Detect Gradle Root (app folder)
        id: detect_root
        run: |
          ROOT=$(cd build && find . -name "settings.gradle" -o -name "settings.gradle.kts" | head -n 1 | sed 's|^\./||' | xargs dirname)
          echo "ROOT=$ROOT"
          echo "ROOT=$ROOT" >> $GITHUB_ENV

      - name: ğŸ“¡ Notify Worker â€” Running Gradle Tasks
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"id\":\"$BUILD_ID\",\"phase\":\"gradle\",\"status\":\"running\",\"progress\":40,\"message\":\"Running Gradle build tasks...\"}"

      - name: ğŸ— Build APK (assembleRelease)
        run: |
          cd build/$ROOT
          gradle assembleRelease --warning-mode all

      - name: ğŸ“ Locate Release APK
        id: apk
        run: |
          APK=$(find build -name "*.apk" | head -n 1)
          echo "APK=$APK"
          echo "APK=$APK" >> $GITHUB_ENV

      - name: ğŸ“¡ Notify Worker â€” Packaging Complete
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"id\":\"$BUILD_ID\",\"phase\":\"package\",\"status\":\"running\",\"progress\":70,\"message\":\"APK packaged\"}"

      - name: ğŸ“¤ Upload to Worker R2
        run: |
          ARTIFACT_URL="https://novabridge-build-worker.novabridge.workers.dev/upload/$BUILD_ID"
          curl -X POST "$ARTIFACT_URL" \
            -H "Content-Type: application/zip" \
            --data-binary @"$APK"
          echo "ARTIFACT_URL=$ARTIFACT_URL" >> $GITHUB_ENV

      - name: ğŸŸ¢ Final Callback â€” Build Complete
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"id\":\"$BUILD_ID\",\"phase\":\"complete\",\"status\":\"success\",\"progress\":100,\"message\":\"Build Completed Successfully\",\"artifactUrl\":\"$ARTIFACT_URL\"}"

      - name: ğŸ‘ Done
        run: echo "Build workflow finished successfully."
