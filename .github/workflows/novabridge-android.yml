# .github/workflows/novabridge-android-v16-5.yml

name: NovaBridge Cloud Build (Android v16.5)

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      # Populated from repository_dispatch client_payload
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show incoming payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: Download ZIP from Worker
        run: |
          set -e
          mkdir -p build
          echo "Downloading ZIP from: $ZIP_URL"
          curl -L "$ZIP_URL" -o build/source.zip

      - name: Extract Android project
        run: |
          set -e
          mkdir -p build/project
          unzip -o build/source.zip -d build/project

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build APK (release → debug fallback)
        working-directory: build/project
        run: |
          set -e
          echo "Listing project root:"
          ls -la

          if [ -x "./gradlew" ]; then
            echo "Using Gradle Wrapper..."
            ./gradlew assembleRelease --warning-mode all || ./gradlew assembleDebug --warning-mode all
          else
            echo "No Gradle wrapper found, using system gradle..."
            gradle assembleRelease --warning-mode all || gradle assembleDebug --warning-mode all
          fi

      - name: Find APK
        id: find_apk
        run: |
          set -e
          echo "Searching for APK under ./build..."
          APK=$(find build -name "*.apk" | head -n 1 || true)
          if [ -z "$APK" ]; then
            echo "No APK file found!"
            exit 1
          fi
          echo "Found APK at: $APK"
          echo "APK_PATH=$APK" >> $GITHUB_ENV

      - name: Upload APK to R2
        run: |
          set -e
          if [ -z "$APK_PATH" ]; then
            echo "APK_PATH not set!"
            exit 1
          fi

          echo "Configuring AWS CLI for Cloudflare R2..."
          aws configure set aws_access_key_id "${{ secrets.R2_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.R2_SECRET_ACCESS_KEY }}"
          aws configure set default.region auto

          DEST_PATH="artifacts/${BUILD_ID}/app-release.apk"
          echo "Uploading $APK_PATH to R2 bucket s3://${{ secrets.R2_BUCKET }}/$DEST_PATH"

          aws s3 cp "$APK_PATH" \
            "s3://${{ secrets.R2_BUCKET }}/$DEST_PATH" \
            --endpoint-url "https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com"

          ARTIFACT_URL="https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com/${{ secrets.R2_BUCKET }}/$DEST_PATH"
          echo "ARTIFACT_URL=$ARTIFACT_URL" >> $GITHUB_ENV
          echo "APK uploaded to: $ARTIFACT_URL"

      - name: Notify Worker Callback (success)
        if: success()
        run: |
          set -e
          echo "Notifying Worker: success → $CALLBACK_URL"
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"buildId\":\"${BUILD_ID}\",\"status\":\"success\",\"artifactUrl\":\"${ARTIFACT_URL}\"}" \
            "$CALLBACK_URL"

      - name: Notify Worker Callback (failure)
        if: failure()
        run: |
          set -e
          echo "Notifying Worker: failure → $CALLBACK_URL"
          MSG="GitHub Actions build failed – check workflow logs"
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"buildId\":\"${BUILD_ID}\",\"status\":\"error\",\"message\":\"${MSG}\"}" \
            "$CALLBACK_URL" || true
