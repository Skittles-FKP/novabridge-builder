name: novabridge cloud build (android)

on:
  # Triggered by the Worker via repository_dispatch
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # Tell Worker: GitHub job has started
      # ----------------------------------------------------------
      - name: Notify Worker â€“ running
        run: |
          echo "Notifying Worker that build is running..."
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
                  --arg id "$BUILD_ID" \
                  --arg st "running" \
                  --arg msg "GitHub Actions job started" \
                  '{buildId:$id, status:$st, message:$msg}')"

      # ----------------------------------------------------------
      # Download ZIP that Worker generated (Android project)
      # ----------------------------------------------------------
      - name: Download ZIP from Worker
        run: |
          mkdir -p build
          echo "Downloading ZIP from $ZIP_URL"
          curl -L "$ZIP_URL" -o build/project.zip

      - name: Unzip Android project (root = project/)
        run: |
          mkdir -p build/project
          unzip -o build/project.zip -d build/project
          echo "Project tree:"
          ls -R build/project

      # ----------------------------------------------------------
      # Java / Gradle setup
      # ----------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: Run Gradle assembleRelease
        run: |
          cd build/project
          echo "ðŸ— Running Gradle assembleRelease..."
          gradle assembleRelease

      # ----------------------------------------------------------
      # Find built APK
      # ----------------------------------------------------------
      - name: Find APK
        id: find_apk
        run: |
          APK_PATH=$(find build/project -name "*.apk" | head -n 1 || true)
          echo "APK_PATH=$APK_PATH"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV

      # ----------------------------------------------------------
      # Notify Worker on SUCCESS (APK built)
      # ----------------------------------------------------------
      - name: Notify Worker â€“ success
        if: env.APK_PATH != ''
        run: |
          echo "Notifying Worker of success..."
          # Later you can replace this with a real public URL
          ARTIFACT_URL="file://$APK_PATH"
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
                  --arg id "$BUILD_ID" \
                  --arg st "success" \
                  --arg url "$ARTIFACT_URL" \
                  --arg msg "Android APK built successfully." \
                  '{buildId:$id, status:$st, artifactUrl:$url, message:$msg}')"

      # ----------------------------------------------------------
      # Notify Worker on FAILURE (any step fails)
      # ----------------------------------------------------------
      - name: Notify Worker â€“ failed
        if: failure()
        run: |
          echo "Notifying Worker of failure..."
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
                  --arg id "$BUILD_ID" \
                  --arg st "failed" \
                  --arg msg "GitHub Actions build failed â€“ check GitHub logs." \
                  '{buildId:$id, status:$st, message:$msg}')"
