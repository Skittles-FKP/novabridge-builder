name: NovaBridge Android Cloud Build

on:
  repository_dispatch:
    types:
      - novabridge-android-build

jobs:
  android-cloud-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify: Preparing environment
        run: |
          echo "Preparing environment for build $BUILD_ID"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "buildId": "$BUILD_ID",
            "status": "running",
            "phase": "preparing",
            "progress": {
              "percent": 5,
              "stepIndex": 0,
              "stepsTotal": 7,
              "stepLabel": "Preparing Environment",
              "status": "running",
              "message": "GitHub runner is starting"
            }
          }
          EOF

      - name: Download native project ZIP
        run: |
          echo "Downloading ZIP from: $ZIP_URL"
          curl -fSL "$ZIP_URL" -o native-project.zip

      - name: Notify: Extracting native project
        run: |
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "buildId": "$BUILD_ID",
            "status": "running",
            "phase": "extracting",
            "progress": {
              "percent": 15,
              "stepIndex": 1,
              "stepsTotal": 7,
              "stepLabel": "Extracting Native Project",
              "status": "running",
              "message": "Unzipping native Android project"
            }
          }
          EOF

      - name: Extract project
        run: |
          mkdir -p build
          unzip -o native-project.zip -d build

      - name: Notify: Project extracted
        run: |
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "buildId": "$BUILD_ID",
            "status": "running",
            "phase": "project-extracted",
            "progress": {
              "percent": 25,
              "stepIndex": 2,
              "stepsTotal": 7,
              "stepLabel": "Project Extracted",
              "status": "running",
              "message": "Android project extracted, preparing Gradle build"
            }
          }
          EOF

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Notify: Running build tasks
        run: |
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "buildId": "$BUILD_ID",
            "status": "running",
            "phase": "running-build-tasks",
            "progress": {
              "percent": 50,
              "stepIndex": 3,
              "stepsTotal": 7,
              "stepLabel": "Running Build Tasks",
              "status": "running",
              "message": "Executing Gradle assembleRelease"
            }
          }
          EOF

      - name: Run Gradle assembleRelease (system Gradle)
        working-directory: build
        run: |
          echo "Using ROOT: build"
          echo "ðŸ— Running Gradle assembleRelease with system Gradle..."
          gradle assembleRelease --warning-mode all

      - name: Notify: Packaging APK
        if: success()
        run: |
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "buildId": "$BUILD_ID",
            "status": "running",
            "phase": "packaging",
            "progress": {
              "percent": 70,
              "stepIndex": 4,
              "stepsTotal": 7,
              "stepLabel": "Packaging APK",
              "status": "running",
              "message": "Locating release APK"
            }
          }
          EOF

      - name: Locate APK
        if: success()
        id: find_apk
        working-directory: build
        run: |
          APK_PATH=$(find . -type f -name "*release*.apk" | head -n 1 || true)
          if [ -z "$APK_PATH" ]; then
            echo "No APK found!"
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK at: $APK_PATH"

      - name: Upload APK as GitHub artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: novabridge-android-apk-${{ env.BUILD_ID }}
          path: build/${{ steps.find_apk.outputs.apk_path }}
          if-no-files-found: error

      - name: Notify: Build complete
        if: success()
        run: |
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "buildId": "$BUILD_ID",
            "status": "success",
            "phase": "complete",
            "artifactUrl": "${ARTIFACT_URL}",
            "progress": {
              "percent": 100,
              "stepIndex": 6,
              "stepsTotal": 7,
              "stepLabel": "Build Complete",
              "status": "success",
              "message": "Build finished successfully. Download APK from GitHub Actions artifacts."
            }
          }
          EOF

      - name: Notify: Build failed
        if: failure()
        run: |
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "buildId": "$BUILD_ID",
            "status": "error",
            "phase": "error",
            "progress": {
              "percent": 50,
              "stepIndex": 3,
              "stepsTotal": 7,
              "stepLabel": "Running Build Tasks",
              "status": "error",
              "message": "GitHub Actions build failed â€“ check workflow logs"
            }
          }
          EOF
