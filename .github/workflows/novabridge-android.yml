name: NovaBridge Android Cloud Build v16.5 (Hybrid, Real Gradle)

on:
  repository_dispatch:
    types: [novabridge_android_build_v16_5]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      BUILD_ID:     ${{ github.event.client_payload.build_id }}
      ZIP_URL:      ${{ github.event.client_payload.zip_url }}
      APP_NAME:     ${{ github.event.client_payload.app_name }}
      PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
      PROJECT_URL:  ${{ github.event.client_payload.project_url }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üß™ Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"

      - name: üì• Download native project ZIP
        run: |
          if [ -z "$ZIP_URL" ]; then
            echo "‚ùå Missing ZIP_URL"
            exit 1
          fi
          curl -fSL "$ZIP_URL" -o project.zip
          ls -lh project.zip

      - name: üì¶ Unzip project
        run: |
          mkdir -p project
          unzip -q project.zip -d project
          echo "Unzipped contents:"
          ls -R project || true

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üõ† Make Gradle wrapper executable
        run: |
          if [ -f project/gradlew ]; then
            chmod +x project/gradlew
          else
            echo "‚ùå gradlew missing"
            exit 1
          fi

      - name: üèó Gradle assembleRelease
        working-directory: project
        run: |
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: üîç Locate release APK
        id: find_apk
        run: |
          APK=$(find project -type f -name "*release*.apk" | head -n 1 || true)
          if [ -z "$APK" ]; then
            echo "‚ùå No release APK found"
            exit 1
          fi
          echo "apk_path=$APK" >> $GITHUB_OUTPUT
          echo "Found APK: $APK"

      - name: üîê Configure R2 credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws-region: auto

      - name: ‚òÅÔ∏è Upload APK to Cloudflare R2
        id: upload_r2
        run: |
          APK_PATH="${{ steps.find_apk.outputs.apk_path }}"
          OBJECT_KEY="android/${BUILD_ID}.apk"

          echo "Uploading APK ‚Üí R2 object: ${OBJECT_KEY}"

          aws s3 cp "$APK_PATH" \
            "s3://novabridge-builds/$OBJECT_KEY" \
            --endpoint-url "https://cf73b96d9ea070a2b23419c8e549ea58.r2.cloudflarestorage.com"

          ART_URL="https://pub-5c67d577d84a45a98ab4740047d6b178.r2.dev/$OBJECT_KEY"
          echo "artifact_url=$ART_URL" >> $GITHUB_OUTPUT
          echo "Public APK URL: $ART_URL"

      - name: ‚úÖ Notify Worker (SUCCESS)
        if: success()
        run: |
          ART_URL="${{ steps.upload_r2.outputs.artifact_url }}"
          DATA=$(jq -n \
            --arg id "$BUILD_ID" \
            --arg st "success" \
            --arg msg "Gradle build completed successfully" \
            --arg art "$ART_URL" \
            '{build_id:$id,status:$st,message:$msg,artifact_url:$art}')
          curl -X POST "$CALLBACK_URL" -H "Content-Type: application/json" -d "$DATA"

      - name: ‚ùå Notify Worker (FAILURE)
        if: failure()
        run: |
          DATA=$(jq -n \
            --arg id "$BUILD_ID" \
            --arg st "error" \
            --arg msg "Gradle build failed ‚Äî check GitHub logs" \
            '{build_id:$id,status:$st,message:$msg}')
          curl -X POST "$CALLBACK_URL" -H "Content-Type: application/json" -d "$DATA"
