name: NovaBridge Android Cloud Build v16.8

on:
  # Main: Worker repository_dispatch
  repository_dispatch:
    types: [novabridge_android_build_v16_8]

  # Optional: manual trigger for debugging (no payload!)
  workflow_dispatch:

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      # From repository_dispatch client_payload
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

      # R2 secrets (configure in repo settings)
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üß™ Show incoming payload
        run: |
          echo "BUILD_ID=${BUILD_ID}"
          echo "ZIP_URL=${ZIP_URL}"
          echo "CALLBACK_URL=${CALLBACK_URL}"

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üß± Setup Gradle 8.2.1
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.2.1

      - name: üì• Download and unzip native project
        run: |
          set -e

          if [ -z "$ZIP_URL" ]; then
            echo "‚ùå ZIP_URL missing in repository_dispatch payload"
            exit 1
          fi

          mkdir -p build/project

          echo "Downloading ZIP from: $ZIP_URL"
          curl -L "$ZIP_URL" -o project.zip

          echo "Unzipping to ./build/project..."
          unzip -q project.zip -d build/project

          echo "Contents of ./build/project:"
          ls -R build/project

      - name: üèó Run Gradle build (release ‚Üí debug fallback)
        working-directory: build/project
        run: |
          set -e
          echo "Listing project root (build/project):"
          ls -la

          if command -v gradle >/dev/null 2>&1; then
            echo "Using system Gradle (via setup-gradle 8.2.1)..."
            gradle --version
          fi

          if [ -x "./gradlew" ]; then
            echo "Using Gradle Wrapper..."
            ./gradlew assembleRelease --warning-mode all || ./gradlew assembleDebug --warning-mode all
          else
            echo "No Gradle wrapper found, using system gradle..."
            gradle assembleRelease --warning-mode all || gradle assembleDebug --warning-mode all
          fi

      - name: üîç Locate built APK
        id: find_apk
        working-directory: build/project
        run: |
          set -e
          echo "Searching for *.apk under app/build/outputs..."
          APK_PATH=$(find app/build/outputs -type f -name "*.apk" | head -n 1 || true)

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå No APK produced!"
            exit 1
          fi

          echo "Found APK at: $APK_PATH"
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"

      - name: ‚òÅÔ∏è Upload APK to Cloudflare R2
        id: upload_r2
        env:
          AWS_ACCESS_KEY_ID: ${{ env.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ env.R2_SECRET_ACCESS_KEY }}
          AWS_EC2_METADATA_DISABLED: "true"
        run: |
          set -e

          if [ -z "${{ steps.find_apk.outputs.apk_path }}" ]; then
            echo "‚ùå apk_path output not found"
            exit 1
          fi

          APK_PATH="${{ steps.find_apk.outputs.apk_path }}"
          DEST_PATH="apks/${BUILD_ID}.apk"

          echo "Uploading $APK_PATH to R2 bucket s3://${R2_BUCKET}/${DEST_PATH}"

          aws s3 cp "$APK_PATH" \
            "s3://${R2_BUCKET}/${DEST_PATH}" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --region auto

          ARTIFACT_URL="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com/${R2_BUCKET}/${DEST_PATH}"

          echo "ARTIFACT_URL=$ARTIFACT_URL"
          echo "artifact_url=$ARTIFACT_URL" >> "$GITHUB_OUTPUT"

      - name: ‚úÖ Notify Worker (success)
        if: success() && env.CALLBACK_URL != ''
        run: |
          set -e
          ARTIFACT_URL="${{ steps.upload_r2.outputs.artifact_url }}"

          echo "Notifying Worker: success ‚Üí ${CALLBACK_URL}"
          curl -X POST "${CALLBACK_URL}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "success" \
              --arg msg "GitHub Actions build completed successfully" \
              --arg art "$ARTIFACT_URL" \
              '{build_id: $id, status: $status, message: $msg, artifact_url: $art}')"

      - name: ‚ùå Notify Worker (failure)
        if: failure() && env.CALLBACK_URL != ''
        run: |
          set -e
          MSG="GitHub Actions build failed ‚Äì check workflow logs"

          echo "Notifying Worker: failure ‚Üí ${CALLBACK_URL}"
          curl -X POST "${CALLBACK_URL}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "error" \
              --arg msg "$MSG" \
              '{build_id: $id, status: $status, message: $msg, artifact_url: null}')"
