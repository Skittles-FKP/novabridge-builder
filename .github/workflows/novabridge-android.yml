name: NovaBridge Cloud Build (Android)

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.buildId }}
      ZIP_URL: ${{ github.event.client_payload.zipUrl }}
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}
      PROGRESS_URL: ${{ github.event.client_payload.progressUrl }}

    steps:
      # ----------------------------------------------------------
      # 1) Checkout
      # ----------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          echo "PROGRESS_URL=$PROGRESS_URL"

      - name: Notify progress â€“ Preparing environment (5%)
        run: |
          curl -s -X POST "$PROGRESS_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"step\":\"Preparing environment\",\"progress\":5,\"status\":\"running\"}" || true

      # ----------------------------------------------------------
      # 2) Download ZIP from Worker
      # ----------------------------------------------------------
      - name: Download ZIP from Worker
        run: |
          mkdir -p build
          echo "Downloading ZIP from $ZIP_URL"
          curl -L "$ZIP_URL" -o build/project.zip

      - name: Notify progress â€“ Generating native project (20%)
        run: |
          curl -s -X POST "$PROGRESS_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"step\":\"Unzipping native project\",\"progress\":20,\"status\":\"running\"}" || true

      # ----------------------------------------------------------
      # 3) Unzip Android project (root = project/)
      # ----------------------------------------------------------
      - name: Unzip Android project
        run: |
          mkdir -p build/project
          unzip -o build/project.zip -d build/project
          ls -R build/project

      # ----------------------------------------------------------
      # 4) JDK 17
      # ----------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ----------------------------------------------------------
      # 5) Ensure Gradle wrapper = 8.7 (AGP 8.2.2 compatible)
      # ----------------------------------------------------------
      - name: Ensure Gradle wrapper 8.7
        run: |
          cd build/project
          if [ ! -f "./gradlew" ]; then
            echo "gradlew not found, generating wrapper with Gradle 8.7..."
            # Use system gradle just to generate wrapper
            gradle wrapper --gradle-version 8.7 || ./gradlew wrapper --gradle-version 8.7 || true
          fi
          chmod +x ./gradlew
          ls

      - name: Notify progress â€“ Running Gradle assembleRelease (40%)
        run: |
          curl -s -X POST "$PROGRESS_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"step\":\"Running Gradle assembleRelease\",\"progress\":40,\"status\":\"running\"}" || true

      # ----------------------------------------------------------
      # 6) Build Release APK with Gradle wrapper (8.7)
      # ----------------------------------------------------------
      - name: Build Release APK
        run: |
          cd build/project
          echo "ðŸ— Running ./gradlew assembleRelease (Gradle 8.7)..."
          ./gradlew assembleRelease --stacktrace

      # If Gradle fails, mark progress as error
      - name: Notify progress â€“ Gradle failed
        if: failure()
        run: |
          curl -s -X POST "$PROGRESS_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"step\":\"Gradle build failed\",\"progress\":40,\"status\":\"error\"}" || true

      # ----------------------------------------------------------
      # 7) Find APK
      # ----------------------------------------------------------
      - name: Find APK
        id: find_apk
        run: |
          cd build/project
          APK_PATH=$(find . -name "*.apk" | head -n 1)
          echo "Found APK: $APK_PATH"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV

      - name: Notify progress â€“ Packaging artifact (80%)
        if: env.APK_PATH != ''
        run: |
          curl -s -X POST "$PROGRESS_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"step\":\"Packaging APK\",\"progress\":80,\"status\":\"running\"}" || true

      # ----------------------------------------------------------
      # 8) Upload APK as GitHub artifact (optional)
      # ----------------------------------------------------------
      - name: Upload APK as GitHub artifact
        if: env.APK_PATH != ''
        uses: actions/upload-artifact@v4
        with:
          name: novabridge-android-apk-${{ env.BUILD_ID }}
          path: ${{ env.APK_PATH }}

      # ----------------------------------------------------------
      # 9) Notify Worker callback (success)
      # ----------------------------------------------------------
      - name: Notify NovaBridge Worker callback (success)
        if: env.APK_PATH != ''
        run: |
          MSG="APK built and uploaded as GitHub artifact: novabridge-android-apk-${BUILD_ID}"
          PAYLOAD=$(jq -n \
            --arg id "$BUILD_ID" \
            --arg url "" \
            --arg msg "$MSG" \
            '{buildId: $id, status: "success", artifactUrl: $url, message: $msg}')
          echo "Sending callback payload: $PAYLOAD"
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" || true

          # Also mark progress complete
          curl -s -X POST "$PROGRESS_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"step\":\"Build complete\",\"progress\":100,\"status\":\"success\"}" || true

      # ----------------------------------------------------------
      # 10) If no APK was found, notify error
      # ----------------------------------------------------------
      - name: Notify NovaBridge Worker callback (no APK)
        if: env.APK_PATH == ''
        run: |
          MSG="Build finished but no APK was found in the project directory."
          PAYLOAD=$(jq -n \
            --arg id "$BUILD_ID" \
            --arg msg "$MSG" \
            '{buildId: $id, status: "error", artifactUrl: null, message: $msg}')
          echo "Sending error callback payload: $PAYLOAD"
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" || true

          curl -s -X POST "$PROGRESS_URL" \
            -H "Content-Type: application/json" \
            -d "{\"buildId\":\"$BUILD_ID\",\"step\":\"Build finished but no APK found\",\"progress\":40,\"status\":\"error\"}" || true
