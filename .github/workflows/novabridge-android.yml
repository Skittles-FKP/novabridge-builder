# .github/workflows/novabridge-android-v16-5.yml

name: NovaBridge Android Cloud Build v16.5 (Hybrid)

on:
  repository_dispatch:
    types: [novabridge_android_build_v16_5]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      BUILD_ID:     ${{ github.event.client_payload.build_id }}
      ZIP_URL:      ${{ github.event.client_payload.zip_url }}
      APP_NAME:     ${{ github.event.client_payload.app_name }}
      PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
      PROJECT_URL:  ${{ github.event.client_payload.project_url }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üß™ Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"

      - name: üì• Download placeholder native ZIP
        run: |
          set -e
          if [ -z "$ZIP_URL" ]; then
            echo "No ZIP_URL provided, skipping download."
          else
            echo "Downloading ZIP from $ZIP_URL"
            curl -fSL "$ZIP_URL" -o project.zip
            ls -lh project.zip || true
          fi

      - name: üèó Simulated Android build
        run: |
          echo "Pretending to run Gradle build for now..."
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"
          # TODO: unzip project.zip and run ./gradlew assembleRelease here later

      - name: ‚úÖ Notify Worker (success)
        if: success()
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL; skipping callback."
            exit 0
          fi

          echo "Notifying Worker of SUCCESS ‚Üí $CALLBACK_URL"
          DATA=$(jq -n \
            --arg id  "$BUILD_ID" \
            --arg st  "success" \
            --arg msg "GitHub Actions build completed successfully (simulated)" \
            --arg art "$ZIP_URL" \
            '{build_id:$id,status:$st,message:$msg,artifact_url:$art}')

          echo "Payload: $DATA"
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$DATA"

      - name: ‚ùå Notify Worker (failure)
        if: failure()
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL; skipping callback."
            exit 0
          fi

          echo "Notifying Worker of FAILURE ‚Üí $CALLBACK_URL"
          MSG="GitHub Actions build failed ‚Äì check workflow logs"

          DATA=$(jq -n \
            --arg id  "$BUILD_ID" \
            --arg st  "error" \
            --arg msg "$MSG" \
            '{build_id:$id,status:$st,message:$msg}')

          echo "Payload: $DATA"
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$DATA"
