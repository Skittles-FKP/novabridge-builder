name: NovaBridge Android Cloud Build

on:
  workflow_dispatch:
    inputs:
      buildId:
        description: "NovaBridge Build ID (camelCase)"
        required: false
        type: string
      build_id:
        description: "NovaBridge Build ID (snake_case)"
        required: false
        type: string

      zipUrl:
        description: "ZIP URL (camelCase)"
        required: false
        type: string
      zip_url:
        description: "ZIP URL (snake_case)"
        required: false
        type: string

      callbackUrl:
        description: "Callback URL (camelCase)"
        required: false
        type: string
      callback_url:
        description: "Callback URL (snake_case)"
        required: false
        type: string

jobs:
  android-cloud-build:
    runs-on: ubuntu-latest

    env:
      # Merge both camelCase + snake_case inputs
      BUILD_ID: ${{ github.event.inputs.buildId || github.event.inputs.build_id }}
      ZIP_URL: ${{ github.event.inputs.zipUrl || github.event.inputs.zip_url }}
      CALLBACK_URL: ${{ github.event.inputs.callbackUrl || github.event.inputs.callback_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show merged inputs
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      # 1️⃣ Preparing Environment
      - name: Callback – preparing
        run: |
          curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"id\":\"$BUILD_ID\",\"status\":\"running\",\"progress\":{\"percent\":5,\"stepLabel\":\"Preparing Environment\"}}"

      # 2️⃣ Download ZIP
      - name: Download ZIP
        run: |
          echo "Downloading ZIP from $ZIP_URL"
          curl -fSL "$ZIP_URL" -o native.zip

      # 3️⃣ Extract ZIP
      - name: Extract ZIP
        run: |
          mkdir -p build
          unzip -q native.zip -d build

      - name: Callback – extracted
        run: |
          curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"id\":\"$BUILD_ID\",\"progress\":{\"percent\":25,\"stepLabel\":\"Project Extracted\"}}"

      # 4️⃣ Install JDK for Gradle
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 5️⃣ Run Gradle build
      - name: Callback – running build
        run: |
          curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"id\":\"$BUILD_ID\",\"progress\":{\"percent\":50,\"stepLabel\":\"Running Build Tasks\"}}"

      - name: Run assembleRelease
        working-directory: build
        run: |
          gradle :app:assembleRelease --warning-mode all

      # 6️⃣ Find APK
      - name: Find APK
        id: find_apk
        working-directory: build
        run: |
          APK=$(find . -name "*release*.apk" | head -n 1)
          echo "APK_PATH=$APK" >> $GITHUB_OUTPUT

      # 7️⃣ Upload APK to Worker → R2
      - name: Upload APK to R2
        id: upload_apk
        run: |
          BASE_URL="${CALLBACK_URL%/api/builds/callback}"
          APK="${{ steps.find_apk.outputs.APK_PATH }}"
          RESP=$(curl -fSL -X POST "$BASE_URL/api/builds/$BUILD_ID/upload-apk" \
             -H "Content-Type: application/octet-stream" \
             --data-binary @"build/$APK")
          echo "$RESP"

      # 8️⃣ Success callback
      - name: Callback – complete
        if: success()
        run: |
          curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"id\":\"$BUILD_ID\",\"status\":\"success\",\"progress\":{\"percent\":100,\"stepLabel\":\"Build Complete\"}}"

      # ❌ Error callback
      - name: Callback – error
        if: failure()
        run: |
          curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: application/json" \
          -d "{\"id\":\"$BUILD_ID\",\"status\":\"error\",\"message\":\"Build failed – see GitHub logs\"}"
