# .github/workflows/novabridge-android-v15-7.yml

name: NovaBridge Android Cloud Build v15.7 (Stable)

on:
  repository_dispatch:
    types: [novabridge_android_build_v15_7]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      # Worker callback
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      APP_NAME: ${{ github.event.client_payload.app_name }}
      PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
      PROJECT_URL: ${{ github.event.client_payload.project_url }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üß™ Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      # ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è  PUT YOUR EXISTING ANDROID BUILD LOGIC HERE  ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
      #
      # This block should:
      #   - prepare the Android project
      #   - run Gradle (assembleRelease / bundleRelease)
      #   - (optionally) upload APK to somewhere (R2, GitHub artifact, etc.)
      #
      # IMPORTANT:
      #   - On failure, we must still POST to CALLBACK_URL with status=error
      #   - On success, POST with status=success + optional artifact_url

      - name: üèó Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: ‚òï Install Gradle (if needed)
        uses: gradle/actions/setup-gradle@v4

      - name: üì¶ Prepare Android project (CUSTOMISE THIS)
        run: |
          set -e
          mkdir -p build
          # üîß TODO: replace this with your real generator
          # e.g. node scripts/generate-android-from-base44.mjs "$PROJECT_URL" "$APP_NAME" "$PACKAGE_NAME"
          echo "// TODO: generate Android project here" > build/README.txt

      - name: üèó Run Gradle build (CUSTOMISE PATH)
        working-directory: build
        run: |
          set -e
          echo "Pretend to run Gradle here..."
          # üîß Replace this with your actual Android build:
          # ./gradlew assembleRelease --warning-mode all
          #
          # For now we'll just simulate success:
          echo "Simulated build OK"

      # ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è  END OF YOUR BUILD LOGIC  ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è

      - name: ‚úÖ Notify Worker (success)
        if: success()
        run: |
          echo "Notifying Worker: success"
          ARTIFACT_URL=""  # üîß set to your real APK URL if you have one
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "success" \
              --arg msg "GitHub Actions build completed successfully" \
              --arg art "$ARTIFACT_URL" \
              '{build_id: $id, status: $status, message: $msg, artifact_url: ($art | select(. != ""))}')"

      - name: ‚ùå Notify Worker (failure)
        if: failure()
        run: |
          echo "Notifying Worker: failure"
          MSG="GitHub Actions build failed ‚Äì check workflow logs"
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "error" \
              --arg msg "$MSG" \
              '{build_id: $id, status: $status, message: $msg, artifact_url: null}')"
