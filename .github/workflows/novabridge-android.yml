name: NovaBridge Android Build v17.0

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Show payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: gradle/actions/setup-gradle@v4

      - name: Download native ZIP
        run: |
          mkdir -p build
          curl -L "$ZIP_URL" -o project.zip
          unzip -q project.zip -d build/project
          ls -R build/project

      - name: Build APK
        working-directory: build/project
        run: |
          if [ -x "./gradlew" ]; then
            ./gradlew assembleRelease || ./gradlew assembleDebug
          else
            gradle assembleRelease || gradle assembleDebug
          fi

      - name: Find APK
        id: apk
        working-directory: build/project
        run: |
          APK=$(find . -name "*.apk" | head -n 1)
          if [ -z "$APK" ]; then
            echo "NO APK!"
            exit 1
          fi
          echo "path=$APK" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: apk-${{ env.BUILD_ID }}
          path: build/project/${{ steps.apk.outputs.path }}

      - name: Callback → Worker (success)
        if: success() && env.CALLBACK_URL != ''
        run: |
          URL="github-artifact://apk-${BUILD_ID}/${{ steps.apk.outputs.path }}"
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifact_url\":\"$URL\"}"

      - name: Callback → Worker (failure)
        if: failure() && env.CALLBACK_URL != ''
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"error\",\"message\":\"GitHub build failed\"}"
