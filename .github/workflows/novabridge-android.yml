name: NovaBridge Android Build v16.6

on:
  repository_dispatch:
    types: [novabridge_android_build_v16_6]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      R2_BUCKET: novabridge-builds
      R2_URL: https://<your-account>.r2.cloudflarestorage.com/novabridge-builds

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üì• Download ZIP from Worker
        run: |
          curl -L "$ZIP_URL" -o project.zip

      - name: üì¶ Extract ZIP
        run: |
          mkdir build
          unzip project.zip -d build/project || true

      - name: üèó Inject modern Android template
        run: |
          cat > build/project/settings.gradle << 'EOF'
rootProject.name = "NovaBridgeAndroid"
include(":app")
EOF

          cat > build/project/build.gradle << 'EOF'
plugins {
    id("com.android.application") version "8.2.2" apply false
    id("org.jetbrains.kotlin.android") version "1.9.22" apply false
}
EOF

          mkdir -p build/project/app
          cat > build/project/app/build.gradle << 'EOF'
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
}

android {
    namespace = "com.example.app"
    compileSdk = 34

    defaultConfig {
        applicationId = "com.example.app"
        minSdk = 24
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
        debug {
            isMinifyEnabled = false
        }
    }

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }
    kotlinOptions {
        jvmTarget = "17"
    }
}

dependencies {
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("com.google.android.material:material:1.9.0")
    implementation("androidx.activity:activity-ktx:1.8.2")
    implementation("androidx.constraintlayout:constraintlayout:2.1.4")
}
EOF

      - name: ‚öô Install JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: üì¶ Generate Gradle Wrapper
        working-directory: build/project
        run: |
          gradle wrapper --gradle-version 8.7

      - name: üõ† Build APK
        working-directory: build/project
        run: |
          ./gradlew assembleRelease --warning-mode all

      - name: üîç Locate APK
        id: apk
        run: |
          APK=$(find build/project/app/build/outputs/apk/release -name "*.apk" | head -n 1)
          echo "apk_path=$APK" >> $GITHUB_OUTPUT

      - name: ‚òÅ Upload APK to R2
        run: |
          curl -X PUT \
            -H "Content-Type: application/vnd.android.package-archive" \
            --data-binary @"${{ steps.apk.outputs.apk_path }}" \
            "$R2_URL/${BUILD_ID}.apk"

      - name: üì° Notify Worker callback
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\": \"$BUILD_ID\", \"status\": \"success\", \"artifact_url\": \"$R2_URL/${BUILD_ID}.apk\"}"
