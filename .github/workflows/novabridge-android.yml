# .github/workflows/novabridge-android-v16.yml

name: NovaBridge Android Cloud Build v16 (Stable)

on:
  repository_dispatch:
    # üîî Must match event_type sent by the Worker (dispatchGithubBuild)
    # e.g. event_type: "novabridge_android_build_v16"
    types: [novabridge_android_build_v16]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      # üëá These match the Worker JSON payload (camelCase)
      CALLBACK_URL: ${{ github.event.client_payload.callbackUrl }}
      BUILD_ID:     ${{ github.event.client_payload.buildId }}
      APP_NAME:     ${{ github.event.client_payload.appName }}
      PACKAGE_NAME: ${{ github.event.client_payload.packageName }}
      PROJECT_URL:  ${{ github.event.client_payload.projectUrl }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üß™ Show payload (debug)
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"

      - name: üß∞ Ensure jq is installed
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: üèó Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: ‚òï Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # ------------------------------------------------------------------
      # üîß PUT YOUR REAL ANDROID BUILD LOGIC HERE
      # ------------------------------------------------------------------

      - name: üì¶ Prepare Android project (CUSTOMISE THIS)
        run: |
          set -e
          mkdir -p build
          # TODO: replace this with your real generator:
          # node scripts/generate-android-from-base44.mjs \
          #   "$PROJECT_URL" "$APP_NAME" "$PACKAGE_NAME"
          echo "// TODO: generate Android project here" > build/README.txt
          echo "Prepared dummy Android project in ./build"

      - name: üèó Run Gradle build (CUSTOMISE PATH)
        working-directory: build
        run: |
          set -e
          echo "Pretend to run Gradle here..."
          # Example (when real project exists):
          #   ./gradlew assembleRelease --warning-mode all
          #
          # For now we simulate success:
          echo "Simulated Gradle build OK"

      # ------------------------------------------------------------------
      # ‚úÖ CALLBACKS TO WORKER
      # ------------------------------------------------------------------

      - name: ‚úÖ Notify Worker (success)
        if: success()
        run: |
          echo "Success path: CALLBACK_URL='$CALLBACK_URL'"
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL provided, skipping success callback."
            exit 0
          fi

          ARTIFACT_URL=""  # üîß set to real APK URL when you have one

          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "success" \
              --arg msg "GitHub Actions build completed successfully" \
              --arg art "$ARTIFACT_URL" \
              '{
                build_id: $id,
                status: $status,
                message: $msg,
                artifact_url: ($art | select(. != ""))
              }')"

      - name: ‚ùå Notify Worker (failure)
        if: failure()
        run: |
          echo "Failure path: CALLBACK_URL='$CALLBACK_URL'"
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL provided, skipping failure callback."
            exit 0
          fi

          MSG="GitHub Actions build failed ‚Äì check workflow logs"

          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "error" \
              --arg msg "$MSG" \
              '{
                build_id: $id,
                status: $status,
                message: $msg,
                artifact_url: null
              }')"
