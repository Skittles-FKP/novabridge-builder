name: NovaBridge Android Cloud Build v16.6

on:
  repository_dispatch:
    types: [novabridge_android_build_v16_6]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      APP_NAME: ${{ github.event.client_payload.app_name }}
      PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
      PROJECT_URL: ${{ github.event.client_payload.project_url }}

    steps:

      # ---------------------------------------------------------
      # 1. Debug incoming payload
      # ---------------------------------------------------------
      - name: üß™ Show Payload
        run: |
          echo "BUILD_ID=$BUILD_ID"
          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          echo "APP_NAME=$APP_NAME"
          echo "PACKAGE_NAME=$PACKAGE_NAME"
          echo "PROJECT_URL=$PROJECT_URL"

      # ---------------------------------------------------------
      # 2. Setup Java for Gradle
      # ---------------------------------------------------------
      - name: ‚òï Setup Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ---------------------------------------------------------
      # 3. Setup Gradle caching + performance
      # ---------------------------------------------------------
      - name: ‚öôÔ∏è Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # ---------------------------------------------------------
      # 4. Download ZIP produced by Worker /build
      # ---------------------------------------------------------
      - name: üì• Download Native Project ZIP
        run: |
          echo "Downloading project ZIP from: $ZIP_URL"
          curl -L --fail "$ZIP_URL" -o project.zip

      # ---------------------------------------------------------
      # 5. Extract ZIP into /project
      # ---------------------------------------------------------
      - name: üì¶ Extract ZIP
        run: |
          mkdir project
          unzip project.zip -d project || (echo "‚ùå ZIP extraction failed!" && exit 1)
          ls -la project

      # ---------------------------------------------------------
      # 6. Determine Gradle wrapper
      # ---------------------------------------------------------
      - name: üß≠ Select Gradle Runner
        id: gradlepath
        run: |
          cd project

          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            echo "gradle_runner=./gradlew" >> $GITHUB_OUTPUT
          else
            echo "gradle_runner=gradle" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # 7. Build APK (release ‚Üí fallback to debug)
      # ---------------------------------------------------------
      - name: üèó Build Android APK
        run: |
          cd project

          echo "Starting Gradle build using: ${{ steps.gradlepath.outputs.gradle_runner }}"

          set -e

          ${{ steps.gradlepath.outputs.gradle_runner }} assembleRelease --stacktrace --warning-mode all \
            || ${{ steps.gradlepath.outputs.gradle_runner }} assembleDebug --stacktrace --warning-mode all

      # ---------------------------------------------------------
      # 8. Find final APK (supports release and debug variants)
      # ---------------------------------------------------------
      - name: üîç Locate APK Artifact
        id: findapk
        run: |
          cd project

          RELEASE_APK=$(find . -name "*release*.apk" | head -n 1)
          DEBUG_APK=$(find . -name "*debug*.apk" | head -n 1)

          if [ -n "$RELEASE_APK" ]; then
            echo "apk_path=$RELEASE_APK" >> $GITHUB_OUTPUT
          elif [ -n "$DEBUG_APK" ]; then
            echo "apk_path=$DEBUG_APK" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No APK produced!"
            exit 1
          fi

          echo "APK Path: ${{ steps.findapk.outputs.apk_path }}"

      # ---------------------------------------------------------
      # 9. Upload APK to Worker ‚Üí /api/builds/callback
      # ---------------------------------------------------------
      - name: ‚òÅÔ∏è Upload APK ‚Üí Worker
        run: |
          echo "Uploading APK to Worker callback endpoint‚Ä¶"

          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            --data "{
              \"build_id\": \"$BUILD_ID\",
              \"status\": \"success\",
              \"message\": \"APK build completed\",
              \"artifact_url\": \"https://novabridge-build-worker.novabridge.workers.dev/apk/$BUILD_ID\"
            }"

      # ---------------------------------------------------------
      # 10. Upload actual APK to R2 (Worker API)
      # ---------------------------------------------------------
      - name: üì§ Upload APK to Worker /apk/:id
        run: |
          echo "Sending binary APK upload‚Ä¶"

          curl -X PUT \
            -H "Content-Type: application/vnd.android.package-archive" \
            --data-binary @"project/${{ steps.findapk.outputs.apk_path }}" \
            "https://novabridge-build-worker.novabridge.workers.dev/apk/$BUILD_ID"

      # ---------------------------------------------------------
      # 11. Failure callback if something breaks
      # ---------------------------------------------------------
      - name: ‚ùå Failure Handler
        if: failure()
        run: |
          echo "Sending failure callback to Worker‚Ä¶"

          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            --data "{
              \"build_id\": \"$BUILD_ID\",
              \"status\": \"error\",
              \"message\": \"Build failed (GitHub workflow error)\"
            }"
