name: NovaBridge Cloud Android Build

on:
  repository_dispatch:
    types: [novabridge_android_build]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # 2. Download ZIP generated by Worker
      # -----------------------------
      - name: Download project ZIP
        run: |
          echo "Downloading ZIP from Worker..."
          curl -L "$ZIP_URL" -o project.zip
        env:
          ZIP_URL: ${{ github.event.client_payload.zipUrl }}

      # -----------------------------
      # 3. Extract ZIP to build/
      # -----------------------------
      - name: Extract ZIP
        run: |
          mkdir -p build
          unzip project.zip -d build
          echo "ZIP extracted to build/"
          ls -R build

      # -----------------------------
      # 4. Validate ZIP contents
      # -----------------------------
      - name: Validate Gradle root
        run: |
          echo "Checking for Gradle files..."
          if [ ! -f build/settings.gradle ]; then
            echo "‚ùå settings.gradle missing"
            exit 1
          fi
          if [ ! -f build/build.gradle ]; then
            echo "‚ùå build.gradle missing"
            exit 1
          fi
          echo "‚úî Gradle project structure is valid"

      # -----------------------------
      # 5. Set up Java (AGP 8.x requires Java 17)
      # -----------------------------
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # -----------------------------
      # 6. Grant execution permission (not needed with system Gradle)
      # -----------------------------
      - name: Install Gradle
        uses: gradle/actions/setup-gradle@v3

      # -----------------------------
      # 7. Build APK/AAB using system Gradle
      # -----------------------------
      - name: Build Android Release APK
        working-directory: build
        run: |
          echo "üèó Running Gradle build with system Gradle..."
          gradle assembleRelease --stacktrace

      # -----------------------------
      # 8. Verify APK output exists
      # -----------------------------
      - name: Find built APK
        run: |
          echo "Looking for APK..."
          find build -name "*.apk" -type f

      # -----------------------------
      # 9. Upload APK to Cloudflare R2
      # -----------------------------
      - name: Upload APK to Cloudflare R2
        run: |
          APK_PATH=$(find build -name "*release*.apk" -type f | head -n 1)

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå No APK found after build"
            exit 1
          fi

          echo "Found APK at: $APK_PATH"
          echo "Uploading to R2..."

          aws s3 cp "$APK_PATH" \
            "s3://${{ secrets.R2_BUCKET }}/artifacts/${{ github.event.client_payload.buildId }}/app-release.apk" \
            --endpoint-url ${{ secrets.R2_ENDPOINT }}

        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}

      # -----------------------------
      # 10. Send callback to Cloudflare Worker
      # -----------------------------
      - name: Notify Worker (callback)
        run: |
          echo "Sending callback to Worker..."

          CALLBACK_URL="${{ github.event.client_payload.callbackUrl }}"
          ARTIFACT_URL="https://${{ secrets.R2_PUBLIC_BASE }}/artifacts/${{ github.event.client_payload.buildId }}/app-release.apk"

          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{
                  \"buildId\": \"${{ github.event.client_payload.buildId }}\",
                  \"status\": \"success\",
                  \"artifactUrl\": \"$ARTIFACT_URL\"
                }"

          echo "Callback sent successfully."

