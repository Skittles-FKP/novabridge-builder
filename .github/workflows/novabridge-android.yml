name: novabridge cloud build (android)

on:
  repository_dispatch:
    types: [novabridge_android_build]
  workflow_dispatch:
    inputs:
      zip_url:
        description: "Source ZIP URL (NovaBridge worker download)"
        required: true
      callback_url:
        description: "Callback URL (NovaBridge worker /api/builds/callback)"
        required: true
      build_id:
        description: "NovaBridge build ID"
        required: true

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Java for Android build
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3) Set up **Gradle 8.7** (compatible with AGP 8.2)
      - name: Set up Gradle 8.7 (non-wrapper project)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.7"

      # 4) Determine ZIP_URL, CALLBACK_URL, BUILD_ID from event
      - name: Prepare build environment variables
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ZIP_URL=${{ github.event.client_payload.zipUrl }}" >> $GITHUB_ENV
            echo "CALLBACK_URL=${{ github.event.client_payload.callbackUrl }}" >> $GITHUB_ENV
            echo "BUILD_ID=${{ github.event.client_payload.buildId }}" >> $GITHUB_ENV
          else
            echo "ZIP_URL=${{ github.event.inputs.zip_url }}" >> $GITHUB_ENV
            echo "CALLBACK_URL=${{ github.event.inputs.callback_url }}" >> $GITHUB_ENV
            echo "BUILD_ID=${{ github.event.inputs.build_id }}" >> $GITHUB_ENV
          fi

          echo "ZIP_URL=$ZIP_URL"
          echo "CALLBACK_URL=$CALLBACK_URL"
          echo "BUILD_ID=$BUILD_ID"

      # 5) Download + unzip NovaBridge-generated Android project
      - name: Download project ZIP from NovaBridge Worker
        env:
          ZIP_URL: ${{ env.ZIP_URL }}
        run: |
          mkdir -p build
          cd build

          echo "Downloading project from: $ZIP_URL"
          curl -L "$ZIP_URL" -o source.zip

          echo "Unzipping into build/project ..."
          mkdir -p project
          unzip -q source.zip -d project

          echo "Contents of build/project:"
          cd project
          ls -R

      # 6) Run Gradle assembleRelease inside the unzipped project
      - name: Run Gradle assembleRelease (using Gradle 8.7)
        working-directory: build/project
        run: |
          echo "ðŸ— Running Gradle assembleRelease..."
          gradle --version
          gradle assembleRelease

      # 7) Locate the built APK
      - name: Locate release APK
        id: locate-apk
        working-directory: build/project
        run: |
          APK_PATH=$(find app/build/outputs/apk -name "*release*.apk" | head -n 1 || true)

          if [ -z "$APK_PATH" ]; then
            echo "âŒ No APK found under app/build/outputs/apk" >&2
            find app -maxdepth 6 -type f -name "*.apk" || true
            exit 1
          fi

          echo "Found APK at: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

      # 8) Upload APK to Cloudflare R2 (S3-compatible)
      - name: Upload APK to Cloudflare R2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: novabridge-builds
          R2_ACCOUNT_ID: cf73b96d9ea070a2b23419c8e549ea58
          BUILD_ID: ${{ env.BUILD_ID }}
        run: |
          pip install --user awscli

          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
          export AWS_DEFAULT_REGION="auto"

          ENDPOINT="https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com"
          APK_KEY="artifacts/$BUILD_ID/app-release.apk"

          echo "Uploading APK to s3://$R2_BUCKET/$APK_KEY via $ENDPOINT"

          aws s3 cp "build/project/${{ steps.locate-apk.outputs.apk_path }}" \
            "s3://$R2_BUCKET/$APK_KEY" \
            --endpoint-url "$ENDPOINT" \
            --acl private

          ARTIFACT_URL="$ENDPOINT/$R2_BUCKET/$APK_KEY"
          echo "ARTIFACT_URL=$ARTIFACT_URL" >> $GITHUB_ENV
          echo "Uploaded APK URL: $ARTIFACT_URL"

      # 9) Callback to NovaBridge Worker with status + artifact URL
      - name: Send callback to NovaBridge Worker
        if: always()
        env:
          CALLBACK_URL: ${{ env.CALLBACK_URL }}
          BUILD_ID: ${{ env.BUILD_ID }}
          ARTIFACT_URL: ${{ env.ARTIFACT_URL }}
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "No CALLBACK_URL set, skipping callback."
            exit 0
          fi

          STATUS="failure"
          MESSAGE="Build failed"
          if [ "${{ job.status }}" = "success" ]; then
            STATUS="success"
            MESSAGE="Build completed successfully"
          fi

          echo "Calling callback: $CALLBACK_URL"
          echo "Status: $STATUS"
          echo "Artifact: $ARTIFACT_URL"

          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"buildId\": \"$BUILD_ID\",
              \"status\": \"$STATUS\",
              \"artifactUrl\": \"$ARTIFACT_URL\",
              \"message\": \"$MESSAGE\"
            }"
