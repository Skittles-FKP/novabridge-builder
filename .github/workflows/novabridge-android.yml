name: NovaBridge iOS Build

on:
  repository_dispatch:
    types: [novabridge_ios_build]

jobs:
  ios-build:
    runs-on: macos-14

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      CALLBACK_TOKEN: ${{ secrets.CALLBACK_TOKEN }}

    steps:
      # ------------------------------------------------------------
      # 0Ô∏è‚É£ Sanity checks
      # ------------------------------------------------------------
      - name: üîç Validate inputs
        run: |
          set -e
          echo "‚û° BUILD_ID=$BUILD_ID"
          echo "‚û° ZIP_URL=$ZIP_URL"
          echo "‚û° CALLBACK_URL=$CALLBACK_URL"

          if [ -z "$BUILD_ID" ]; then echo "‚ùå BUILD_ID missing"; exit 1; fi
          if [ -z "$ZIP_URL" ]; then echo "‚ùå ZIP_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_URL" ]; then echo "‚ùå CALLBACK_URL missing"; exit 1; fi
          if [ -z "$CALLBACK_TOKEN" ]; then echo "‚ùå CALLBACK_TOKEN missing"; exit 1; fi

      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Notify: Downloading project
      # ------------------------------------------------------------
      - name: üì• Step 3 ‚Äì Downloading project
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":3,\"step_state\":\"active\",\"log\":\"iOS: üì• Downloading iOS project files\"}"

      - name: üì¶ Download iOS ZIP
        run: |
          set -e
          curl -L "$ZIP_URL" -o ios.zip
          unzip -q ios.zip

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Generate Xcode project
      # ------------------------------------------------------------
      - name: üß© Step 4 ‚Äì Generating Xcode project
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":4,\"step_state\":\"active\",\"log\":\"iOS: üß© Generating Xcode project\"}"

      - name: üõ† Generate Xcode project via XcodeGen
        run: |
          set -e
          brew install xcodegen
          cd ios/NovaBridgeDemo-iOS
          xcodegen generate

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Queue + build
      # ------------------------------------------------------------
      - name: üçè Step 5 ‚Äì Queued on macOS runner
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":5,\"step_state\":\"active\",\"log\":\"iOS: üçè Queued on macOS runner\"}"

      - name: üîç Detect scheme
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          PROJECT=$(ls *.xcodeproj | head -n 1)
          echo "üìÅ Using project: $PROJECT"

          SCHEME=$(xcodebuild -list -project "$PROJECT" \
            | awk '/Schemes:/ {getline; print $1}')

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found"
            exit 1
          fi

          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      - name: üî® Step 6 ‚Äì Building with Xcode
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":6,\"step_state\":\"active\",\"log\":\"iOS: üî® Building with Xcode\"}"

      - name: üèó Build iOS App
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS

          xcodebuild \
            -project *.xcodeproj \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Package artifact
      # ------------------------------------------------------------
      - name: üì¶ Step 7 ‚Äì Packaging iOS build
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"step\":7,\"step_state\":\"active\",\"log\":\"iOS: üì¶ Packaging iOS build\"}"

      - name: üóú Zip build output
        run: |
          set -e
          cd ios/NovaBridgeDemo-iOS
          zip -r ios-build.zip build

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Upload artifact
      # ------------------------------------------------------------
      - name: ‚òÅÔ∏è Upload artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ env.BUILD_ID }}
          path: ios/NovaBridgeDemo-iOS/ios-build.zip

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Final callback
      # ------------------------------------------------------------
      - name: ‚úÖ Step 8 ‚Äì Complete
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifact_key\":\"ios/artifacts/$BUILD_ID.zip\",\"log\":\"iOS: ‚úÖ Build complete\"}"

      # ------------------------------------------------------------
      # 7Ô∏è‚É£ Failure handler
      # ------------------------------------------------------------
      - name: ‚ùå Failure callback
        if: failure()
        run: |
          curl -s -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-novabridge-token: $CALLBACK_TOKEN" \
            -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\",\"error\":\"iOS build failed\"}"
