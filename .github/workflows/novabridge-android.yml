name: NovaBridge Android Cloud Build v16.9

on:
  workflow_dispatch:
  repository_dispatch:
    types: [novabridge_android_build_v16_9]

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      BUILD_ID: ${{ github.event.client_payload.build_id }}
      ZIP_URL: ${{ github.event.client_payload.zip_url }}
      CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üß™ Print incoming payload
        run: |
          echo "BUILD_ID=${BUILD_ID}"
          echo "ZIP_URL=${ZIP_URL}"
          echo "CALLBACK_URL=${CALLBACK_URL}"

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üß± Setup Gradle 8.2.1
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.2.1"

      - name: üì• Download ZIP & extract native project
        run: |
          set -e
          echo "‚û°Ô∏è Downloading native ZIP: $ZIP_URL"
          curl -L "$ZIP_URL" -o native.zip

          mkdir -p build
          unzip -q native.zip -d build
          ls -R build

      - name: üèó Build APK (Release ‚Üí Debug fallback)
        working-directory: build
        run: |
          set -e
          if [ -x "./gradlew" ]; then
            ./gradlew assembleRelease --warning-mode all || ./gradlew assembleDebug --warning-mode all
          else
            gradle assembleRelease --warning-mode all || gradle assembleDebug --warning-mode all
          fi

      - name: üîç Locate APK
        id: find_apk
        working-directory: build
        run: |
          set -e
          APK_PATH=$(find app/build/outputs/apk -type f \
            \( -name "*release*.apk" -o -name "*debug*.apk" \) | head -n 1 || true)

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå No APK found!"
            exit 1
          fi

          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "‚úî Found APK: $APK_PATH"

      - name: ‚òÅÔ∏è Upload APK to R2 (PUBLIC URL FIXED)
        id: upload_r2
        run: |
          set -e

          APK="build/${{ steps.find_apk.outputs.apk_path }}"
          DEST_PATH="apks/${BUILD_ID}.apk"

          echo "Uploading APK ‚Üí R2"
          AWS_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}" \
          AWS_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}" \
          aws s3 cp "$APK" "s3://${R2_BUCKET}/${DEST_PATH}" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --region auto

          PUBLIC_URL="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com/${R2_BUCKET}/${DEST_PATH}"

          echo "public_r2_url=$PUBLIC_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ PUBLIC APK URL: $PUBLIC_URL"

      - name: ‚úÖ Notify Worker ‚Äî success
        if: success() && env.CALLBACK_URL != ''
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "success" \
              --arg url "${{ steps.upload_r2.outputs.public_r2_url }}" \
              --arg msg "Android build completed successfully" \
              '{build_id:$id, status:$status, artifact_url:$url, public_r2_url:$url, message:$msg}')"

      - name: ‚ùå Notify Worker ‚Äî failure
        if: failure() && env.CALLBACK_URL != ''
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$BUILD_ID" \
              --arg status "error" \
              --arg msg "Android build failed ‚Äì check logs" \
              '{build_id:$id, status:$status, artifact_url:null, message:$msg}')"
